<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FABRIKA | Yönetim Paneli v5.9 (Net-Brüt Hesaplama + Vardiya İyileştirmeleri)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS KODLARI BAŞLANGIÇ */

        :root {
            --primary-color: #3498db;
            --secondary-color: #f1c40f;
            --background-color: #ecf0f1;
            --surface-color: #ffffff;
            --text-color: #34495e;
            --dark-color: #2c3e50;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --info-color: #8e44ad;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .auth-container { background-color: var(--surface-color); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; transition: opacity 0.5s, transform 0.5s; display: none; }
        .auth-container h1 { color: var(--dark-color); margin-bottom: 10px; }
        .auth-container p { margin-bottom: 25px; color: #7f8c8d; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px 15px; border: 1px solid #bdc3c7; border-radius: var(--border-radius); font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; background-color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; resize: vertical; min-height: 50px; }
        .input-group input, .input-group select { min-height: 0; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        .input-group input:disabled { background-color: #f8f9fa; color: #7f8c8d; font-weight: 700; }
        .auth-message { color: var(--danger-color); margin-bottom: 15px; height: 18px; font-size: 14px; font-weight: 500; }

        .btn { padding: 12px 20px; border: none; border-radius: var(--border-radius); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #bdc3c7; color: var(--dark-color); }
        .btn-warning { background-color: var(--secondary-color); color: var(--dark-color); }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-full { width: 100%; padding: 15px; }
        .btn-sm-danger { background-color: var(--danger-color); color: white; padding: 5px 10px; font-size: 12px; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; }
        .btn-sm-warning { background-color: var(--secondary-color); color: var(--dark-color); padding: 5px 10px; font-size: 12px; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; }
        .btn-sm-success { background-color: var(--success-color); color: white; padding: 5px 10px; font-size: 12px; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; }

        #app-container { display: none; width: 100%; height: 100vh; display: flex; background-color: var(--background-color); }
        #sidebar { width: 260px; background-color: var(--dark-color); color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #sidebar .logo { text-align: center; margin-bottom: 40px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        #sidebar .logo span { color: var(--primary-color); font-weight: 400; }
        #sidebar nav { flex-grow: 1; }
        #sidebar nav ul { list-style: none; }
        #sidebar nav li { margin-bottom: 10px; }
        #sidebar nav a { color: #bdc3c7; text-decoration: none; display: flex; align-items: center; padding: 15px; border-radius: var(--border-radius); transition: background-color 0.3s, color 0.3s; font-weight: 500;}
        #sidebar nav a.active, #sidebar nav a:hover { background-color: var(--primary-color); color: white; }
        #sidebar nav a svg { margin-right: 15px; width: 20px; height: 20px; }
        #sidebar-vardiya-durumu { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: var(--border-radius); text-align: center; font-size: 14px; margin-top: 20px; }
        #sidebar-vardiya-durumu .durum { font-weight: 700; display: block; margin-bottom: 5px; }
        #sidebar-vardiya-durumu .durum-kapali { color: var(--danger-color); }
        #sidebar-vardiya-durumu .durum-acik { color: var(--success-color); }
        #sidebar-vardiya-durumu .isim { font-size: 13px; color: #bdc3c7; }
        #logout-btn { margin-top: 20px; }

        #main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        #main-content header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #dce1e2; padding-bottom: 20px; }
        #main-content header h1 { font-size: 32px; color: var(--dark-color); font-weight: 700; }
        #main-content header #kullanici-bilgisi { font-size: 16px; color: var(--text-color); font-weight: 500; }
        #main-content header #kullanici-bilgisi span { font-weight: 700; color: var(--dark-color); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .card { background-color: var(--surface-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .card h3 { font-size: 16px; color: #7f8c8d; margin-bottom: 10px; font-weight: 600; }
        .card .value { font-size: 32px; font-weight: 700; color: var(--dark-color); }
        .card .value.profit { color: var(--success-color); }
        .card .value.loss { color: var(--danger-color); }
        .content-box { background-color: var(--surface-color); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 30px; }
        .content-box h2 { margin-bottom: 25px; color: var(--dark-color); font-size: 22px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; display: inline-block;}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; }
        .full-width { grid-column: 1 / -1; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th:last-child, td:last-child { text-align: center; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--dark-color); text-transform: uppercase; font-size: 12px; }
        tr:hover { background-color: #f8f9fa; }
        td .btn { padding: 8px 12px; font-size: 13px; font-weight: 500; }
        td .btn-sm-warning, td .btn-sm-success { margin-right: 5px; }
        .danger-zone { border-left: 5px solid var(--danger-color); background-color: #fff8f8; }
        .danger-zone h2 { color: var(--danger-color); border-bottom-color: var(--danger-color); }
        .danger-zone p { margin-bottom: 20px; font-size: 15px; line-height: 1.6; }
        #kayit-listesi-tablosu th, #kayit-listesi-tablosu td { padding: 12px 15px; }
        #kayit-listesi-tablosu td:last-child { text-align: center; }
        #kayit-listesi-genel-toplam { font-size: 18px; font-weight: 700; text-align: right; margin-top: 20px; color: var(--dark-color); }
        #modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s; }
        #modal-container.show { display: flex; }
        .modal-content { background-color: var(--surface-color); padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 500px; animation: slideIn 0.4s ease-out; }
        .modal-content.modal-lg { max-width: 800px; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: var(--dark-color); }
        .modal-close-btn { font-size: 24px; font-weight: bold; color: #95a5a6; cursor: pointer; border: none; background: none; transition: transform 0.2s; }
        .modal-close-btn:hover { transform: rotate(90deg); }
        .text-center { text-align: center; }
        .no-data-message { color: #7f8c8d; font-style: italic; padding: 40px; text-align: center; }
        .sgk-badge { background-color: var(--info-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        #aktif-vardiya-container { border-left: 5px solid var(--success-color); background-color: #f7fffb; padding: 30px; }
        #aktif-vardiya-container h2 { color: var(--success-color); border-bottom-color: var(--success-color); }
        #aktif-vardiya-detaylari { font-size: 18px; color: var(--text-color); line-height: 1.7; margin-bottom: 25px; }
        #aktif-vardiya-detaylari strong { color: var(--dark-color); font-weight: 600; }
        #vardiya-gecmisi-container table td:first-child { word-break: break-word; max-width: 500px; min-width: 300px; }
        .checkbox-container { display: flex; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dce1e2; margin-bottom: 15px; }
        .checkbox-container input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; min-height: auto; }
        .checkbox-container label { margin-bottom: 0; cursor: pointer; font-weight: 500; }

        /* Yeni: Katılım tablosu için basit stiller */
        .attendance-table { border-collapse: collapse; width: 100%; overflow-x: auto; display: block; }
        .attendance-table th, .attendance-table td { border: 1px solid #ddd; padding: 8px; font-size: 12px; text-align: center; }
        .attendance-table th { background-color: #f8f9fa; white-space: nowrap; position: sticky; top: 0; z-index: 1; }
        .attendance-present { color: var(--success-color); font-weight: bold; }
        .attendance-absent { color: var(--danger-color); font-weight: bold; }
        /* Haftalık/planlı izinler için turuncu renk */
        .attendance-weekly { color: var(--secondary-color); font-weight: bold; }


        /* Özet için basit stil */
        .attendance-summary {
            margin-top: 20px;
        }
        .attendance-summary h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--dark-color);
        }
        .attendance-summary ul {
            list-style: none;
            padding-left: 0;
            font-size: 14px;
            color: var(--text-color);
        }
        .attendance-summary li {
            margin-bottom: 5px;
        }
        
        /*
         * Mobil uyumluluk (responsive) stilleri
         * Varsayılan olarak mobil menü butonu gizli; 768px altında görünür ve sidebar içeri kayar.
         */
        #sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1100;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
        }
        #sidebar-toggle svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Küçük ekranlar için düzenlemeler */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                align-items: flex-start;
                justify-content: flex-start;
            }
            #app-container {
                flex-direction: column;
                width: 100%;
                height: auto;
            }
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 260px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            /* Sidebar aktif olduğunda görünür */
            #sidebar.active {
                transform: translateX(0);
            }
            #sidebar-toggle {
                display: flex;
            }
            #main-content {
                padding: 20px;
                width: 100%;
                margin-left: 0;
            }
            .card-container {
                grid-template-columns: 1fr;
            }
            /* Tabloları kaydırılabilir hale getir */
            table {
                display: block;
                overflow-x: auto;
                width: 100%;
            }
            th, td {
                white-space: nowrap;
            }
            /* Kimlik doğrulama konteynerlerini esnetmek */
            .auth-container {
                max-width: 90%;
                margin: 0 auto;
            }
        }

        /* SAAS (Çoklu Şirket) Arayüz Stilleri */
        .saas-container {
            max-width: 900px;
            margin: 0 auto;
            display: none; /* Varsayılan gizli, JS ile açılacak */
            animation: fadeIn 0.5s;
        }
        .saas-card {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        .saas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        .saas-option {
            background: #f8f9fa;
            padding: 30px;
            border-radius: var(--border-radius);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        .saas-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .saas-option h3 { color: var(--dark-color); margin-bottom: 10px; }
        .saas-option p { color: #7f8c8d; font-size: 14px; }
        .saas-icon { width: 50px; height: 50px; margin-bottom: 20px; fill: var(--primary-color); }
        
        /* Süper Admin Tablosu */
        .admin-table-container { overflow-x: auto; margin-top: 20px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-Pending { background: #ffeeba; color: #856404; }
        .status-Active { background: #d4edda; color: #155724; }
        .status-Suspended { background: #f8d7da; color: #721c24; }

        .btn-sm-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Mobil cihazlarda yan menüyü açıp kapatmak için buton -->
    <button id="sidebar-toggle" aria-label="Menüyü Aç/Kapat">
        <!-- Hamburger ikon -->
        <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"/></svg>
    </button>

    <div id="saas-landing" class="saas-container" style="display: block;"> <div class="saas-card">
            <h1>Fabrika Yönetim Paneli</h1>
            <p style="font-size: 18px; color: #7f8c8d; margin-bottom: 40px;">İşletmenizi yönetmek için lütfen giriş yapın veya kayıt olun.</p>
            
            <div class="saas-grid">
                <div class="saas-option" onclick="saas.showLogin()">
                    <svg class="saas-icon" viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                    <h3>Şirket Girişi</h3>
                    <p>Mevcut hesabınızla işletme panelinize erişin.</p>
                </div>

                <div class="saas-option" onclick="saas.showRegister()">
                    <svg class="saas-icon" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <h3>Yeni İşletme Kaydı</h3>
                    <p>Yeni bir hesap oluşturun ve abonelik başlatın.</p>
                </div>

                <div class="saas-option" onclick="saas.showAdminLogin()">
                    <svg class="saas-icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                    <h3>Sistem Yöneticisi</h3>
                    <p>Sadece platform sahipleri için.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="saas-register" class="auth-container">
        <h1>İşletme Kaydı</h1>
        <p>Bilgilerinizi girerek kayıt talebi oluşturun.</p>
        <form id="saas-register-form">
            <div class="input-group"><label>Şirket/Fabrika Adı</label><input type="text" id="reg-company-name" required></div>
            <div class="input-group"><label>E-Posta Adresi</label><input type="email" id="reg-email" required></div>
            <div class="input-group"><label>Kullanıcı Adı (Giriş İçin)</label><input type="text" id="reg-username" required></div>
            <div class="input-group"><label>Şifre</label><input type="password" id="reg-password" required></div>
            <button type="submit" class="btn btn-success btn-full">Kayıt Ol</button>
            <button type="button" class="btn btn-secondary btn-full" style="margin-top: 10px;" onclick="saas.showLanding()">Geri Dön</button>
        </form>
    </div>

    <div id="saas-login" class="auth-container">
        <h1>Şirket Girişi</h1>
        <p>İşletme kullanıcı adı ve şifrenizle giriş yapın.</p>
        <form id="saas-login-form">
            <div class="input-group"><label>Şirket Kullanıcı Adı</label><input type="text" id="login-username" required></div>
            <div class="input-group"><label>Şifre</label><input type="password" id="login-password" required></div>
            <button type="submit" class="btn btn-primary btn-full">Giriş Yap</button>
            <button type="button" class="btn btn-secondary btn-full" style="margin-top: 10px;" onclick="saas.showLanding()">Geri Dön</button>
        </form>
    </div>

    <div id="saas-admin-login" class="auth-container">
        <h1>Sistem Yöneticisi</h1>
        <p>Platform yönetimi için giriş yapın.</p>
        <form id="saas-admin-login-form">
            <div class="input-group"><label>Kullanıcı Adı</label><input type="text" id="admin-login-user" required></div>
            <div class="input-group"><label>Şifre</label><input type="password" id="admin-login-pass" required></div>
            <button type="submit" class="btn btn-danger btn-full">Panele Gir</button>
            <button type="button" class="btn btn-secondary btn-full" style="margin-top: 10px;" onclick="saas.showLanding()">Geri Dön</button>
        </form>
    </div>

   <div id="saas-admin-panel" class="saas-container">
        <div class="saas-card" style="text-align: left; max-width: 1000px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                <div>
                    <h2 style="margin:0;">Sistem Yöneticisi</h2>
                    <div style="margin-top: 10px;">
                        <button id="btn-admin-tab-companies" class="btn btn-primary" onclick="saas.switchAdminTab('companies')">Şirketler</button>
                        <button id="btn-admin-tab-payments" class="btn btn-secondary" onclick="saas.switchAdminTab('payments')">Ödeme Geçmişi</button>
                        <button id="btn-admin-tab-settings" class="btn btn-secondary" onclick="saas.switchAdminTab('settings')">Ayarlar</button>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="location.reload()">Çıkış</button>
            </div>

            <div id="admin-view-companies">
                <div class="admin-table-container">
                    <table id="saas-companies-table">
                        <thead>
                            <tr>
                                <th>Şirket</th>
                                <th>Durum</th>
                                <th>Başlangıç / Bitiş</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="admin-view-payments" style="display:none;">
                <h3>Tahsilat Raporu</h3>
                <div class="admin-table-container">
                    <table id="saas-payments-table">
                        <thead>
                            <tr>
                                <th>Şirket</th>
                                <th>Tutar</th>
                                <th>Süre</th>
                                <th>İşlem Tarihi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="admin-view-settings" style="display: none; max-width: 400px; margin: 0 auto;">
                <h3>Giriş Bilgilerini Güncelle</h3>
                <div class="input-group"><label>Yeni Kullanıcı Adı</label><input type="text" id="admin-new-username"></div>
                <div class="input-group"><label>Yeni Şifre</label><input type="password" id="admin-new-password"></div>
                <button class="btn btn-success btn-full" onclick="saas.saveAdminSettings()">Güncelle</button>
            </div>
        </div>
    </div>

    <div id="subscription-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:10px; width:400px; max-width:90%; position:relative;">
            <h2 style="margin-top:0;">Abonelik / Süre Ekle</h2>
            <p id="modal-company-name" style="color:blue; font-weight:bold;"></p>
            
            <input type="hidden" id="modal-company-id">

            <div class="input-group">
                <label>Abonelik Başlangıç Tarihi</label>
                <input type="date" id="sub-start-date" class="form-control">
            </div>

            <div class="input-group">
                <label>Süre Seçimi</label>
                <select id="sub-duration" class="form-control" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
                    <option value="1">1 Ay</option>
                    <option value="3">3 Ay</option>
                    <option value="6">6 Ay</option>
                    <option value="12">1 Yıl (12 Ay)</option>
                    <option value="24">2 Yıl (24 Ay)</option>
                </select>
            </div>

            <div class="input-group">
                <label>Ödenen Tutar (TL)</label>
                <input type="number" id="sub-amount" placeholder="Örn: 5000" style="width:100%; padding:10px;">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-success" style="flex:1;" onclick="saas.saveSubscription()">Kaydet ve Onayla</button>
                <button class="btn btn-danger" style="flex:1;" onclick="document.getElementById('subscription-modal').style.display='none'">İptal</button>
            </div>
        </div>
    </div>


    <div id="setup-container" class="auth-container">
        <h1>Yönetim Paneline Hoş Geldiniz</h1>
        <p>İlk kez kullanıyorsanız, lütfen bir yönetici kullanıcı adı ve şifresi oluşturun.</p>
        <form id="setup-form">
            <div class="input-group">
                <label for="setup-username">Yönetici Kullanıcı Adı</label>
                <input type="text" id="setup-username" required>
            </div>
            <div class="input-group">
                <label for="setup-pass">Yeni Yönetici Şifresi (En az 4 karakter)</label>
                <input type="password" id="setup-pass" required>
            </div>
            <div class="input-group">
                <label for="setup-pass-onay">Yeni Şifreyi Onayla</label>
                <input type="password" id="setup-pass-onay" required>
            </div>
            <div id="setup-error" class="auth-message"></div>
            <button type="submit" class="btn btn-primary btn-full">Yönetici Hesabını Oluştur</button>
        </form>
    </div>

    <div id="login-choice-container" class="auth-container">
        <h1>Yönetim Paneli</h1>
        <p>Lütfen giriş yapmak istediğiniz panel türünü seçin.</p>
        <button id="btn-admin-login-choice" class="btn btn-primary btn-full" style="margin-bottom: 15px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 1L9 5h6l-3-4zM6 9l-4 3 4 3V9zm12 0v6l4-3-4-3zm-9 4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM4 17.01L7 14h10l3 3.01H4z"/></svg>
            YÖNETİCİ GİRİŞİ
        </button>
        <button id="btn-personel-login-choice" class="btn btn-secondary btn-full">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            PERSONEL GİRİŞİ
        </button>
    </div>

    <div id="admin-login-container" class="auth-container">
        <h1>Yönetici Girişi</h1>
        <p>Lütfen yönetici kullanıcı adınızı ve şifrenizi girin.</p>
        <form id="admin-login-form">
            <div class="input-group">
                <label for="admin-username">Kullanıcı Adı</label>
                <input type="text" id="admin-username" required>
            </div>
            <div class="input-group">
                <label for="admin-password">Şifre</label>
                <input type="password" id="admin-password" required>
            </div>
            <div id="admin-login-error" class="auth-message"></div>
            <button type="submit" class="btn btn-primary btn-full">Giriş Yap</button>
            <button type="button" class="btn btn-secondary btn-full" style="margin-top: 15px;" onclick="main.showLoginChoice()">Geri</button>
        </form>
    </div>

    <div id="personel-login-container" class="auth-container">
        <h1>Personel Girişi</h1>
        <p>Lütfen size atanan kullanıcı adı ve şifre ile giriş yapın.</p>
        <form id="personel-login-form">
            <div class="input-group">
                <label for="personel-username">Kullanıcı Adı</label>
                <input type="text" id="personel-username" required>
            </div>
            <div class="input-group">
                <label for="personel-password">Şifre</label>
                <input type="password" id="personel-password" required>
            </div>
            <div id="personel-login-error" class="auth-message"></div>
            <button type="submit" class="btn btn-primary btn-full">Giriş Yap</button>
            <button type="button" class="btn btn-secondary btn-full" style="margin-top: 15px;" onclick="main.showLoginChoice()">Geri</button>
        </form>
    </div>
    <div id="app-container">
        <aside id="sidebar">
            <div class="logo">YÖNETİM<span>PANELİ</span></div>
            <nav>
                <ul>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>Ana Panel</a></li>
                    <li data-role="admin isci"><a href="#" class="nav-link" data-page="vardiya-yonetimi"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.25 14.16L11 13.32V7h1.5v5.5l4.5 2.66-.75 1.3z"/></svg>Vardiya Yönetimi</a></li>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="uretim-ekle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>Üretim Ekle</a></li>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="personel-yonetimi"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/></svg>Personel Yönetimi</a></li>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="giderler"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm-1 14H5c-.55 0-1-.45-1-1v-5h16v5c0 .55-.45 1-1 1zM20 8H4V6h16v2z"/></svg>Giderler</a></li>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="fabrikalar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>Fabrika Hesapları</a></li>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="raporlar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>Raporlar</a></li>
                    <li data-role="admin">
    <a href="#" class="nav-link" data-page="stok-yonetimi">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-9.8-3.28l3.1-5.58h1c.55 0 1-.45 1-1s-.45-1-1-1H6.2c-.71 0-1.35.37-1.72.97l-3.2 5.76c-.72 1.3 1.07 2.62 1.92 1.48l.45-.63zM16.5 13c1.93 0 3.5-1.57 3.5-3.5S18.43 6 16.5 6 13 7.57 13 9.5s1.57 3.5 3.5 3.5z"/>
        </svg>
        Stok Yönetimi
    </a>
</li>
                    <li data-role="admin"><a href="#" class="nav-link" data-page="ayarlar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.4 12.99l-2.07-1.22c.04-.3.07-.61.07-.92s-.03-.62-.07-.92l2.07-1.22c.32-.19.44-.59.24-.91l-1-1.73c-.2-.32-.6-.44-.91-.24l-2.07 1.22c-.44-.33-.92-.6-1.44-.79l-.3-2.28c-.05-.38-.38-.66-.77-.66h-2c-.38 0-.72.28-.77.66l-.3 2.28c-.52.19-1 .46-1.44-.79l-2.07-1.22c-.32-.19-.71-.08-.91.24l-1 1.73c-.2.32-.08.71.24.91l2.07 1.22c-.04.3-.07.61-.07.92s.03.62.07.92l-2.07 1.22c-.32.19-.44.59-.24.91l1 1.73c.2.32.6.44.91.24l2.07-1.22c.44.33.92.6 1.44.79l.3 2.28c.05.38.38.66.77.66h2c.38 0-.72.28-.77-.66l-.3-2.28c.52-.19 1-.46 1.44-.79l2.07 1.22c.32.19.71.08.91-.24l1-1.73c.2-.32.08-.71-.24-.91zM12 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>Ayarlar</a></li>
                    <!-- Yeni: Personel Durumu (Yoklama) -->
                    <li data-role="admin"><a href="#" class="nav-link" data-page="personel-durumu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 3H4v18h2V3zm14 0h-2v18h2V3zM11 7h2v10h-2V7z"/></svg>Personel Durumu</a></li>
                </ul>
            </nav>
            <div id="sidebar-vardiya-durumu"></div>
            <button id="logout-btn" class="btn btn-danger">Çıkış Yap</button>
        </aside>

        <main id="main-content">
            <header>
                <h1 id="page-title">Ana Panel</h1>
                <div id="kullanici-bilgisi"></div>
            </header>
            
            <div id="dashboard" class="page active">
                <div class="card-container">
                    <div class="card"><h3>Toplam Üretim Değeri</h3><div class="value" id="dashboard-gelir">0 ₺</div></div>
                    <div class="card"><h3>Toplam Giderler</h3><div class="value" id="dashboard-gider">0 ₺</div></div>
                    <div class="card"><h3>Net Kâr (Tahsilata Göre)</h3><div class="value" id="dashboard-kar">0 ₺</div></div>
                    <div class="card"><h3>Kalan Toplam Alacak</h3><div class="value"id="dashboard-alacak">0 ₺</div></div>
                </div>
                <div class="content-box"><h2>Son 6 Aylık Nakit Akışı</h2><canvas id="nakitAkisChart" height="120"></canvas></div>
            </div>

            <div id="vardiya-yonetimi" class="page">
                <div id="aktif-vardiya-container" class="content-box" style="display: none;">
                    <h2>Aktif Vardiya</h2>
                    <div id="aktif-vardiya-detaylari"></div>
                    <!-- Yeni: Personel Ekle/Çıkar Butonu -->
                    <button id="vardiya-personel-yonet-btn" class="btn btn-info btn-full" style="margin-bottom: 15px;">Personel Ekle/Çıkar</button>
                    <button id="vardiya-devret-modal-btn" class="btn btn-warning btn-full" style="margin-bottom: 15px;">VARDİYAYI DEVRET (Başka Birine)</button>
                    <button id="vardiya-kapat-btn" class="btn btn-danger btn-full">VARDİYAYI KAPAT (Günü Sonlandır)</button>
                </div>
                <div id="yeni-vardiya-form-container" class="content-box" style="display: none;">
                    <h2>Yeni Vardiya Başlat</h2>
                    <form id="yeni-vardiya-form">
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr; align-items: end;">
                            <div class="input-group">
                                <label for="vardiya-personel-select">Vardiyayı Başlatan Personel(ler)</label>
                                <!-- Çoklu seçim: birden fazla personel seçilebilir -->
                                <select id="vardiya-personel-select" multiple size="6" required>
                                    <option value="" disabled>Personel Seçin...</option>
                                </select>
                                <small style="font-size: 12px; color: #7f8c8d;">Birden fazla personel seçmek için Ctrl veya Shift tuşlarını kullanın.</small>
                            </div>
                            <div class="input-group">
                                <button type="submit" class="btn btn-success btn-full">VARDİYAYI BAŞLAT</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="content-box">
                    <h2>Vardiya Geçmişi (Puantaj)</h2>
                    <div id="vardiya-gecmisi-container"></div>
                </div>
            </div>
            <div id="personel-yonetimi" class="page">
                <div class="content-box">
                    <h2>Personel İşlem Formu</h2>
                    <form id="personel-islem-form">
                        
                        <div class="input-group full-width" style="border-bottom: 2px solid #eee; padding-bottom: 25px;">
                            <label for="personel-islem-select">İşlem Tipi</label>
                            <select id="personel-islem-select">
                                <option value="new" selected>-- Yeni Personel Oluştur --</option>
                            </select>
                            <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
                                Yeni personel eklemek için bu seçenekte bırakın veya mevcut bir personeli güncellemek için listeden seçin.
                            </p>
                        </div>
                        
                        <h3 style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Personel Bilgileri</h3>
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr;">
                            <div class="input-group"><label for="personel-ad-soyad">İsim Soyisim (Zorunlu)</label><input type="text" id="personel-ad-soyad" placeholder="Örn: Mehmet Kaya" required></div>
                            <div class="input-group"><label for="personel-telefon">Telefon</label><input type="tel" id="personel-telefon" placeholder="Örn: 0555 123 4567"></div>
                            <div class="input-group"><label for="personel-ise-alim-tarihi">İşe Alınma Tarihi</label><input type="date" id="personel-ise-alim-tarihi"></div>
                        </div>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                            <div class="input-group"><label for="personel-pozisyon-select">Pozisyon</label><select id="personel-pozisyon-select" required><option value="" disabled selected>Pozisyon Seçin...</option></select></div>
                             <div class="input-group">
                                <label for="personel-net-maas" style="color: var(--success-color);">Net Maaş (Ele Geçen)</label>
                                <input type="number" step="0.01" id="personel-net-maas" placeholder="Örn: 25000" style="border-color: var(--success-color);">
                            </div>
                            <div class="input-group">
                                <label for="personel-brut-maas" style="color: var(--info-color);">Brüt Maaş (Resmi)</label>
                                <input type="number" step="0.01" id="personel-brut-maas" placeholder="Otomatik hesaplanır">
                            </div>
                            <div class="input-group">
                                <label for="personel-maas-tipi">Maaş Tipi</label>
                                <select id="personel-maas-tipi">
                                    <option value="Günlük">Günlük</option>
                                    <option value="Aylık">Aylık</option>
                                    <option value="Yarım Ay">Yarım Ay</option>
                                    <option value="Avans">Avans</option>
                                    <option value="Prim">Prim Usulü</option> </select>
                            </div>
                            <div class="input-group"><label for="personel-durum">Durum</label><select id="personel-durum"><option value="Aktif" selected>Aktif</option><option value="İzinde">İzinde</option><option value="Ayrıldı">İşten Ayrıldı</option></select></div>
                        </div>

                        
                        <h3 style="margin-top: 20px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Yasal Durum (SGK)</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                             <div class="input-group">
                                <label for="personel-sgk-durumu">SGK Durumu</label>
                                <select id="personel-sgk-durumu">
                                    <option value="Yok">Sigortasız</option>
                                    <option value="Var">Sigortalı</option>
                                </select>
                            </div>
                            <div class="input-group" id="personel-sgk-tutar-group" style="display:none;">
                                <label for="personel-sgk-tutar">Aylık SGK Maliyeti (İşveren Payı Dahil)</label>
                                <input type="number" step="0.01" id="personel-sgk-tutar" placeholder="Örn: 5500">
                                <small style="color: #7f8c8d; font-size: 12px;">Ödeme yaparken bu tutarı Giderlere eklemek isteyip istemediğinizi soracağım.</small>
                            </div>
                        </div>

                        <h3 style="margin-top: 20px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Panel Giriş Bilgileri (Opsiyonel)</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="input-group">
                                <label for="personel-kullanici-adi">Panel Kullanıcı Adı</label>
                                <input type="text" id="personel-kullanici-adi" placeholder="Bu personele özel kullanıcı adı (örn: mehmet.kaya)">
                            </div>
                             <div class="input-group">
                                <label for="personel-sifre">Panel Şifresi</label>
                                <input type="password" id="personel-sifre" placeholder="Yeni şifre (en az 4 karakter)">
                            </div>
                        </div>

                        <div style="text-align: right; margin-top: 10px;">
                            <button type="submit" id="personel-form-submit-btn" class="btn btn-success">Personeli Kaydet</button>
                        </div>
                    </form>
                </div>
                <div class="content-box">
                    <h2>Kayıtlı Personel Listesi</h2>
                    <div id="personel-listesi-container"></div>
                </div>
            </div>
            
            <div id="uretim-ekle" class="page">
                <div class="content-box">
                    <h2>Yeni Üretim Kalemi Ekle</h2>
                    <form id="uretim-ekle-form">
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr;">
                            <div class="input-group">
                                <label for="uretim-fabrika">Fabrika Seçin</label>
                                <select id="uretim-fabrika" required></select>
                            </div>
                            <div class="input-group">
                                <label for="uretim-tarih">Tarih</label>
                                <input type="date" id="uretim-tarih" required>
                            </div>
                        </div>
                        
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr; align-items: flex-end;">
                            <div class="input-group">
                                <label style="color:#2c3e50; font-weight:bold;">Üretilen Ürün / Yemek</label>
                                <select id="uretim-urun-secimi" onchange="actions.uretimUrunSecildi()" style="font-weight:bold; border: 2px solid #3498db; background:#f0f8ff;">
                                    <option value="" disabled selected>Listeden Seçiniz...</option>
                                    <option value="manuel">-- Listede Yok (Elle Yaz) --</option>
                                </select>
                                <input type="text" id="uretim-aciklama" placeholder="Ürün Adı Giriniz" style="display:none; margin-top:5px;">
                            </div>

                            <div class="input-group">
                                <label for="uretim-adet">Adet</label>
                                <input type="number" id="uretim-adet" placeholder="0" required style="font-weight:bold;">
                            </div>
                            
                            <div class="input-group">
                                <label for="uretim-birim-maliyet" style="color: #e67e22; font-weight:bold;">Birim Maliyet</label>
                                <input type="number" step="0.01" id="uretim-birim-maliyet" placeholder="Otomatik" style="border: 2px solid #e67e22;">
                            </div>

                            <div class="input-group">
                                <label for="uretim-kdv-orani" style="color: #8e44ad; font-weight:bold;">KDV (%)</label>
                                <input type="number" step="1" id="uretim-kdv-orani" placeholder="%10" style="border: 2px solid #8e44ad;">
                            </div>

                            <div class="input-group">
                                <label for="uretim-birim-fiyat" style="color: var(--success-color); font-weight:bold;">Satış Fiyatı</label>
                                <input type="number" step="0.01" id="uretim-birim-fiyat" placeholder="Toplam Fiyat" required style="border: 2px solid var(--success-color);">
                            </div>
                        </div>
                        
                        <div class="input-group full-width" style="margin-top: 10px;">
                            <label for="uretim-toplam-tutar">Toplam Satış Tutarı (Fabrika Borcu)</label>
                            <input type="text" id="uretim-toplam-tutar" disabled style="font-weight: bold; font-size: 16px;">
                        </div>

                        <div class="full-width" style="text-align: right; margin-top: 15px;">
                            <button type="button" id="listeye-ekle-btn" class="btn btn-primary">Listeye Ekle</button>
                        </div>
                    </form>
                </div>

                <div class="content-box">
                    <h2>Kaydedilecek Üretimler Listesi</h2>
                    <div id="kayit-listesi-container"></div>
                    <div id="kayit-listesi-genel-toplam">Genel Toplam: 0,00 ₺</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button type="button" id="listeyi-temizle-btn" class="btn btn-danger">Listeyi Temizle</button>
                        <button type="button" id="tumunu-kaydet-btn" class="btn btn-success">Listeyi Onayla ve Tümünü Kaydet</button>
                    </div>
                </div>
                
                <div class="content-box">
                    <h2>Son Kayıtlar</h2>
                    <div id="son-uretimler-container"></div>
                </div>
            </div>
          
            <div id="giderler" class="page">
                <div class="content-box">
                    <h2>Yeni Gider Ekle</h2>
                    <form id="gider-form">
                        <div class="form-grid">
                            <div class="input-group"><label for="gider-tip">Gider Tipi</label><select id="gider-tip" required><option value="" disabled selected>Tip seçin...</option><option value="fabrika">Fabrika Gideri</option><option value="diger">Diğer Gider</option></select></div>
                            <div class="input-group"><label for="gider-aciklama">Gider Başlığı (Kategori)</label><input type="text" id="gider-aciklama" placeholder="Örn: Mutfak Malzemeleri" required></div>
                            <div class="input-group full-width"><label for="gider-detay">Geniş Açıklama (Opsiyonel)</label><textarea id="gider-detay" rows="3" placeholder="Giderle ilgili detayları buraya yazabilirsiniz..."></textarea></div>
                            <div class="input-group"><label for="gider-tutar">Tutar (₺)</label><input type="number" step="0.01" id="gider-tutar" required></div>
                            <div class="input-group"><label for="gider-tarih">Tarih</label><input type="date" id="gider-tarih" required></div>
                            <div class="input-group" style="align-self: end;"><button type="submit" class="btn btn-success">Gideri Kaydet</button></div>
                        </div>
                    </form>
                </div>
                <div class="content-box">
                    <h2>Gider Listesi</h2>
                    <button id="gider-csv-indir" class="btn btn-primary" style="margin-bottom: 20px;">Gider Raporu (CSV) İndir</button>
                    <div id="gider-tablo-container"></div>
                </div>
            </div>
            
            <div id="fabrikalar" class="page">
                <div class="content-box">
                    <h2>Yeni Fabrika Ekle</h2>
                    <form id="fabrika-form"><div class="form-grid" style="grid-template-columns: 2fr 1fr;"><div class="input-group"><label for="fabrika-adi">Fabrika Adı</label><input type="text" id="fabrika-adi" placeholder="Örn: Büyük Anadolu Tekstil" required></div><div class="input-group" style="align-self: end;"><button type="submit" class="btn btn-success">Fabrikayı Kaydet</button></div></div></form>
                </div>
                <div class="content-box">
                    <h2>Fabrika Hesap Özetleri</h2>
                    <div id="fabrika-hesap-tablo-container"></div>
                </div>
                <div class="content-box danger-zone">
                    <h2>Tehlikeli Alan: Fabrika Silme</h2>
                    <p>Bir fabrikayı silmek, o fabrikaya ait **TÜM** üretim ve ödeme kayıtlarını kalıcı olarak yok edecektir. Bu işlem geri alınamaz. Sadece hesabını (kayıtlarını) temizlemek istiyorsanız, yukarıdaki "Hesabı Sıfırla" butonunu kullanın.</p>
                    <form id="fabrika-sil-form">
                        <div class="form-grid" style="grid-template-columns: 3fr 1fr; align-items: end;">
                            <div class="input-group"><label for="fabrika-sil-select">Silinecek Fabrikayı Seçin</label><select id="fabrika-sil-select" required><option value="" disabled selected>...Bir fabrika seçin...</option></select></div>
                            <div class="input-group"><button type="submit" class="btn btn-danger btn-full">Seçili Fabrikayı Sil</button></div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="raporlar" class="page">
                <div class="card-container" id="rapor-ozet-container" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="card"><h3>Toplam Üretim Değeri</h3><div class="value" id="rapor-gelir">0 ₺</div></div>
                    <div class="card"><h3>Toplam Giderler</h3><div class="value" id="rapor-gider">0 ₺</div></div>
                    <div class="card"><h3>Net Kâr (Tahsilata Göre)</h3><div class="value" id="rapor-kar">0 ₺</div></div>
                    <div class="card"><h3>Kalan Toplam Alacak</h3><div class="value" id="rapor-alacak">0 ₺</div></div>
                </div>
                <div class="content-box">
                    <h2>Genel Raporlama</h2>
                    <p style="margin-bottom:20px;">Tüm üretim (gelir kalemi) ve gider kayıtlarınızı içeren detaylı bir CSV dosyası indirin. Rapor sonunda Net Kâr ve Kalan Alacak özetini göreceksiniz.</p>
                    <button id="genel-csv-indir" class="btn btn-primary">Genel CSV Raporu İndir</button>
                </div>
            </div>

            <div id="stok-yonetimi" class="page">
    
    <div class="card-container">
        <div class="card">
            <h3>Toplam Kalem</h3>
            <div class="value" id="stok-toplam-kalem">0</div>
        </div>
        <div class="card">
            <h3>Kritik Stok Uyarısı</h3>
            <div class="value loss" id="stok-kritik-sayi">0</div>
        </div>
        <div class="card">
            <h3>Toplam Envanter Değeri</h3>
            <div class="value profit" id="stok-toplam-deger">0 ₺</div>
        </div>
    </div>

    <div style="margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
    <button class="btn btn-primary" onclick="renderer.switchStokTab('liste')" id="btn-tab-liste">📦 Stok Listesi</button>
    <button class="btn btn-secondary" onclick="renderer.switchStokTab('gecmis')" id="btn-tab-gecmis">🕒 Stok Geçmişi</button>
    <button class="btn btn-warning" onclick="actions.lotSorgulamaEkraniAc()">🔍 Lot Takibi</button>
    <button class="btn btn-info" onclick="renderer.switchStokTab('recete')" id="btn-tab-recete">📜 Reçeteler (Menüler)</button>
</div>

    <div id="tab-stok-liste">
        <div class="content-box">
            <h2>Hızlı Stok Kartı Oluştur</h2>
          <form id="stok-ekle-form">
    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); align-items: end;">
        
        <div class="input-group">
            <label>Ürün Adı</label>
            <input type="text" id="stok-adi" placeholder="Örn: Dana Kıyma, Domates" required>
        </div>

        <div class="input-group">
            <label>Kategori</label>
            <select id="stok-kategori">
                <optgroup label="Temel Türler">
                    <option value="Hammadde">Hammadde</option>
                    <option value="Yarı Mamul">Yarı Mamul</option>
                    <option value="Bitmiş Ürün">Bitmiş Ürün</option>
                    <option value="Sarf Malzeme">Sarf Malzeme</option>
                </optgroup>
                <optgroup label="Gıda Grupları">
                    <option value="Et">Et Grubu</option>
                    <option value="Sebze">Sebze / Meyve</option>
                    <option value="Kuru Gıda">Kuru Gıda / Bakliyat</option>
                    <option value="Süt Ürünleri">Süt ve Kahvaltılık</option>
                    <option value="İçecek">İçecek</option>
                </optgroup>
                <optgroup label="Diğer">
                    <option value="Ambalaj">Ambalaj Malzemesi</option>
                    <option value="Temizlik">Temizlik / Hijyen</option>
                    <option value="Demirbaş">Demirbaş</option>
                </optgroup>
            </select>
        </div>

        <div class="input-group">
            <label>Birim</label>
            <select id="stok-birim">
                <option value="Adet">Adet</option>
                <option value="Kg">Kg</option>
                <option value="Lt">Lt</option>
                <option value="Metre">Metre</option>
                <option value="Paket">Paket</option>
                <option value="Koli">Koli</option>
                <option value="Gram">Gram</option>
            </select>
        </div>

        <div class="input-group">
            <label>Mevcut Miktar</label>
            <input type="number" id="stok-miktar" placeholder="0" step="0.01" value="0">
        </div>

        <div class="input-group">
            <label>Kritik Stok (Uyarı Limiti)</label>
            <input type="number" id="stok-kritik" value="10" placeholder="Altına düşerse uyarır">
        </div>

        <div class="input-group">
            <label>Durum</label>
            <select id="stok-durum">
                <option value="Aktif" selected>Aktif (Kullanımda)</option>
                <option value="Pasif">Pasif (Kullanım Dışı)</option>
            </select>
        </div>

        <div class="input-group">
            <label>Birim Maliyet (₺)</label>
            <input type="number" id="stok-fiyat" step="0.01" value="0">
        </div>

        <div class="input-group">
            <button type="submit" class="btn btn-success btn-full">Kaydet</button>
        </div>
    </div>
</form>
        </div>

        <div class="content-box">
            <h2>Stok Durumu</h2>
            <input type="text" id="stok-ara" placeholder="Ürün ara..." style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
            <div id="stok-tablo-container" style="overflow-x:auto;"></div>
        </div>
    </div>

    <div id="tab-stok-gecmis" style="display: none;">
        <div class="content-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>Hareket Geçmişi</h2>
                <button class="btn btn-info" onclick="renderer.stokGecmisiIndir()">Excel (CSV) İndir</button>
            </div>
            <p style="color:#666; margin-bottom:15px;">Bu bölümde depoya giren ve çıkan tüm ürünlerin tarihçesini, kimin işlem yaptığını ve miktarları görebilirsiniz.</p>
            
            <div id="stok-gecmis-container" style="overflow-x:auto;"></div>
        </div>
    </div>
    <div id="tab-stok-recete" style="display: none;">
    <div class="content-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Ürün Reçeteleri</h2>
            <button class="btn btn-success" onclick="actions.yeniReceteModalAc()">+ Yeni Reçete Oluştur</button>
        </div>
        <p style="color:#666; margin-bottom:15px;">Üretim yapıldığında stoktan otomatik düşülecek malzemeleri buradan tanımlayın.</p>
        
        <div id="recete-listesi-container"></div>
    </div>
</div>
</div>

            <div id="ayarlar" class="page">
                <div class="content-box">
                    <h2>Güvenlik Ayarları</h2>
                    <p style="margin-bottom: 25px;">**Yönetici** (Admin) Ana Şifrenizi buradan güvenli bir şekilde değiştirebilirsiniz.</p>
                    <form id="sifre-degistir-form">
                        <div class="input-group"><label for="mevcut-sifre">Mevcut Yönetici Şifresi</label><input type="password" id="mevcut-sifre" required></div>
                        <div class="input-group"><label for="yeni-sifre">Yeni Yönetici Şifresi (En az 4 karakter)</label><input type="password" id="yeni-sifre" required></div>
                        <div class="input-group"><label for="yeni-sifre-onay">Yeni Yönetici Şifreyi Onayla</label><input type="password" id="yeni-sifre-onay" required></div>
                        <div id="sifre-degistir-sonuc" class="auth-message" style="height: auto;"></div>
                        <button type="submit" class="btn btn-primary">Şifreyi Güncelle</button>
                    </form>
                </div>

                <div class="content-box">
                    <h2>İK Ayarları: Pozisyon Yönetimi</h2>
                    <p style="margin-bottom: 20px;">"Personel Yönetimi" sayfasında görünecek pozisyon tanımlamalarını buradan yapabilirsiniz.</p>
                    <form id="pozisyon-ekle-form">
                        <div class="form-grid" style="grid-template-columns: 3fr 1fr; align-items: end;">
                            <div class="input-group"><label for="pozisyon-adi">Pozisyon Adı</label><input type="text" id="pozisyon-adi" placeholder="Örn: Aşçı, Şoför, Garson" required></div>
                            <div class="input-group"><button type="submit" class="btn btn-success btn-full">Pozisyon Ekle</button></div>
                        </div>
                    </form>
                    <h3 style="margin-top: 30px;">Mevcut Pozisyonlar</h3>
                    <div id="pozisyon-listesi-container"></div>
                </div>
            </div>

            <!-- Yeni: Personel Durumu Sayfası -->
            <div id="personel-durumu" class="page">
                <div class="content-box">
                    <h2>Personel Durumu (Günlük Yoklama)</h2>
                    <p style="margin-bottom:20px;">Personellerin işe gelip gelmediğini kontrol etmek için tabloyu kullanabilirsiniz. ✔ işaretli günler çalıştığı, × işaretli günler çalışmadığı, turuncu <strong>İzin</strong> hücreleri planlı haftalık izinleri, kırmızı <strong>İzin</strong> hücreleri ise devamsızlık/mazeretli izin günlerini gösterir.</p>
                    
                    <div style="margin-bottom: 15px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
    <button class="btn btn-warning" onclick="actions.showMissingHoursReport()">⚠️ Eksik Çalışma Hesapla</button>
    <button class="btn btn-info" onclick="actions.openAnnualLeaveModal()">🏖️ Toplu Yıllık İzin Girişi</button>
</div>

<div id="personel-durumu-container" style="overflow-x:auto;"></div>

                    <!-- Özet alanı: Çalışma günleri toplamlarını gösterecek -->
                    <div id="personel-durumu-summary-container"></div>

                    <!-- Haftalık izin planlama: kullanıcı her hafta farklı bir izin günü seçebilsin -->
                    <div id="izin-plan-section" style="margin-top: 30px;">
                        <h3>Haftalık İzin Planlama</h3>
                        <form id="izin-plan-form">
                            <div class="form-grid" style="grid-template-columns: 2fr 2fr 1fr; align-items: end;">
                                <div class="input-group">
                                    <label for="izin-personel-select">Personel</label>
                                    <select id="izin-personel-select" required>
                                        <option value="" disabled selected>Personel Seçin...</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="izin-tarih">İzin Tarihi</label>
                                    <input type="date" id="izin-tarih" required>
                                </div>
                                <div class="input-group">
                                    <button type="submit" class="btn btn-warning">İzin Gününü Ekle</button>
                                </div>
                            </div>
                            <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">Her hafta farklı izin günlerini burada seçebilirsiniz. Bu işlem yalnızca seçilen tarih için izin kaydı oluşturur.</p>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="modal-container">
        <div class="modal-content" id="modal-content-dynamic">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-dynamic">
            </div>
        </div>
    </div>
    <script>
// JAVASCRIPT KODLARI BAŞLANGIÇ (v5.9 - Net/Brüt Otomasyonu + Vardiya İyileştirmeleri)

const main = {}; 

// --- YENİ: SAAS (Çoklu Şirket) YÖNETİCİSİ ---
    // --- GÜNCELLENMİŞ SAAS MODÜLÜ (Hata Korumalı) ---
    // --- GÜNCELLENMİŞ SAAS MODÜLÜ (Şirket İsmi Gösteren Versiyon) ---
    // --- SAAS MODÜLÜ (GÜNCELLENMİŞ - Şirket Adı Özellikli) ---
    // --- SAAS MODÜLÜ (GÜNCELLENMİŞ - Ayarlar ve Silme Dahil) ---
    // --- SAAS MODÜLÜ (Gelişmiş Abonelik Yönetimi) ---
    const saas = {
        currentCompanyId: null,
        
        hideAll: () => {
            ['saas-landing', 'saas-register', 'saas-login', 'saas-admin-login', 'saas-admin-panel'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            if (typeof main !== 'undefined' && main.hideAllAuth) main.hideAllAuth(); 
        },
        showLanding: () => { saas.hideAll(); document.getElementById('saas-landing').style.display = 'block'; },
        showRegister: () => { saas.hideAll(); document.getElementById('saas-register').style.display = 'block'; },
        showLogin: () => { saas.hideAll(); document.getElementById('saas-login').style.display = 'block'; },
        showAdminLogin: () => { saas.hideAll(); document.getElementById('saas-admin-login').style.display = 'block'; },
        
        // --- İŞLEMLER ---
        register: async (e) => {
            e.preventDefault();
            const data = {
                companyName: document.getElementById('reg-company-name').value,
                email: document.getElementById('reg-email').value,
                username: document.getElementById('reg-username').value,
                password: document.getElementById('reg-password').value
            };
            try {
                const res = await fetch('/api/saas/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if (!res.ok) { alert("Kayıt Hatası: " + (await res.json()).error); return; }
                alert("Kayıt Başarılı!"); saas.showLanding();
            } catch (err) { alert('Hata!'); }
        },

        login: async (e) => {
            e.preventDefault();
            const data = { username: document.getElementById('login-username').value, password: document.getElementById('login-password').value };
            try {
                const res = await fetch('/api/saas/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if (!res.ok) { alert((await res.json()).error); return; }
                const result = await res.json();
                
                saas.currentCompanyId = result.companyId;
                const sirketAdi = result.companyName || "Panel";
                document.title = sirketAdi;
                if(document.querySelector('#login-choice-container h1')) document.querySelector('#login-choice-container h1').textContent = sirketAdi;
                if(document.querySelector('#sidebar .logo')) document.querySelector('#sidebar .logo').innerHTML = sirketAdi.toUpperCase();
                
                saas.hideAll();
                if(typeof main !== 'undefined' && main.boot) main.boot(); 
            } catch (err) { alert('Hata!'); }
        },

        adminLogin: async (e) => {
            e.preventDefault();
            const data = { username: document.getElementById('admin-login-user').value, password: document.getElementById('admin-login-pass').value };
            try {
                const res = await fetch('/api/saas/admin/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if (!res.ok) throw new Error();
                document.getElementById('admin-new-username').value = data.username;
                saas.loadAdminPanel();
            } catch (err) { alert('Hatalı giriş.'); }
        },

        // --- YÖNETİCİ PANELİ ÖZELLİKLERİ ---
        switchAdminTab: (tabName) => {
            ['companies', 'payments', 'settings'].forEach(t => {
                document.getElementById('admin-view-' + t).style.display = (t === tabName) ? 'block' : 'none';
                const btn = document.getElementById('btn-admin-tab-' + t);
                if(btn) btn.className = (t === tabName) ? 'btn btn-primary' : 'btn btn-secondary';
            });
            if(tabName === 'payments') saas.loadPayments(); // Ödemeler sekmesi açılırsa verileri çek
        },

        loadAdminPanel: async () => {
            saas.hideAll();
            document.getElementById('saas-admin-panel').style.display = 'block';
            saas.switchAdminTab('companies');

            const tbody = document.querySelector('#saas-companies-table tbody');
            tbody.innerHTML = '<tr><td colspan="4">Yükleniyor...</td></tr>';
            try {
                const res = await fetch('/api/saas/admin/companies');
                const companies = await res.json();
                tbody.innerHTML = '';
                
                if(companies.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Kayıt yok.</td></tr>'; return; }

                companies.forEach(comp => {
                    const startD = comp.subscriptionStartDate ? new Date(comp.subscriptionStartDate).toLocaleDateString('tr-TR') : '-';
                    const endD = comp.subscriptionEndDate ? new Date(comp.subscriptionEndDate).toLocaleDateString('tr-TR') : '-';
                    
                    let actions = '';
                    // Tek bir buton ile abonelik penceresini açıyoruz
                    actions += `<button class="btn-sm-primary" onclick="saas.openSubscriptionModal('${comp._id}', '${comp.companyName}')">Abonelik Yönetimi</button> `;
                    
                    if(comp.status === 'Suspended' || comp.status === 'Pending') {
                        actions += `<button class="btn-sm-danger" onclick="saas.deleteCompany('${comp._id}')">Sil</button>`;
                    } else {
                        actions += `<button class="btn-sm-danger" onclick="saas.suspendCompany('${comp._id}')">Askıya Al</button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><b>${comp.companyName}</b><br><small>${comp.email}</small></td>
                            <td><span class="status-badge status-${comp.status}">${comp.status}</span></td>
                            <td>Başlangıç: ${startD}<br>Bitiş: ${endD}</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
            } catch (err) { tbody.innerHTML = '<tr><td colspan="4">Hata.</td></tr>'; }
        },

        // YENİ: Abonelik Modalını Aç
        openSubscriptionModal: (id, name) => {
            document.getElementById('modal-company-id').value = id;
            document.getElementById('modal-company-name').textContent = name;
            
            // Başlangıç tarihini bugün yap
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sub-start-date').value = today;
            
            document.getElementById('sub-amount').value = ''; // Fiyatı sıfırla
            document.getElementById('sub-duration').value = '1'; // Varsayılan 1 ay

            // Modalı göster (Flex yaparak ortalıyoruz)
            document.getElementById('subscription-modal').style.display = 'flex';
        },

        // YENİ: Aboneliği Kaydet
        saveSubscription: async () => {
            const id = document.getElementById('modal-company-id').value;
            const amount = document.getElementById('sub-amount').value;
            const months = document.getElementById('sub-duration').value;
            const startDate = document.getElementById('sub-start-date').value;

            if(!amount) { alert("Lütfen bir tutar girin."); return; }

            try {
                const res = await fetch('/api/saas/admin/add-subscription', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ companyId: id, amount, months, startDate })
                });
                const result = await res.json();
                if(result.success) {
                    alert(result.message);
                    document.getElementById('subscription-modal').style.display = 'none';
                    saas.loadAdminPanel(); // Listeyi yenile
                } else { alert("Hata: " + result.error); }
            } catch (err) { alert("Sunucu hatası."); }
        },

        // YENİ: Ödeme Geçmişini Yükle
        loadPayments: async () => {
            const tbody = document.querySelector('#saas-payments-table tbody');
            tbody.innerHTML = '<tr><td colspan="4">Yükleniyor...</td></tr>';
            try {
                const res = await fetch('/api/saas/admin/payments');
                const payments = await res.json();
                tbody.innerHTML = '';
                if(payments.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Henüz ödeme yok.</td></tr>'; return; }
                
                payments.forEach(p => {
                    const date = new Date(p.paymentDate).toLocaleDateString('tr-TR') + ' ' + new Date(p.paymentDate).toLocaleTimeString('tr-TR');
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.companyName}</td>
                            <td style="color:green; font-weight:bold;">${p.amount} TL</td>
                            <td>${p.period}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });
            } catch (err) { tbody.innerHTML = '<tr><td colspan="4">Hata.</td></tr>'; }
        },

        // Yardımcılar
        deleteCompany: async (id) => {
            if(!confirm('Bu şirketi KALICI olarak silmek istiyor musunuz?')) return;
            await fetch('/api/saas/admin/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) });
            saas.loadAdminPanel();
        },
        suspendCompany: async (id) => { // Askıya alma butonu için kısa yol
             // Askıya alırken "Status: Suspended" gönderiyoruz, gün eklemiyoruz (subscriptionDays: 0)
             await fetch('/api/saas/admin/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, status: 'Suspended', subscriptionDays: 0 }) });
             saas.loadAdminPanel();
        },
        saveAdminSettings: async () => {
            const newUsername = document.getElementById('admin-new-username').value;
            const newPassword = document.getElementById('admin-new-password').value;
            await fetch('/api/saas/admin/update-credentials', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ newUsername, newPassword }) });
            alert("Güncellendi.");
        }
    };
document.addEventListener('DOMContentLoaded', () => {

    // --- BÖLÜM 1: UYGULAMA OBJESİ (NAMESPACE) ---
    const app = {
        currentUser: null,
        dom: {
            setupContainer: document.getElementById('setup-container'),
            setupForm: document.getElementById('setup-form'),
            setupError: document.getElementById('setup-error'),
            loginChoiceContainer: document.getElementById('login-choice-container'),
            btnAdminLoginChoice: document.getElementById('btn-admin-login-choice'),
            btnPersonelLoginChoice: document.getElementById('btn-personel-login-choice'),
            adminLoginContainer: document.getElementById('admin-login-container'),
            adminLoginForm: document.getElementById('admin-login-form'),
            adminLoginError: document.getElementById('admin-login-error'),
            // Admin login inputs
            adminUsernameInput: document.getElementById('admin-username'),
            adminPasswordInput: document.getElementById('admin-password'),
            personelLoginContainer: document.getElementById('personel-login-container'),
            personelLoginForm: document.getElementById('personel-login-form'),
            personelLoginError: document.getElementById('personel-login-error'),
            appContainer: document.getElementById('app-container'),
            logoutBtn: document.getElementById('logout-btn'),
            navLinks: document.querySelectorAll('#sidebar nav a'), 
            navItems: document.querySelectorAll('#sidebar nav li'), 
            pages: document.querySelectorAll('.page'),
            pageTitle: document.getElementById('page-title'),
            kullaniciBilgisi: document.getElementById('kullanici-bilgisi'), 
            fabrikaForm: document.getElementById('fabrika-form'),
            uretimEkleForm: document.getElementById('uretim-ekle-form'), 
            giderForm: document.getElementById('gider-form'),
            modalContainer: document.getElementById('modal-container'),
            modalContent: document.getElementById('modal-content-dynamic'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body-dynamic'),
            modalCloseBtn: document.querySelector('.modal-close-btn'),
            fabrikaHesapTabloContainer: document.getElementById('fabrika-hesap-tablo-container'),
            giderTabloContainer: document.getElementById('gider-tablo-container'),
            genelCsvIndirBtn: document.getElementById('genel-csv-indir'),
            giderCsvIndirBtn: document.getElementById('gider-csv-indir'),
            uretimFabrikaSelect: document.getElementById('uretim-fabrika'),
            uretimTarihInput: document.getElementById('uretim-tarih'),
            uretimAdetInput: document.getElementById('uretim-adet'),
            uretimBirimFiyatInput: document.getElementById('uretim-birim-fiyat'),
            uretimToplamTutarInput: document.getElementById('uretim-toplam-tutar'),
            listeyeEkleBtn: document.getElementById('listeye-ekle-btn'),
            kayitListesiContainer: document.getElementById('kayit-listesi-container'),
            kayitListesiGenelToplam: document.getElementById('kayit-listesi-genel-toplam'),
            listeyiTemizleBtn: document.getElementById('listeyi-temizle-btn'),
            tumunuKaydetBtn: document.getElementById('tumunu-kaydet-btn'),
            sonUretimlerContainer: document.getElementById('son-uretimler-container'),
            fabrikaSilForm: document.getElementById('fabrika-sil-form'),
            fabrikaSilSelect: document.getElementById('fabrika-sil-select'),
            sifreDegistirForm: document.getElementById('sifre-degistir-form'),
            sifreDegistirSonuc: document.getElementById('sifre-degistir-sonuc'),
            sidebarVardiyaDurumu: document.getElementById('sidebar-vardiya-durumu'),
            aktifVardiyaContainer: document.getElementById('aktif-vardiya-container'),
            aktifVardiyaDetaylari: document.getElementById('aktif-vardiya-detaylari'),
            vardiyaKapatBtn: document.getElementById('vardiya-kapat-btn'),
            yeniVardiyaFormContainer: document.getElementById('yeni-vardiya-form-container'),
            yeniVardiyaForm: document.getElementById('yeni-vardiya-form'),
            vardiyaGecmisiContainer: document.getElementById('vardiya-gecmisi-container'),
            vardiyaPersonelSelect: document.getElementById('vardiya-personel-select'),
            vardiyaDevretModalBtn: document.getElementById('vardiya-devret-modal-btn'),
            // Yeni: personel yönet butonu
            vardiyaPersonelYonetBtn: document.getElementById('vardiya-personel-yonet-btn'),
            // Personel Form DOM (GÜNCELLENDİ: Net ve Brüt Maaş Alanları)
            personelIslemForm: document.getElementById('personel-islem-form'),
            personelIslemSelect: document.getElementById('personel-islem-select'),
            personelFormSubmitBtn: document.getElementById('personel-form-submit-btn'),
            personelSgkDurumu: document.getElementById('personel-sgk-durumu'),
            personelSgkTutarGroup: document.getElementById('personel-sgk-tutar-group'),
            personelNetMaasInput: document.getElementById('personel-net-maas'),
            personelBrutMaasInput: document.getElementById('personel-brut-maas'),
            personelListesiContainer: document.getElementById('personel-listesi-container'),
            personelPozisyonSelect: document.getElementById('personel-pozisyon-select'),
            pozisyonEkleForm: document.getElementById('pozisyon-ekle-form'),
            pozisyonListesiContainer: document.getElementById('pozisyon-listesi-container'),
            // Yeni: Personel Durumu sayfası
            personelDurumuContainer: document.getElementById('personel-durumu-container'),
            personelDurumuSummaryContainer: document.getElementById('personel-durumu-summary-container'),
            // Haftalık izin planlama
            izinPersonelSelect: document.getElementById('izin-personel-select'),
            izinTarihInput: document.getElementById('izin-tarih'),
            izinPlanForm: document.getElementById('izin-plan-form'),
            // Personel Durumu nav is handled via navLinks
        },
        data: {},
        temp: {
            uretimListesi: []
        },
        charts: {
            nakitAkis: null,
        },
        helpers: {
            formatCurrency: (value) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(value),
            formatDateTime: (isoString) => { if (!isoString) return '-'; return new Date(isoString).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); },
            formatTime: (isoString) => { if (!isoString) return '-'; return new Date(isoString).toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' }); },
            formatDate: (isoString) => { if (!isoString) return '-'; if (isoString.length === 10) { return new Date(isoString + 'T00:00:00').toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }); } return new Date(isoString).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }); },
            getTodayISO: () => new Date().toISOString().split('T')[0],
            hash: async (string) => { const utf8 = new TextEncoder().encode(string); const hashBuffer = await crypto.subtle.digest('SHA-256', utf8); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); },
            calculateDuration: (startISO, endISO) => { if (!startISO || !endISO) return 'N/A'; const start = new Date(startISO); const end = new Date(endISO); let diffMs = end - start; if (diffMs < 0) diffMs = 0; const hours = Math.floor(diffMs / 3600000); const minutes = Math.floor((diffMs % 3600000) / 60000); return `${hours} saat ${minutes} dk`; },
            // Hesaplanan süreyi ondalık saat olarak döndürür
            calculateHoursDecimal: (startISO, endISO) => {
                if (!startISO || !endISO) return 0;
                let diffMs = new Date(endISO) - new Date(startISO);
                if (diffMs < 0) diffMs = 0;
                const hours = diffMs / 3600000;
                return parseFloat(hours.toFixed(2));
            },
            // Saat ondalığını okunabilir formata çevirir (örn. 5.5 -> "5sa 30dk")
            formatHoursDecimal: (hoursDecimal) => {
                if (!hoursDecimal || hoursDecimal <= 0) return '';
                const hours = Math.floor(hoursDecimal);
                const minutes = Math.round((hoursDecimal - hours) * 60);
                let str = '';
                if (hours > 0) str += `${hours}sa`;
                if (minutes > 0) str += `${str ? ' ' : ''}${minutes}dk`;
                return str;
            },
            // YENİ: Netten Brüt Hesaplama Fonksiyonu (Tahmini Katsayı ile)
            calculateGrossSalary: (netSalary) => {
                if (!netSalary || netSalary <= 0) return 0;
                const gross = netSalary / 0.7149;
                return parseFloat(gross.toFixed(2));
            }
        }
    };

    // --- BÖLÜM 2: VERİ YÖNETİMİ ---
    const dataManager = {
        load: async () => {
            const defaultData = { fabrikalar: [], uretimler: [], giderler: [], odemeler: [], vardiyalar: [], personel: [], pozisyonlar: [], stoklar: [],stokHareketleri: [] };
            try {
                // YENİ: Header içinde company-id gönderiyoruz
                const headers = {};
                if (saas.currentCompanyId) {
                    headers['company-id'] = saas.currentCompanyId;
                }
                
                const resp = await fetch('/api/data', { headers: headers });
                if (!resp.ok) throw new Error('Sunucu yanıtı başarısız');
                const remoteData = await resp.json();
                app.data = remoteData || defaultData;
            } catch (err) {
                console.error('Veri yüklenemedi:', err);
                app.data = defaultData;
            }
            // ... (Buradan sonraki migrasyon kodlarını aynen koruyun) ...
             app.data.personel.forEach(p => { /* ...eski kodlarınız... */ });
             // Migrasyon kodlarının devamı burada kalsın
        },
        save: async () => {
            try {
                // YENİ: Header içinde company-id gönderiyoruz
                const headers = { 'Content-Type': 'application/json' };
                if (saas.currentCompanyId) {
                    headers['company-id'] = saas.currentCompanyId;
                }

                await fetch('/api/data', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(app.data)
                });
            } catch (err) {
                console.error('Kaydetme hatası:', err);
            }
        },
        loadAuthHash: () => { return localStorage.getItem('fabrikaYonetimAuth_v2_hash'); },
        saveAuthHash: (hash) => { localStorage.setItem('fabrikaYonetimAuth_v2_hash', hash); }
    };

    // --- BÖLÜM 3: HESAPLAMA MOTORU ---
    const calculator = {
        fabrikaBakiyesi: (fabrikaId) => { const toplamUretim = app.data.uretimler.filter(u => u.fabrikaId === fabrikaId).reduce((sum, u) => sum + (u.adet * u.birimFiyat), 0); const toplamOdenen = app.data.odemeler.filter(o => o.fabrikaId === fabrikaId).reduce((sum, o) => sum + o.tutar, 0); return { toplamUretim, toplamOdenen, kalanBorc: toplamUretim - toplamOdenen }; },
        genelDurum: () => { const toplamUretimDegeri = app.data.uretimler.reduce((sum, u) => sum + (u.adet * u.birimFiyat), 0); const toplamGiderler = app.data.giderler.reduce((sum, g) => sum + g.tutar, 0); const toplamTahsilat = app.data.odemeler.reduce((sum, o) => sum + o.tutar, 0); const netKar = toplamTahsilat - toplamGiderler; const kalanAlacak = toplamUretimDegeri - toplamTahsilat; return { toplamUretimDegeri, toplamGiderler, toplamTahsilat, netKar, kalanAlacak }; }
    };

    // --- BÖLÜM 4: ARAYÜZ GÜNCELLEME (RENDER) ---
    const renderer = {
        updateAll: () => {
            renderer.fabrikaSelect(); 
            renderer.giderTablosu();
            renderer.fabrikaHesapOzetleri();
            renderer.dashboard();
            renderer.raporlarOzeti(); 
            renderer.uretimEkleListesi();
            renderer.sonUretimler();
            renderer.fabrikaSilSelect();
            renderer.pozisyonListesi();
            renderer.personelPozisyonSelect();
            renderer.personelListesi();
            renderer.vardiyaPersonelSelect();
            renderer.updateVardiyaDurumu(); 
            renderer.personelIslemSelect();
            renderer.personelDurumu();
            // Haftalık izin planlama için personel listesini güncelle
            renderer.populateIzinPersonelSelect();
            // renderer.updateAll fonksiyonunun içine ekleyin:
renderer.stokListesi();
renderer.stokGecmisi(); // <-- BU SATIRI EKLEYİN
        },
        updateForRole: () => {
            const role = app.currentUser.role;
            const ad = app.currentUser.ad;
            app.dom.kullaniciBilgisi.innerHTML = `Giriş Yapan: <span>${ad}</span> (${role === 'admin' ? 'Yönetici' : 'Personel'})`;
            app.dom.navItems.forEach(li => {
                const roller = li.dataset.role.split(' ');
                if (roller.includes(role)) { li.style.display = 'block'; } 
                else { li.style.display = 'none'; }
            });
            if (role === 'isci') { actions.navigate(null, 'vardiya-yonetimi'); } 
            else { actions.navigate(null, 'dashboard'); }
        },
        updateVardiyaDurumu: () => {
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (activeShift) {
                // Sadece aktif çalışanları al (bitisZamani olmayanlar)
                const aktifCalisanlar = activeShift.calisanlar.filter(c => !c.bitisZamani);
                // Sorumlu personeli belirle (shift.responsibleId varsa onu kullan, yoksa ilk kişiyi al)
                let responsibleId = activeShift.responsibleId;
                if (responsibleId === undefined || responsibleId === null) {
                    responsibleId = aktifCalisanlar.length > 0 ? aktifCalisanlar[0].personelId : null;
                }
                // Yan paneldeki isim listesi (tüm aktif çalışanların isimleri)
                const isimYazisi = aktifCalisanlar.map(c => c.isciAdi).join(', ');
                app.dom.sidebarVardiyaDurumu.innerHTML = `<span class="durum durum-acik">VARDİYA AÇIK</span><span class="isim">${isimYazisi || '-'}</span>`;
                // Detayları göster: sorumlu en üstte, diğerleri altta
                let detayHtml = '';
                // Sorumlu personel
                const sorumlu = aktifCalisanlar.find(c => c.personelId === responsibleId);
                if (sorumlu) {
                    detayHtml += `<div style="margin-bottom:8px;"><strong>${sorumlu.isciAdi} (Vardiya Sorumlusu)</strong> (Başlangıç: ${app.helpers.formatTime(sorumlu.devralmaZamani)})</div>`;
                }
                // Diğer çalışanlar
                aktifCalisanlar.forEach(c => {
                    if (c.personelId === responsibleId) return;
                    detayHtml += `<div style="margin-bottom:8px;">
                        <strong>${c.isciAdi}</strong> (Başlangıç: ${app.helpers.formatTime(c.devralmaZamani)}) 
                        <button class="btn-sm-danger calisan-cikart-btn" data-personel-id="${c.personelId}">Çıkış</button>
                    </div>`;
                });
                if (aktifCalisanlar.length > 0) {
                    app.dom.aktifVardiyaDetaylari.innerHTML = detayHtml;
                } else {
                    app.dom.aktifVardiyaDetaylari.innerHTML = '<p>Şu anda aktif çalışan bulunmuyor.</p>';
                }
                app.dom.aktifVardiyaContainer.style.display = 'block';
                app.dom.yeniVardiyaFormContainer.style.display = 'none';
            } else {
                app.dom.sidebarVardiyaDurumu.innerHTML = `<span class="durum durum-kapali">VARDİYA KAPALI</span><span class="isim">-</span>`;
                app.dom.aktifVardiyaContainer.style.display = 'none';
                app.dom.yeniVardiyaFormContainer.style.display = 'block';
            }
            renderer.vardiyaGecmisi();
        },
        vardiyaGecmisi: () => {
            app.dom.vardiyaGecmisiContainer.innerHTML = '';
            const tamamlananlar = app.data.vardiyalar.filter(v => v.durum === 'Tamamlandı').sort((a, b) => new Date(b.baslamaZamani) - new Date(a.baslamaZamani));
            if (tamamlananlar.length === 0) { app.dom.vardiyaGecmisiContainer.innerHTML = '<p class="no-data-message">Henüz tamamlanmış bir vardiya kaydı yok.</p>'; return; }
            const table = document.createElement('table');
            table.innerHTML = '<thead><tr><th>Çalışan(lar) (Zaman Damgaları ve Süreler)</th><th>İlk Başlangıç</th><th>Son Bitiş</th><th>Toplam Süre</th><th>İşlemler</th></tr></thead><tbody></tbody>';
            const tbody = table.querySelector('tbody');
            const silmeButonuHtml = app.currentUser && app.currentUser.role === 'admin' 
                ? `<button class="btn-sm-danger vardiya-sil-btn" data-id="{id}">Sil</button>`
                : `<i>Yetki Yok</i>`; 
            tamamlananlar.forEach(vardiya => {
                const calisanDetaylari = [];
                vardiya.calisanlar.forEach(calisan => {
                    const startTimeISO = calisan.devralmaZamani;
                    const endTimeISO = calisan.bitisZamani || vardiya.bitisZamani;
                    const startTime = app.helpers.formatTime(startTimeISO);
                    const endTime = app.helpers.formatTime(endTimeISO);
                    const sure = app.helpers.calculateDuration(startTimeISO, endTimeISO);
                    calisanDetaylari.push(`${calisan.isciAdi} (${startTime} - ${endTime}) [${sure}]`);
                });
                const calisanZinciri = calisanDetaylari.join(' &rarr; ');
                const toplamSure = app.helpers.calculateDuration(vardiya.baslamaZamani, vardiya.bitisZamani);
                tbody.insertRow().innerHTML = `
                    <td>${calisanZinciri}</td>
                    <td>${app.helpers.formatDateTime(vardiya.baslamaZamani)}</td>
                    <td>${app.helpers.formatDateTime(vardiya.bitisZamani)}</td>
                    <td>${toplamSure}</td>
                    <td>${silmeButonuHtml.replace('{id}', vardiya.id)}</td>
                `;
            });
            app.dom.vardiyaGecmisiContainer.appendChild(table);
        },
        personelListesi: () => {
            app.dom.personelListesiContainer.innerHTML = '';
            const personeller = app.data.personel.sort((a, b) => a.ad.localeCompare(b.ad));
            if (personeller.length === 0) { app.dom.personelListesiContainer.innerHTML = '<p class="no-data-message">Kayıtlı personel bulunmuyor.</p>'; return; }
            const table = document.createElement('table');
            table.innerHTML = '<thead><tr><th>Durum</th><th>İsim Soyisim</th><th>Pozisyon</th><th>Panel Girişi</th><th>Maaş (Net/Brüt)</th><th>İşlemler</th></tr></thead><tbody></tbody>';
            const tbody = table.querySelector('tbody');
            personeller.forEach(personel => {
                const pozisyon = app.data.pozisyonlar.find(p => p.id === personel.pozisyonId);
                const pozisyonAdi = pozisyon ? pozisyon.ad : '<span style="color:red;">Silinmiş</span>';
                const net = personel.netMaas ? app.helpers.formatCurrency(personel.netMaas) : '0 ₺';
                const brut = personel.brutMaas ? app.helpers.formatCurrency(personel.brutMaas) : '0 ₺';
                const maasBilgisi = `<strong>Net: ${net}</strong><br><span style="font-size:12px; color:#7f8c8d;">Brüt: ${brut}</span><br><span style="font-size:11px;">(${personel.maasTipi})</span>`;
                const panelGiris = personel.kullaniciAdi ? `Var (${personel.kullaniciAdi})` : 'Yok';
                let durumRenk = '';
                if (personel.durum === 'Aktif') durumRenk = 'var(--success-color)';
                if (personel.durum === 'İzinde') durumRenk = 'var(--secondary-color)';
                if (personel.durum === 'Ayrıldı') durumRenk = 'var(--danger-color)';
                let sgkBadge = '';
                if (personel.sgkDurumu === 'Var') {
                    sgkBadge = '<span class="sgk-badge">SGK</span>';
                }
                tbody.insertRow().innerHTML = `
                    <td style="color: ${durumRenk}; font-weight: 600;">${personel.durum}</td>
                    <td>${personel.ad} ${sgkBadge}</td>
                    <td>${pozisyonAdi}</td>
                    <td style="font-style: italic;">${panelGiris}</td>
                    <td>${maasBilgisi}</td>
                    <td style="width: 180px;">
                        <button class="btn-sm-success personel-odeme-btn" data-id="${personel.id}" data-name="${personel.ad}">Ödeme Yap</button>
                        <button class="btn-sm-danger personel-sil-btn" data-id="${personel.id}">Sil</button>
                    </td>
                `;
            });
            app.dom.personelListesiContainer.appendChild(table);
        },
        personelIslemSelect: () => {
            const select = app.dom.personelIslemSelect;
            const mevcutDeger = select.value;
            select.innerHTML = '<option value="new" selected>-- Yeni Personel Oluştur --</option>';
            const personeller = app.data.personel.sort((a, b) => a.ad.localeCompare(b.ad));
            personeller.forEach(p => {
                select.add(new Option(p.ad, p.id));
            });
            select.value = mevcutDeger;
        },
        pozisyonListesi: () => {
            app.dom.pozisyonListesiContainer.innerHTML = '';
            const pozisyonlar = app.data.pozisyonlar.sort((a, b) => a.ad.localeCompare(b.ad));
            if (pozisyonlar.length === 0) { app.dom.pozisyonListesiContainer.innerHTML = '<p class="no-data-message">Tanımlanmış pozisyon yok.</p>'; return; }
            const table = document.createElement('table');
            table.innerHTML = '<thead><tr><th>Pozisyon Adı</th><th>Kullanan Personel Sayısı</th><th>İşlemler</th></tr></thead><tbody></tbody>';
            const tbody = table.querySelector('tbody');
            pozisyonlar.forEach(pozisyon => {
                const kullanimSayisi = app.data.personel.filter(p => p.pozisyonId === pozisyon.id).length;
                tbody.insertRow().innerHTML = `
                    <td>${pozisyon.ad}</td>
                    <td>${kullanimSayisi} kişi</td>
                    <td><button class="btn-sm-danger pozisyon-sil-btn" data-id="${pozisyon.id}" data-kullanim="${kullanimSayisi}">Sil</button></td>
                `;
            });
            app.dom.pozisyonListesiContainer.appendChild(table);
        },
        personelPozisyonSelect: (selectElement = app.dom.personelPozisyonSelect, selectedId = null) => {
            selectElement.innerHTML = '<option value="" disabled>Pozisyon Seçin...</option>';
            const pozisyonlar = app.data.pozisyonlar.sort((a, b) => a.ad.localeCompare(b.ad));
            if(pozisyonlar.length === 0) { selectElement.innerHTML = '<option value="" disabled>Lütfen önce Ayarlar\'dan pozisyon ekleyin.</option>'; }
            pozisyonlar.forEach(p => {
                const option = new Option(p.ad, p.id);
                if (selectedId && p.id === selectedId) { option.selected = true; }
                selectElement.add(option);
            });
            if (!selectedId) { selectElement.value = ""; }
        },
        vardiyaPersonelSelect: () => {
            const select = app.dom.vardiyaPersonelSelect;
            select.innerHTML = '<option value="" disabled>Personel Seçin...</option>';
            const aktifPersoneller = app.data.personel.filter(p => p.durum === 'Aktif').sort((a, b) => a.ad.localeCompare(b.ad));
            if (app.currentUser && app.currentUser.role === 'isci') {
                // İşçi ise, sadece kendini seçebilir (tek seçim). Ancak multiple select desteklendiğinden tek seçim olmaması gerekir; yine de kısıtlayalım.
                const isci = aktifPersoneller.find(p => p.id === app.currentUser.id);
                if (isci) { select.innerHTML = `<option value="${isci.id}" selected>${isci.ad}</option>`; } 
                else { select.innerHTML = '<option value="" disabled>Aktif personel olarak kayıtlı değilsiniz.</option>'; }
            } else { 
                 if(aktifPersoneller.length === 0) { select.innerHTML = '<option value="" disabled>Sistemde "Aktif" personel bulunmuyor.</option>'; }
                 aktifPersoneller.forEach(p => { select.add(new Option(p.ad, p.id)); });
            }
        },
        fabrikaSelect: () => { const selectUretim = app.dom.uretimFabrikaSelect; selectUretim.innerHTML = '<option value="" disabled selected>Bir fabrika seçin...</option>'; app.data.fabrikalar.forEach(f => selectUretim.add(new Option(f.ad, f.id))); },
        fabrikaSilSelect: () => { const selectSil = app.dom.fabrikaSilSelect; selectSil.innerHTML = '<option value="" disabled selected>...Bir fabrika seçin...</option>'; app.data.fabrikalar.forEach(f => selectSil.add(new Option(f.ad, f.id))); },
        giderTablosu: () => {
            app.dom.giderTabloContainer.innerHTML = '';
            if (app.data.giderler.length === 0) { app.dom.giderTabloContainer.innerHTML = '<p class="no-data-message">Henüz gider kaydı bulunmuyor.</p>'; return; }
            const table = document.createElement('table'); table.innerHTML = '<thead><tr><th>Tip</th><th>Tarih</th><th>Başlık</th><th>Açıklama</th><th>Tutar</th><th>İşlemler</th></tr></thead><tbody></tbody>';
            const tbody = table.querySelector('tbody');
            app.data.giderler.sort((a,b) => new Date(b.tarih) - new Date(a.tarih)).forEach(gider => {
                const row = tbody.insertRow(); const giderTipiMetni = gider.tip === 'fabrika' ? 'Fabrika Gideri' : 'Diğer Gider';
                row.innerHTML = `<td>${giderTipiMetni}</td><td>${new Date(gider.tarih).toLocaleDateString('tr-TR')}</td><td>${gider.aciklama}</td><td style="white-space: pre-wrap; max-width: 300px; word-wrap: break-word;">${gider.detay || '-'}</td><td>${app.helpers.formatCurrency(gider.tutar)}</td><td><button class="btn btn-danger gider-sil-btn" data-id="${gider.id}">Sil</button></td>`;
            });
            app.dom.giderTabloContainer.appendChild(table);
        },
        fabrikaHesapOzetleri: () => {
            app.dom.fabrikaHesapTabloContainer.innerHTML = '';
            if (app.data.fabrikalar.length === 0) { app.dom.fabrikaHesapTabloContainer.innerHTML = '<p class="no-data-message">Lütfen önce bir fabrika ekleyin.</p>'; return; }
            const table = document.createElement('table'); table.innerHTML = '<thead><tr><th>Fabrika Adı</th><th>Toplam Üretim</th><th>Toplam Ödenen</th><th>Kalan Borç</th><th>İşlemler</th></tr></thead><tbody></tbody>';
            const tbody = table.querySelector('tbody');
            app.data.fabrikalar.forEach(fabrika => {
                const bakiye = calculator.fabrikaBakiyesi(fabrika.id);
                tbody.insertRow().innerHTML = `<td>${fabrika.ad}</td><td>${app.helpers.formatCurrency(bakiye.toplamUretim)}</td><td>${app.helpers.formatCurrency(bakiye.toplamOdenen)}</td><td style="font-weight:bold; color: ${bakiye.kalanBorc > 0 ? 'var(--danger-color)' : 'var(--success-color)'}">${app.helpers.formatCurrency(bakiye.kalanBorc)}</td><td><button class="btn btn-success odeme-al-btn" data-id="${fabrika.id}" data-name="${fabrika.ad}">Ödeme</button> <button class="btn btn-secondary fabrika-csv-btn" data-id="${fabrika.id}" data-name="${fabrika.ad}">Rapor</button> <button class="btn btn-warning reset-hesap-btn" data-id="${fabrika.id}" data-name="${fabrika.ad}">Hesabı Sıfırla</button></td>`;
            });
            app.dom.fabrikaHesapTabloContainer.appendChild(table);
        },
        updateCardValues: (elements, durum) => { elements.gelir.textContent = app.helpers.formatCurrency(durum.toplamUretimDegeri); elements.gider.textContent = app.helpers.formatCurrency(durum.toplamGiderler); elements.alacak.textContent = app.helpers.formatCurrency(durum.kalanAlacak); elements.kar.textContent = app.helpers.formatCurrency(durum.netKar); elements.kar.className = 'value'; if (durum.netKar > 0) elements.kar.classList.add('profit'); if (durum.netKar < 0) elements.kar.classList.add('loss'); },
        dashboard: () => { const durum = calculator.genelDurum(); const elements = { gelir: document.getElementById('dashboard-gelir'), gider: document.getElementById('dashboard-gider'), kar: document.getElementById('dashboard-kar'), alacak: document.getElementById('dashboard-alacak') }; renderer.updateCardValues(elements, durum); renderer.nakitAkisChart(); },
        raporlarOzeti: () => { const durum = calculator.genelDurum(); const elements = { gelir: document.getElementById('rapor-gelir'), gider: document.getElementById('rapor-gider'), kar: document.getElementById('rapor-kar'), alacak: document.getElementById('rapor-alacak') }; renderer.updateCardValues(elements, durum); },
        nakitAkisChart: () => { const ctx = document.getElementById('nakitAkisChart').getContext('2d'); const etiketler = [], tahsilatlar = [], giderler = [], simdi = new Date(); for (let i = 5; i >= 0; i--) { const tarih = new Date(simdi.getFullYear(), simdi.getMonth() - i, 1); etiketler.push(tarih.toLocaleString('tr-TR', { month: 'long' })); const ayFiltre = item => { const it = new Date(item.tarih); return it.getFullYear() === tarih.getFullYear() && it.getMonth() === tarih.getMonth(); }; tahsilatlar.push(app.data.odemeler.filter(ayFiltre).reduce((sum, o) => sum + o.tutar, 0)); giderler.push(app.data.giderler.filter(ayFiltre).reduce((sum, g) => sum + g.tutar, 0)); } if (app.charts.nakitAkis) app.charts.nakitAkis.destroy(); app.charts.nakitAkis = new Chart(ctx, { type: 'bar', data: { labels: etiketler, datasets: [{ label: 'Tahsilatlar', data: tahsilatlar, backgroundColor: 'var(--success-color)' }, { label: 'Giderler', data: giderler, backgroundColor: 'var(--danger-color)' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: value => app.helpers.formatCurrency(value) } } } } }); },
        // renderer nesnesinin içindeki uretimEkleListesi fonksiyonunu bununla değiştir:
// renderer nesnesinin içine yapıştır (Eskisini sil)
uretimEkleListesi: () => {
    app.dom.kayitListesiContainer.innerHTML = '';
    const list = app.temp.uretimListesi;
    
    if (list.length === 0) { 
        app.dom.kayitListesiContainer.innerHTML = '<p class="no-data-message">Kaydedilecek bir kalem bulunmuyor.</p>'; 
        app.dom.kayitListesiGenelToplam.textContent = 'Genel Toplam: 0,00 ₺'; 
        return; 
    }

    const table = document.createElement('table'); 
    table.id = "kayit-listesi-tablosu"; 
    // Tablo başlıklarına KDV sütunu eklendi
    table.innerHTML = '<thead><tr><th>Fabrika</th><th>Tarih</th><th>Açıklama</th><th>Adet</th><th style="color:#e67e22">Maliyet</th><th style="color:#8e44ad">KDV</th><th>Satış Fiyatı</th><th>Toplam Satış</th><th>İşlem</th></tr></thead><tbody></tbody>';
    const tbody = table.querySelector('tbody');
    
    let genelToplam = 0;
    list.forEach((item, index) => {
        const fabrika = app.data.fabrikalar.find(f => f.id === item.fabrikaId); 
        const toplamSatis = item.adet * item.birimFiyat; 
        
        // KDV Tutarı Hesaplama (Bilgi amaçlı gösterim)
        const kdvTutari = toplamSatis * (item.kdvOrani / 100);

        genelToplam += toplamSatis;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${fabrika ? fabrika.ad : 'Bilinmeyen'}</td>
            <td>${new Date(item.tarih).toLocaleDateString('tr-TR')}</td>
            <td>${item.aciklama}</td>
            <td>${item.adet}</td>
            <td style="color:#e67e22;">${app.helpers.formatCurrency(item.birimMaliyet || 0)}</td>
            <td style="color:#8e44ad; font-weight:bold;">%${item.kdvOrani} <br><small>(${app.helpers.formatCurrency(kdvTutari)})</small></td>
            <td>${app.helpers.formatCurrency(item.birimFiyat)}</td>
            <td style="font-weight:bold;">${app.helpers.formatCurrency(toplamSatis)}</td>
            <td><button class="btn-sm-danger temp-sil-btn" data-index="${index}">Sil</button></td>
        `;
    });
    
    app.dom.kayitListesiContainer.appendChild(table); 
    app.dom.kayitListesiGenelToplam.textContent = `Toplam Ciro: ${app.helpers.formatCurrency(genelToplam)}`;
},

        sonUretimler: () => {
            app.dom.sonUretimlerContainer.innerHTML = '';
            const sonBes = [...app.data.uretimler].sort((a,b) => b.id - a.id).slice(0, 5);
            if (sonBes.length === 0) { app.dom.sonUretimlerContainer.innerHTML = '<p class="no-data-message">Henüz kaydedilmiş bir üretim bulunmuyor.</p>'; return; }
            const table = document.createElement('table'); table.innerHTML = '<thead><tr><th>Fabrika</th><th>Tarih</th><th>Açıklama</th><th>Toplam Tutar</th><th>İşlem</th></tr></thead><tbody></tbody>';
            const tbody = table.querySelector('tbody');
            const silmeButonuHtml = app.currentUser && app.currentUser.role === 'admin' 
                ? `<button class="btn-sm-danger uretim-sil-btn" data-id="{id}">Sil</button>` : ``;
            sonBes.forEach(item => {
                const fabrika = app.data.fabrikalar.find(f => f.id === item.fabrikaId); const toplam = item.adet * item.birimFiyat;
                tbody.insertRow().innerHTML = `<td>${fabrika ? fabrika.ad : 'Bilinmeyen'}</td><td>${new Date(item.tarih).toLocaleDateString('tr-TR')}</td><td>${item.aciklama} (${item.adet} adet)</td><td>${app.helpers.formatCurrency(toplam)}</td><td>${silmeButonuHtml.replace('{id}', item.id)}</td>`;
            });
            app.dom.sonUretimlerContainer.appendChild(table);
        },
        // Yeni: Personel Durumu tablosu
        // renderer nesnesinin içine yapıştırın (Eskisini silin)
// renderer nesnesinin içine yapıştır (Eskisini sil)
// renderer nesnesinin içine yapıştır (Eskisini sil)
// renderer nesnesinin içine yapıştırın (Eskisini silin)
personelDurumu: () => {
    const container = app.dom.personelDurumuContainer;
    if (!container) return;
    container.innerHTML = '';
    
    const personeller = app.data.personel.sort((a,b) => a.ad.localeCompare(b.ad));
    if (personeller.length === 0) {
        container.innerHTML = '<p class="no-data-message">Henüz personel kaydı yok.</p>';
        return;
    }

    const today = new Date();
    let days = [];
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - 29); 
    const endDate = new Date(today);
    endDate.setDate(today.getDate() + 7); 

    const current = new Date(startDate);
    while (current <= endDate) {
        days.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
    }

    const table = document.createElement('table');
    table.className = 'attendance-table';
    let theadHtml = '<thead><tr><th style="background:#2c3e50; color:white; position:sticky; left:0; z-index:2;">Personel</th>';
    
    days.forEach(d => {
        const dt = new Date(d);
        const gunIsmi = dt.toLocaleDateString('tr-TR', { weekday: 'short' });
        const gunNo = dt.getDate();
        const ayNo = dt.getMonth() + 1;
        const isWeekend = (dt.getDay() === 0 || dt.getDay() === 6);
        const thStyle = isWeekend ? 'background-color:#ffe0b2;' : '';
        theadHtml += `<th style="${thStyle} min-width:60px; font-size:11px;">${gunNo}/${ayNo}<br>${gunIsmi}</th>`;
    });
    theadHtml += '</tr></thead>';

    let tbodyHtml = '<tbody>';
    personeller.forEach(p => {
        tbodyHtml += `<tr><td style="background:#f8f9fa; font-weight:bold; position:sticky; left:0; z-index:1; border-right:2px solid #ddd;">${p.ad}</td>`;
        
        days.forEach(d => {
            const entry = p.attendance ? p.attendance[d] : undefined;
            let cellHtml = '<span style="color:#ddd; font-size:18px;">•</span>';
            let cellStyle = 'cursor:pointer; transition:all 0.2s; text-align:center; vertical-align:middle;';
            let title = 'Veri Girmek İçin Tıklayın';

            if (entry) {
                if (entry.status === 'present') {
                    // Sadece 'present' durumunda saat kontrolü yap
                    const calisilanSaat = entry.hours !== null ? parseFloat(entry.hours) : 9;
                    
                    if (calisilanSaat >= 9) {
                        cellHtml = `<div style="color:#27ae60; font-weight:bold; font-size:12px;">✔ ${calisilanSaat}s</div>`;
                        cellStyle += 'background-color:#e8f8f5;';
                    } else {
                        const eksik = (9 - calisilanSaat).toFixed(1);
                        cellHtml = `
                            <div style="color:#d35400; font-weight:bold; font-size:12px;">⚠️ ${calisilanSaat}s</div>
                            <div style="color:red; font-size:10px; font-weight:bold;">(-${eksik})</div>
                        `;
                        cellStyle += 'background-color:#fdebd0;';
                        title = `Eksik Çalışma: ${eksik} saat`;
                    }

                } else if (entry.status === 'weekly') {
                    // SARI İZİN: Sadece 'İZİN' yaz, hesaplama yapma
                    cellHtml = '<span style="color:#f39c12; font-weight:bold; font-size:11px;">İZİN</span>';
                    cellStyle += 'background-color:#fcf3cf;';
                } else if (entry.status === 'izin') {
                    // MOR RAPOR: Sadece 'RAPOR' yaz, hesaplama yapma
                    cellHtml = '<span style="color:#8e44ad; font-weight:bold; font-size:11px;">RAPOR</span>';
                    cellStyle += 'background-color:#f4ecf7;';
                } else if (entry.status === 'devamsiz') {
                    // KIRMIZI DEVAMSIZ
                    cellHtml = '<span style="color:white; font-weight:bold; font-size:11px;">YOK</span>';
                    cellStyle += 'background-color:#c0392b;';
                    title = 'Devamsız (-9 Saat)';
                } else if (entry.status === 'yillik_izin') {
                    cellHtml = '<span style="color:white; font-weight:bold; font-size:11px;">Y.İZİN</span>';
                    cellStyle += 'background-color:#2980b9;';
                }
            }

            tbodyHtml += `<td style="${cellStyle}" onclick="actions.openAttendanceModal(${p.id}, '${d}')" title="${title}">${cellHtml}</td>`;
        });
        tbodyHtml += '</tr>';
    });
    tbodyHtml += '</tbody>';
    
    table.innerHTML = theadHtml + tbodyHtml;
    container.appendChild(table);
},
/**
         * Haftalık izin planlama formundaki personel select'ini doldurur.
         * Sadece aktif durumdaki personeller listelenir.
         */
        populateIzinPersonelSelect: () => {
            const select = app.dom.izinPersonelSelect;
            if (!select) return;
            // Mevcut seçenekleri temizle ve doldur
            const aktifPersoneller = app.data.personel.filter(p => p.durum === 'Aktif').sort((a, b) => a.ad.localeCompare(b.ad));
            if (aktifPersoneller.length === 0) {
                select.innerHTML = '<option value="" disabled selected>Aktif personel yok</option>';
                return;
            }
            // Varsayılan seçeneği ve aktif personelleri ekle
            const options = [];
            options.push('<option value="" disabled selected>Personel Seçin...</option>');
            aktifPersoneller.forEach(p => {
                options.push(`<option value="${p.id}">${p.ad}</option>`);
            });
            select.innerHTML = options.join('');
        },
        // renderer nesnesinin içine ekleyin:

stokListesi: () => {
    const container = document.getElementById('stok-tablo-container');
    if (!container) return;
    
    // Arama filtresi
    const aramaMetni = document.getElementById('stok-ara') ? document.getElementById('stok-ara').value.toLowerCase() : '';
    
    // Veri yoksa uyar
    if (!app.data.stoklar) app.data.stoklar = [];
    let stoklar = app.data.stoklar.filter(s => s.ad.toLowerCase().includes(aramaMetni));

    if (stoklar.length === 0) {
        container.innerHTML = '<p class="no-data-message">Kayıtlı stok bulunamadı.</p>';
        renderer.stokOzet(); // Kartları sıfırla
        return;
    }

    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Ürün Adı</th>
                <th>Kategori</th>
                <th>Miktar / Birim</th>
                <th>Ort. Birim Fiyat</th>
                <th>Toplam Değer</th>
                <th>Durum</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    
    stoklar.sort((a,b) => a.ad.localeCompare(b.ad)).forEach(s => {
        const toplamDeger = (s.miktar * (s.alisFiyati || 0));
        let durumHtml = '<span class="status-badge status-Active">Normal</span>';
        let rowStyle = '';
        
        // Kritik seviye kontrolü
        if (parseFloat(s.miktar) <= parseFloat(s.kritikSeviye)) {
            durumHtml = '<span class="status-badge status-Suspended">KRİTİK</span>';
            rowStyle = 'background-color: #fff0f0;';
        }

        tbody.insertRow().innerHTML = `
            <tr style="${rowStyle}">
                <td style="font-weight:bold;">${s.ad}</td>
                <td>${s.kategori}</td>
                <td style="font-size:16px;">${parseFloat(s.miktar).toFixed(2)} <small>${s.birim}</small></td>
                <td>${app.helpers.formatCurrency(s.alisFiyati || 0)}</td>
                <td>${app.helpers.formatCurrency(toplamDeger)}</td>
                <td>${durumHtml}</td>
                <td>
                    <button class="btn-sm-success stok-giris-btn" data-id="${s.id}">+ Giriş</button>
                    <button class="btn-sm-warning stok-cikis-btn" data-id="${s.id}">- Çıkış</button>
                    <button class="btn-sm-danger stok-sil-btn" data-id="${s.id}">Sil</button>
                </td>
            </tr>
        `;
    });
    
    container.innerHTML = '';
    container.appendChild(table);
    
    // Özet kartları güncelle
    renderer.stokOzet();
},

stokOzet: () => {
    if (!app.data.stoklar) return;
    
    const toplamKalem = app.data.stoklar.length;
    const kritikSayi = app.data.stoklar.filter(s => parseFloat(s.miktar) <= parseFloat(s.kritikSeviye)).length;
    const toplamDeger = app.data.stoklar.reduce((acc, s) => acc + (s.miktar * (s.alisFiyati || 0)), 0);
    
    const elKalem = document.getElementById('stok-toplam-kalem');
    const elKritik = document.getElementById('stok-kritik-sayi');
    const elDeger = document.getElementById('stok-toplam-deger');
    
    if (elKalem) elKalem.innerText = toplamKalem;
    if (elKritik) elKritik.innerText = kritikSayi;
    if (elDeger) elDeger.innerText = app.helpers.formatCurrency(toplamDeger);
}
    };

    // renderer objesinin içine ekleyin:
        stokGecmisi: () => {
            const container = document.getElementById('stok-gecmisi-container');
            if (!container) return;

            // Veri yoksa boş array oluştur
            if (!app.data.stokHareketleri) app.data.stokHareketleri = [];
            
            // Arama metni
            const aramaInput = document.getElementById('stok-gecmisi-ara');
            const aramaMetni = aramaInput ? aramaInput.value.toLowerCase() : '';

            // Filtreleme ve Sıralama (En yeniden eskiye)
            const history = app.data.stokHareketleri.filter(item => 
                (item.urunAdi && item.urunAdi.toLowerCase().includes(aramaMetni)) ||
                (item.aciklama && item.aciklama.toLowerCase().includes(aramaMetni))
            ).sort((a, b) => new Date(b.tarih) - new Date(a.tarih)).slice(0, 50); // Son 50 kayıt

            if (history.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">Henüz işlem kaydı yok.</div>';
                return;
            }

            const table = document.createElement('table');
            table.style.fontSize = '13px';
            table.innerHTML = `
                <thead style="background:#f1f2f6;">
                    <tr>
                        <th style="padding:10px;">Tarih</th>
                        <th style="padding:10px;">Ürün</th>
                        <th style="padding:10px;">İşlem</th>
                        <th style="padding:10px;">Miktar</th>
                        <th style="padding:10px;">Açıklama</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            history.forEach(item => {
                const isGiris = item.tip === 'giris';
                // Renk ve Stil Ayarları
                const rowBg = isGiris ? '#f0fdf4' : '#fef2f2'; // Giriş için açık yeşil, Çıkış için açık kırmızı arka plan
                const icon = isGiris ? 'fa-arrow-down' : 'fa-arrow-up';
                const badgeStyle = isGiris 
                    ? 'background:#dcfce7; color:#166534; padding:3px 8px; border-radius:12px; font-weight:bold; font-size:11px;' 
                    : 'background:#fee2e2; color:#991b1b; padding:3px 8px; border-radius:12px; font-weight:bold; font-size:11px;';
                
                const tipYazisi = isGiris ? '⬇ GİRİŞ' : '⬆ ÇIKIŞ';
                const miktarRenk = isGiris ? '#166534' : '#991b1b';
                const tarihStr = new Date(item.tarih).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour:'2-digit', minute:'2-digit' });

                tbody.insertRow().innerHTML = `
                    <td style="padding:10px; color:#666;">${tarihStr}</td>
                    <td style="padding:10px; font-weight:600;">${item.urunAdi}</td>
                    <td style="padding:10px;"><span style="${badgeStyle}">${tipYazisi}</span></td>
                    <td style="padding:10px; font-weight:bold; color:${miktarRenk}; font-size:14px;">
                        ${isGiris ? '+' : '-'}${item.miktar}
                    </td>
                    <td style="padding:10px; color:#555;">${item.aciklama || '-'}</td>
                `;
            });

            container.innerHTML = '';
            container.appendChild(table);
        }
    // --- BÖLÜM 5: AKSİYONLAR VE İŞ MANTIĞI ---
    const actions = {
        setup: async (e) => {
            e.preventDefault();
            const username = app.dom.setupForm.querySelector('#setup-username').value.trim();
            const newPass = app.dom.setupForm.querySelector('#setup-pass').value;
            const confirmPass = app.dom.setupForm.querySelector('#setup-pass-onay').value;
            const errorMsg = app.dom.setupError;
            errorMsg.textContent = '';
            if (!username) {
                errorMsg.textContent = 'Kullanıcı adı boş olamaz.';
                return;
            }
            if (newPass.length < 4) {
                errorMsg.textContent = 'Şifre en az 4 karakter olmalıdır.';
                return;
            }
            if (newPass !== confirmPass) {
                errorMsg.textContent = 'Şifreler eşleşmiyor!';
                return;
            }
            // Kullanıcı adı zaten kullanılıyor mu?
            if (app.data.personel.some(p => p.kullaniciAdi && p.kullaniciAdi.toLowerCase() === username.toLowerCase())) {
                errorMsg.textContent = 'Bu kullanıcı adı zaten kullanılıyor.';
                return;
            }
            const newHash = await app.helpers.hash(newPass);
            // Yönetici pozisyonu bul veya oluştur
            let yoneticiPos = app.data.pozisyonlar.find(pos => pos.ad && pos.ad.toLowerCase() === 'yönetici');
            if (!yoneticiPos) {
                yoneticiPos = { id: Date.now(), ad: 'Yönetici' };
                app.data.pozisyonlar.push(yoneticiPos);
            }
            // Yeni yönetici personeli oluştur
            const newId = Date.now();
            const newAdmin = {
                id: newId,
                ad: username,
                telefon: '',
                iseAlimTarihi: app.helpers.getTodayISO(),
                pozisyonId: yoneticiPos.id,
                netMaas: 0,
                brutMaas: 0,
                maasTipi: 'Aylık',
                durum: 'Aktif',
                kullaniciAdi: username,
                sifre: newHash,
                sgkDurumu: 'Yok',
                sgkTutar: 0,
                attendance: {}
            };
            app.data.personel.push(newAdmin);
            dataManager.save();
            // Clear any stored admin hash so migration does not recreate default admin
            try {
                localStorage.setItem('fabrikaYonetimAuth_v2_hash', '');
            } catch (e) {}
            // Oturum aç ve devam et
            app.currentUser = { id: newAdmin.id, ad: newAdmin.ad, role: 'admin' };
            app.dom.setupContainer.style.display = 'none';
            app.dom.appContainer.style.display = 'flex';
            main.runAfterLogin();
        },
        adminLogin: async (e) => { 
            e.preventDefault();
            const username = app.dom.adminUsernameInput ? app.dom.adminUsernameInput.value.trim() : '';
            const password = app.dom.adminPasswordInput ? app.dom.adminPasswordInput.value : '';
            const loginError = app.dom.adminLoginError;
            loginError.textContent = '';
            // Kullanıcı adı ve şifre zorunlu
            if (!username || !password) {
                loginError.textContent = 'Lütfen kullanıcı adı ve şifrenizi girin.';
                return;
            }
            const inputHash = await app.helpers.hash(password);
            const personel = app.data.personel.find(p => p.kullaniciAdi && p.kullaniciAdi.toLowerCase() === username.toLowerCase());
            if (personel && personel.sifre === inputHash) {
                // Kullanıcının yönetici pozisyonunda olup olmadığını kontrol et
                const pos = app.data.pozisyonlar.find(pos => pos.id === personel.pozisyonId);
                const isAdminPos = pos && pos.ad && pos.ad.toLowerCase() === 'yönetici';
                if (!isAdminPos) {
                    loginError.textContent = 'Bu kullanıcı yönetici değildir.';
                    return;
                }
                if (personel.durum !== 'Aktif') {
                    loginError.textContent = 'Hesabınız aktif değil. Yönetici ile görüşün.';
                    return;
                }
                // Başarılı yönetici girişi
                app.currentUser = { id: personel.id, ad: personel.ad, role: 'admin' };
                app.dom.adminLoginContainer.style.display = 'none';
                app.dom.appContainer.style.display = 'flex';
                main.runAfterLogin();
                return;
            }
            loginError.textContent = 'Kullanıcı adı veya şifre hatalı!';
        },

        personelLogin: async (e) => {
            e.preventDefault(); 
            const username = app.dom.personelLoginForm.querySelector('#personel-username').value.trim();
            const password = app.dom.personelLoginForm.querySelector('#personel-password').value;
            const loginError = app.dom.personelLoginError;
            loginError.textContent = '';
            const inputHash = await app.helpers.hash(password);
            const personel = app.data.personel.find(p => p.kullaniciAdi.toLowerCase() === username.toLowerCase());
            if (personel && personel.sifre === inputHash) {
                if(personel.durum !== 'Aktif') { loginError.textContent = 'Hesabınız aktif değil. Yönetici ile görüşün.'; return; }
                app.currentUser = { id: personel.id, ad: personel.ad, role: 'isci' };
                app.dom.personelLoginContainer.style.display = 'none';
                app.dom.appContainer.style.display = 'flex';
                main.runAfterLogin();
                return;
            }
            loginError.textContent = 'Kullanıcı adı veya şifre hatalı!';
        },
        changePassword: async (e) => { e.preventDefault(); const form = app.dom.sifreDegistirForm; const currentPass = form.querySelector('#mevcut-sifre').value; const newPass = form.querySelector('#yeni-sifre').value; const confirmPass = form.querySelector('#yeni-sifre-onay').value; const resultMsg = app.dom.sifreDegistirSonuc; resultMsg.textContent = ''; resultMsg.style.color = 'var(--danger-color)'; const storedHash = dataManager.loadAuthHash(); const currentHash = await app.helpers.hash(currentPass); if (currentHash !== storedHash) { resultMsg.textContent = 'Mevcut Yönetici şifreniz hatalı!'; return; } if (newPass.length < 4) { resultMsg.textContent = 'Yeni şifre en az 4 karakter olmalıdır.'; return; } if (newPass !== confirmPass) { resultMsg.textContent = 'Yeni şifreler eşleşmiyor!'; return; } const newHash = await app.helpers.hash(newPass); dataManager.saveAuthHash(newHash); resultMsg.style.color = 'var(--success-color)'; resultMsg.textContent = 'Yönetici şifreniz başarıyla güncellendi!'; form.reset(); },
        logout: () => { if(confirm("Çıkış yapmak istediğinizden emin misiniz?")) { app.currentUser = null; window.location.reload(); } },
        navigate: (e, forcePageId = null) => {
            if (e) e.preventDefault();
            const pageId = forcePageId || e.currentTarget.dataset.page;
            if (app.currentUser.role === 'isci') { 
        const allowedPages = ['vardiya-yonetimi']; 
        if (!allowedPages.includes(pageId)) { return; } 
    }
            app.dom.navLinks.forEach(l => l.classList.remove('active'));
            app.dom.pages.forEach(p => p.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
            const activePage = document.getElementById(pageId);
            if(activeLink) { activeLink.classList.add('active'); app.dom.pageTitle.textContent = activeLink.textContent.trim(); }
            if(activePage) { activePage.classList.add('active'); }
            // Özel sayfa güncellemeleri
            if (pageId === 'personel-durumu') {
                renderer.personelDurumu();
            }
        },
        // Yeni: vardiya başlangıcı çoklu personel destekler
        startShift: (e) => {
            e.preventDefault();
            const select = app.dom.vardiyaPersonelSelect;
            const selectedOptions = Array.from(select.selectedOptions).filter(opt => opt.value);
            if (selectedOptions.length === 0) { alert('Vardiyayı başlatmak için lütfen bir veya daha fazla personel seçin.'); return; }
            // Eğer işçi rolünde ise, sadece kendisini seçebilir
            if(app.currentUser.role === 'isci' && selectedOptions.some(opt => parseInt(opt.value) !== app.currentUser.id)) { alert('İşçi olarak sadece kendi adınıza vardiya başlatabilirsiniz.'); return; }
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (activeShift) { alert('Zaten aktif bir vardiya bulunmaktadır. Önce onu kapatmalı veya devretmelisiniz.'); return; }
            const nowISO = new Date().toISOString();
            const calisanlar = selectedOptions.map(opt => {
                const pid = parseInt(opt.value);
                return { isciAdi: opt.text, personelId: pid, devralmaZamani: nowISO, hoursRecorded: false };
            });
            // İlk seçilen kişi vardiya sorumlusu olur
            const responsibleId = parseInt(selectedOptions[0].value);
            // Vardiya oluştur
            const newShift = {
                id: Date.now(),
                baslamaZamani: nowISO,
                bitisZamani: null,
                durum: 'Aktif',
                calisanlar: calisanlar,
                responsibleId: responsibleId
            };
            app.data.vardiyalar.push(newShift);
            // Attendance kaydet
            const today = app.helpers.getTodayISO();
            calisanlar.forEach(c => {
                const person = app.data.personel.find(p => p.id === c.personelId);
                if (person) {
                    if (!person.attendance[today]) {
                        person.attendance[today] = { status: 'present', hours: null };
                    } else {
                        person.attendance[today].status = 'present';
                    }
                }
            });
            dataManager.save();
            renderer.updateAll();
            app.dom.yeniVardiyaForm.reset();
        },
        endShift: () => {
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (!activeShift) { alert('Kapatılacak aktif bir vardiya bulunamadı.'); return; }
            const onay = confirm('Aktif vardiyayı tamamen sonlandırmak istediğinizden emin misiniz?');
            if (!onay) return;
            const nowISO = new Date().toISOString();
            // bitisZamani tüm aktif çalışanlar için ekle
            activeShift.calisanlar.forEach(c => {
                if (!c.bitisZamani) {
                    c.bitisZamani = nowISO;
                }
            });
            // Çalışanların çalışma saatlerini hesapla ve kaydet
            activeShift.calisanlar.forEach(c => {
                if (!c.hoursRecorded) {
                    const person = app.data.personel.find(p => p.id === c.personelId);
                    if (person) {
                        const startISO = c.devralmaZamani;
                        const endISO = c.bitisZamani;
                        const hoursDec = app.helpers.calculateHoursDecimal(startISO, endISO);
                        const dateKey = app.helpers.getTodayISO();
                        if (!person.attendance[dateKey]) {
                            person.attendance[dateKey] = { status: 'present', hours: hoursDec };
                        } else {
                            const entry = person.attendance[dateKey];
                            entry.status = 'present';
                            if (entry.hours === null || entry.hours === undefined) entry.hours = 0;
                            entry.hours = parseFloat((entry.hours + hoursDec).toFixed(2));
                        }
                    }
                    c.hoursRecorded = true;
                }
            });
            activeShift.bitisZamani = nowISO;
            activeShift.durum = 'Tamamlandı';
            dataManager.save();
            renderer.updateAll();
        },
        transferShift: () => {
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (!activeShift) { alert('Devredilecek aktif bir vardiya bulunamadı.'); return; }
            // Mevcut sorumlu personeli bul
            let responsibleId = activeShift.responsibleId;
            // Eğer sorumlu belirtilmemişse ilk aktif çalışanı sorumlu olarak kabul et
            const aktifCalisanlar = activeShift.calisanlar.filter(c => !c.bitisZamani);
            if (responsibleId === undefined || responsibleId === null) {
                responsibleId = aktifCalisanlar.length > 0 ? aktifCalisanlar[0].personelId : null;
            }
            const currentResponsible = app.data.personel.find(p => p.id === responsibleId);
            if (!currentResponsible) { alert('Aktif vardiya sorumlusu bulunamadı.'); return; }
            // İşçi rolünde sadece kendi vardiyasını devredebilir
            if (app.currentUser.role === 'isci' && currentResponsible.id !== app.currentUser.id) { alert('Sadece kendi aktif vardiyanızı devredebilirsiniz.'); return; }
            // Devredilecek kişi listesi: Aktif olan ve mevcut sorumlu olmayan personeller
            const devirListesi = app.data.personel.filter(p => p.durum === 'Aktif' && p.id !== currentResponsible.id).sort((a, b) => a.ad.localeCompare(b.ad));
            let optionsHtml = '<option value="" disabled selected>Devredilecek personeli seçin...</option>';
            if (devirListesi.length === 0) {
                optionsHtml = '<option value="" disabled>Devredilecek başka "Aktif" personel bulunmuyor.</option>';
            } else {
                devirListesi.forEach(p => {
                    optionsHtml += `<option value="${p.id}">${p.ad}</option>`;
                });
            }
            const formHtml = `
                <p style="margin-bottom: 20px;">Mevcut vardiya sorumlusu: <strong>${currentResponsible.ad}</strong><br>Vardiyayı kime devretmek istiyorsunuz?</p>
                <form id="vardiya-devir-form">
                    <div class="input-group"><label for="vardiya-devir-select">Yeni Personel</label><select id="vardiya-devir-select" required>${optionsHtml}</select></div>
                    <button type="submit" class="btn btn-success btn-full">Vardiyayı Devret</button>
                </form>
            `;
            actions.openModal('Vardiya Devret', formHtml);
            document.getElementById('vardiya-devir-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const selectEl = document.getElementById('vardiya-devir-select');
                const selectedOption = selectEl.options[selectEl.selectedIndex];
                if (!selectedOption || selectedOption.value === "") { alert('Lütfen bir personel seçin.'); return; }
                const yeniPersonelId = parseInt(selectedOption.value);
                const yeniIsciAdi = selectedOption.text;
                if (confirm(`'${currentResponsible.ad}' vardiyasını '${yeniIsciAdi}' adlı çalışana devretmek üzeresiniz. Onaylıyor musunuz?`)) {
                    // Yeni sorumlu olarak ata
                    activeShift.responsibleId = yeniPersonelId;
                    // Seçilen kişi aktif değilse, aktif vardiyaya ekle
                    const alreadyActive = aktifCalisanlar.some(c => c.personelId === yeniPersonelId && !c.bitisZamani);
                    if (!alreadyActive) {
                        actions.addWorkerToActiveShift(yeniPersonelId);
                    }
                    // Attendance kaydı addWorkerToActiveShift fonksiyonunda yapılıyor
                    dataManager.save();
                    actions.closeModal();
                    renderer.updateAll();
                    alert('Vardiya başarıyla devredildi.');
                }
            });
        },
        // Yeni: aktif vardiyaya personel ekleme/çıkarma yöneticisi
        // actions nesnesinin içine ekleyin:

// actions nesnesinin içine ekleyin/güncelleyin:

// 1. Güncellenmiş Modal (Devamsızlık Seçeneği Eklendi)
openAttendanceModal: (personelId, date) => {
    if (app.currentUser && app.currentUser.role !== 'admin') return;

    const person = app.data.personel.find(p => p.id === personelId);
    if (!person) return;

    const entry = person.attendance && person.attendance[date] ? person.attendance[date] : { status: '', hours: 9 };
    const durum = entry.status || 'bos';
    const tarihFormat = new Date(date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });

    const html = `
        <div style="text-align:center; margin-bottom:20px;">
            <h3 style="color:#2c3e50;">${person.ad}</h3>
            <p style="color:#7f8c8d;">${tarihFormat}</p>
        </div>
        <form id="attendance-form">
            <input type="hidden" id="att-person-id" value="${personelId}">
            <input type="hidden" id="att-date" value="${date}">

            <div class="input-group">
                <label>Günün Durumu</label>
                <select id="att-status" onchange="actions.toggleHourInput()" style="padding:10px; font-size:16px; width:100%;">
                    <option value="present" ${durum === 'present' ? 'selected' : ''}>✅ Çalıştı (Geldi)</option>
                    <option value="weekly" ${durum === 'weekly' ? 'selected' : ''}>📅 Haftalık İzin</option>
                    <option value="izin" ${durum === 'izin' ? 'selected' : ''}>💊 Raporlu / Mazeretli</option>
                    <option value="devamsiz" ${durum === 'devamsiz' ? 'selected' : ''}>🟥 Raporsuz / Mazeretsiz (Devamsız)</option>
                    <option value="yillik_izin" ${durum === 'yillik_izin' ? 'selected' : ''}>🏖️ Yıllık İzin</option>
                    <option value="delete" ${durum === 'bos' ? 'selected' : ''}>🗑️ Kaydı Sil</option>
                </select>
            </div>

            <div class="input-group" id="att-hours-group" style="display:${durum === 'present' ? 'block' : 'none'};">
                <label>Çalışılan Saat</label>
                <input type="number" id="att-hours" value="${entry.hours || 9}" step="0.5" class="form-control">
            </div>

            <button type="submit" class="btn btn-primary btn-full" style="margin-top:15px;">Kaydet</button>
        </form>
    `;

    actions.openModal('Günlük Kayıt', html);
    setTimeout(() => {
        document.getElementById('attendance-form').addEventListener('submit', actions.saveAttendanceManual);
    }, 100);
},

// 2. YENİ: Toplu Yıllık İzin Modalı
openAnnualLeaveModal: () => {
    // Personel Listesi
    const personeller = app.data.personel.filter(p => p.durum === 'Aktif').sort((a,b) => a.ad.localeCompare(b.ad));
    let options = personeller.map(p => `<option value="${p.id}">${p.ad}</option>`).join('');

    const html = `
        <div class="alert alert-info" style="background:#e8f8f5; color:#0e6251; padding:10px; border-radius:5px; margin-bottom:15px;">
            Seçilen tarih aralığındaki tüm günlere "Yıllık İzin" kaydı işlenecektir.
        </div>
        <form id="annual-leave-form">
            <div class="input-group">
                <label>Personel Seçin</label>
                <select id="al-person" required style="width:100%; padding:10px;">${options}</select>
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="input-group">
                    <label>Başlangıç Tarihi</label>
                    <input type="date" id="al-start" required>
                </div>
                <div class="input-group">
                    <label>Bitiş Tarihi (Dahil)</label>
                    <input type="date" id="al-end" required>
                </div>
            </div>
            <button type="submit" class="btn btn-success btn-full">İzinleri İşle</button>
        </form>
    `;

    actions.openModal('Toplu Yıllık İzin Girişi', html);
    setTimeout(() => {
        document.getElementById('annual-leave-form').addEventListener('submit', actions.saveAnnualLeave);
    }, 100);
},


// 3. YENİ: Yıllık İzin Kaydetme Mantığı
saveAnnualLeave: (e) => {
    e.preventDefault();
    const pid = parseInt(document.getElementById('al-person').value);
    const startStr = document.getElementById('al-start').value;
    const endStr = document.getElementById('al-end').value;

    if (!startStr || !endStr) { alert('Tarihleri giriniz.'); return; }
    if (startStr > endStr) { alert('Başlangıç tarihi bitişten büyük olamaz.'); return; }

    const person = app.data.personel.find(p => p.id === pid);
    if (!person) return;
    if (!person.attendance) person.attendance = {};

    let current = new Date(startStr);
    const end = new Date(endStr);
    let count = 0;

    // Tarih aralığını döngüye al
    while (current <= end) {
        const dateKey = current.toISOString().split('T')[0];
        
        // Mevcut kaydı ez, Yıllık İzin yap
        person.attendance[dateKey] = { status: 'yillik_izin', hours: null };
        
        current.setDate(current.getDate() + 1);
        count++;
    }

    dataManager.save();
    actions.closeModal();
    renderer.personelDurumu();
    alert(`${person.ad} için ${count} günlük Yıllık İzin kaydedildi.`);
},
// actions nesnesinin içine ekleyin:

// actions nesnesinin içine yapıştırın (Eskisini silin)
showMissingHoursReport: () => {
    const personeller = app.data.personel;
    let raporData = [];

    // Hesaplama Aralığı: Son 30 Gün
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - 30); 

    personeller.forEach(p => {
        let toplamEksikSaat = 0;
        let eksikGunSayisi = 0;
        let devamsizlikSayisi = 0;

        if (p.attendance) {
            Object.keys(p.attendance).forEach(date => {
                const recordDate = new Date(date);
                
                // Sadece son 30 günü hesapla
                if (recordDate >= startDate && recordDate <= today) {
                    const entry = p.attendance[date];
                    
                    // --- HESAPLAMA MANTIĞI ---
                    
                    if (entry.status === 'present') {
                        // DURUM 1: GELDİ (Çalıştı)
                        // Saati al, eğer boşsa veya hatalıysa 9 kabul et (Eksik yok say)
                        let saat = 9;
                        if (entry.hours !== undefined && entry.hours !== null && entry.hours !== '') {
                            saat = parseFloat(entry.hours);
                        }
                        
                        // Eğer 9 saatten az çalıştıysa eksik yaz
                        if (saat < 9) {
                            toplamEksikSaat += (9 - saat);
                            eksikGunSayisi++;
                        }

                    } else if (entry.status === 'devamsiz') {
                        // DURUM 2: DEVAMSIZ (Kırmızı)
                        // Mazeretsiz gelmediği için tam gün (9 saat) ceza
                        toplamEksikSaat += 9;
                        devamsizlikSayisi++;
                    
                    } else if (entry.status === 'weekly' || entry.status === 'izin' || entry.status === 'yillik_izin') {
                        // DURUM 3: İZİNLER (Sarı, Mor, Mavi)
                        // BU GÜNLER KESİNLİKLE EKSİK SAYILMAZ!
                        // İşlem yapma, pas geç.
                    }
                }
            });
        }

        // Eğer eksik çalışma varsa listeye ekle
        if (toplamEksikSaat > 0) {
            raporData.push({
                ad: p.ad,
                eksikSaat: toplamEksikSaat,
                detay: `${eksikGunSayisi} gün erken çıkış, ${devamsizlikSayisi} gün devamsızlık.`
            });
        }
    });

    // Raporu Sırala (En çok eksiği olan en üstte)
    raporData.sort((a, b) => b.eksikSaat - a.eksikSaat);

    let html = `
        <div class="alert alert-warning" style="margin-bottom:15px; color:#856404; background-color:#fff3cd; border-color:#ffeeba; padding:10px;">
            <strong>Bilgi:</strong> Bu rapor son 30 günü kapsar. <br>
            Sadece <b>"Geldi (Eksik Saat)"</b> ve <b>"Devamsız (Kırmızı)"</b> durumları hesaplanır.<br>
            Haftalık İzin (Sarı) ve Raporlu (Mor) günler <u>hesaba katılmaz.</u>
        </div>
        <table class="table" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f39c12; color:white;">
                    <th style="padding:10px; text-align:left;">Personel</th>
                    <th style="padding:10px; text-align:center;">Toplam Eksik</th>
                    <th style="padding:10px; text-align:left;">Detay</th>
                </tr>
            </thead>
            <tbody>
    `;

    if (raporData.length === 0) {
        html += '<tr><td colspan="3" style="padding:20px; text-align:center; font-weight:bold; color:#27ae60;">Tebrikler! Son 30 günde eksik çalışan personel yok.</td></tr>';
    } else {
        raporData.forEach(r => {
            html += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:10px; font-weight:bold;">${r.ad}</td>
                    <td style="padding:10px; text-align:center; color:#c0392b; font-weight:bold; font-size:18px;">
                        -${r.eksikSaat.toFixed(1)} saat
                    </td>
                    <td style="padding:10px; font-size:13px; color:#555;">${r.detay}</td>
                </tr>
            `;
        });
    }

    html += '</tbody></table>';

    actions.openModal('⚠️ Eksik Çalışma Raporu', html);
},
toggleHourInput: () => {
    const status = document.getElementById('att-status').value;
    const group = document.getElementById('att-hours-group');
    if (status === 'present') {
        group.style.display = 'block';
    } else {
        group.style.display = 'none';
    }
},

saveAttendanceManual: (e) => {
    e.preventDefault();
    const pid = parseInt(document.getElementById('att-person-id').value);
    const date = document.getElementById('att-date').value;
    const status = document.getElementById('att-status').value;
    const hours = parseFloat(document.getElementById('att-hours').value);

    const person = app.data.personel.find(p => p.id === pid);
    if (!person) return;
    if (!person.attendance) person.attendance = {};

    if (status === 'delete') {
        delete person.attendance[date]; // Kaydı sil
    } else if (status === 'present') {
        // Saat doğrulaması
        if (isNaN(hours) || hours < 0) { alert('Lütfen geçerli bir saat girin.'); return; }
        person.attendance[date] = { status: 'present', hours: hours };
    } else {
        // İzin veya Rapor durumunda saat null olabilir veya 0 girilebilir
        person.attendance[date] = { status: status, hours: null };
    }

    dataManager.save();
    actions.closeModal();
    renderer.personelDurumu(); // Tabloyu yenile
    // alert('Kayıt güncellendi.'); // İsterseniz açabilirsiniz
},
        manageShiftPersonnel: () => {
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (!activeShift) { alert('Şu anda aktif vardiya bulunmuyor.'); return; }
            const activeIds = activeShift.calisanlar.filter(c => !c.bitisZamani).map(c => c.personelId);
            const aktifPersoneller = app.data.personel.filter(p => p.durum === 'Aktif').sort((a,b) => a.ad.localeCompare(b.ad));
            let formHtml = '<form id="shift-personnel-form">';
            formHtml += '<p style="margin-bottom:10px;">İşaretli personeller şu anda vardiyada olacaktır.</p>';
            aktifPersoneller.forEach(p => {
                const checked = activeIds.includes(p.id) ? 'checked' : '';
                formHtml += `<div class="checkbox-container"><input type="checkbox" id="chk_${p.id}" value="${p.id}" ${checked}><label for="chk_${p.id}">${p.ad}</label></div>`;
            });
            formHtml += '<button type="submit" class="btn btn-success btn-full">Kaydet</button></form>';
            actions.openModal('Vardiya Personel Yönetimi', formHtml, true);
            document.getElementById('shift-personnel-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const checkedIds = Array.from(e.target.querySelectorAll('input[type="checkbox"]:checked')).map(inp => parseInt(inp.value));
                // Eklenecek olanlar = checked but not active
                const toAdd = checkedIds.filter(id => !activeIds.includes(id));
                // Çıkarılacak olanlar = active but not checked
                const toRemove = activeIds.filter(id => !checkedIds.includes(id));
                toAdd.forEach(pid => {
                    actions.addWorkerToActiveShift(pid);
                });
                toRemove.forEach(pid => {
                    actions.removeWorkerFromActiveShift(pid);
                });
                // Sorumlu personel değişikliği: eğer sorumlu artık aktif değilse, ilk aktif kişiyi sorumlu yap
                const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
                if (activeShift) {
                    const activeIdsNow = activeShift.calisanlar.filter(c => !c.bitisZamani).map(c => c.personelId);
                    if (activeIdsNow.length > 0) {
                        if (!activeIdsNow.includes(activeShift.responsibleId)) {
                            activeShift.responsibleId = activeIdsNow[0];
                        }
                    } else {
                        activeShift.responsibleId = null;
                    }
                }
                dataManager.save();
                actions.closeModal();
                renderer.updateAll();
                alert('Vardiya personel listesi güncellendi.');
            });
        },
        addWorkerToActiveShift: (personelId) => {
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (!activeShift) return;
            if (activeShift.calisanlar.some(c => !c.bitisZamani && c.personelId === personelId)) return; // already active
            const person = app.data.personel.find(p => p.id === personelId);
            if (!person) return;
            activeShift.calisanlar.push({ isciAdi: person.ad, personelId: personelId, devralmaZamani: new Date().toISOString(), hoursRecorded: false });
            // Attendance kaydet: bu gün için mevcut değeri güncelle
            const today = app.helpers.getTodayISO();
            if (!person.attendance[today]) {
                person.attendance[today] = { status: 'present', hours: null };
            } else {
                // eğer izin veya absent ise present olarak güncelle ancak hours koru
                const entry = person.attendance[today];
                entry.status = 'present';
            }
        },
        removeWorkerFromActiveShift: (personelId) => {
            const activeShift = app.data.vardiyalar.find(v => v.durum === 'Aktif');
            if (!activeShift) return;
            const calisan = activeShift.calisanlar.find(c => !c.bitisZamani && c.personelId === personelId);
            if (!calisan) return;
            // Çıkış zamanını işaretle
            const nowISO = new Date().toISOString();
            calisan.bitisZamani = nowISO;
            // Eğer saat kaydı henüz yapılmadıysa, çalışılan süreyi hesapla ve attendance kaydet
            if (!calisan.hoursRecorded) {
                const person = app.data.personel.find(p => p.id === personelId);
                if (person) {
                    const startISO = calisan.devralmaZamani;
                    const hoursDec = app.helpers.calculateHoursDecimal(startISO, nowISO);
                    const dateKey = app.helpers.getTodayISO();
                    if (!person.attendance[dateKey]) {
                        person.attendance[dateKey] = { status: 'present', hours: hoursDec };
                    } else {
                        const entry = person.attendance[dateKey];
                        entry.status = 'present';
                        if (entry.hours === null || entry.hours === undefined) entry.hours = 0;
                        entry.hours = parseFloat((entry.hours + hoursDec).toFixed(2));
                    }
                }
                calisan.hoursRecorded = true;
            }
            // Eğer çıkartılan kişi sorumlu ise yeni sorumlu ataması yap
            if (activeShift.responsibleId === personelId) {
                // Mevcut aktif personelleri listele (bu kişiyi çıkardıktan sonra)
                const kalanAktifler = activeShift.calisanlar.filter(c => !c.bitisZamani).map(c => c.personelId);
                if (kalanAktifler.length > 0) {
                    activeShift.responsibleId = kalanAktifler[0];
                } else {
                    activeShift.responsibleId = null;
                }
            }
        },
        handlePersonelFormLoad: (e) => {
            const selectedId = e.target.value;
            const form = app.dom.personelIslemForm;
            const submitBtn = app.dom.personelFormSubmitBtn;
            const sifreInput = form.querySelector('#personel-sifre');
            const sgkSelect = app.dom.personelSgkDurumu; 
            const sgkTutarGroup = app.dom.personelSgkTutarGroup; 
            const sgkTutarInput = form.querySelector('#personel-sgk-tutar');
            const netMaasInput = app.dom.personelNetMaasInput; 
            const brutMaasInput = app.dom.personelBrutMaasInput; 
            
            if (selectedId === 'new') {
                form.reset();
                form.querySelector('#personel-ise-alim-tarihi').value = app.helpers.getTodayISO();
                form.querySelector('#personel-islem-select').value = 'new';
                submitBtn.textContent = 'Personeli Kaydet';
                submitBtn.classList.add('btn-success');
                submitBtn.classList.remove('btn-warning');
                sifreInput.placeholder = 'Yeni şifre (en az 4 karakter)';
                sgkSelect.value = 'Yok'; 
                sgkTutarGroup.style.display = 'none';
            } else {
                const personelId = parseInt(selectedId);
                const personel = app.data.personel.find(p => p.id === personelId);
                if (!personel) {
                    alert('Personel bulunamadı. Form sıfırlanıyor.');
                    actions.handlePersonelFormLoad({ target: { value: 'new' } });
                    return;
                }
                form.querySelector('#personel-ad-soyad').value = personel.ad;
                form.querySelector('#personel-telefon').value = personel.telefon || '';
                form.querySelector('#personel-ise-alim-tarihi').value = personel.iseAlimTarihi || '';
                form.querySelector('#personel-pozisyon-select').value = personel.pozisyonId;
                
                netMaasInput.value = personel.netMaas || '';
                brutMaasInput.value = personel.brutMaas || '';
                
                form.querySelector('#personel-maas-tipi').value = personel.maasTipi;
                form.querySelector('#personel-durum').value = personel.durum;
                form.querySelector('#personel-kullanici-adi').value = personel.kullaniciAdi || '';
                
                sgkSelect.value = personel.sgkDurumu || 'Yok';
                sgkTutarInput.value = personel.sgkTutar || '';
                if (personel.sgkDurumu === 'Var') {
                    sgkTutarGroup.style.display = 'block';
                } else {
                    sgkTutarGroup.style.display = 'none';
                }

                sifreInput.value = ''; 
                sifreInput.placeholder = personel.sifre ? 'Yeni şifre (Değiştirmek için)' : 'Yeni şifre (en az 4 karakter)';
                submitBtn.textContent = 'Değişiklikleri Kaydet';
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-warning');
            }
        },
        handlePersonelFormSubmit: async (e) => {
            e.preventDefault();
            const selectedId = app.dom.personelIslemSelect.value;
            if (selectedId === 'new') { await actions.saveNewWorker(e.target); } 
            else { await actions.saveUpdatedWorker(e.target, parseInt(selectedId)); }
        },
        saveNewWorker: async (form) => {
            const adSoyad = form.querySelector('#personel-ad-soyad').value.trim();
            const pozisyonId = parseInt(form.querySelector('#personel-pozisyon-select').value);
            if (!adSoyad || isNaN(pozisyonId)) { alert('İsim Soyisim ve Pozisyon alanları zorunludur.'); return; }
            const kullaniciAdi = form.querySelector('#personel-kullanici-adi').value.trim();
            const sifre = form.querySelector('#personel-sifre').value;
            const sgkDurumu = form.querySelector('#personel-sgk-durumu').value;
            const sgkTutar = parseFloat(form.querySelector('#personel-sgk-tutar').value) || 0;
            // Maaşları Al (Manuel)
            const netMaas = parseFloat(app.dom.personelNetMaasInput.value) || 0;
            const brutMaas = parseFloat(app.dom.personelBrutMaasInput.value) || 0;

            let sifreHash = '';
            if (kullaniciAdi) {
                if (kullaniciAdi.toLowerCase() === 'admin' || app.data.personel.some(p => p.kullaniciAdi.toLowerCase() === kullaniciAdi.toLowerCase())) {
                    alert('Bu kullanıcı adı zaten kullanılıyor. Lütfen başka bir kullanıcı adı seçin.');
                    return;
                }
                if(sifre.length < 4) { alert('Kullanıcı adı girdiyseniz, şifre en az 4 karakter olmalıdır.'); return; }
                sifreHash = await app.helpers.hash(sifre);
            } else if (sifre) {
                alert('Şifre belirlemek için önce bir kullanıcı adı girmelisiniz.');
                return;
            }
            const newWorker = {
                id: Date.now(),
                ad: adSoyad,
                telefon: form.querySelector('#personel-telefon').value.trim(),
                iseAlimTarihi: form.querySelector('#personel-ise-alim-tarihi').value,
                pozisyonId: pozisyonId,
                netMaas: netMaas, 
                brutMaas: brutMaas, 
                maasTipi: form.querySelector('#personel-maas-tipi').value,
                durum: form.querySelector('#personel-durum').value,
                kullaniciAdi: kullaniciAdi,
                sifre: sifreHash,
                sgkDurumu: sgkDurumu,
                sgkTutar: sgkTutar,
                attendance: {} // Yeni: katılım kaydı
            };
            app.data.personel.push(newWorker);
            dataManager.save();
            alert('Personel başarıyla kaydedildi.');
            renderer.personelListesi(); 
            renderer.pozisyonListesi(); 
            renderer.vardiyaPersonelSelect();
            renderer.personelIslemSelect(); 
            actions.handlePersonelFormLoad({ target: { value: 'new' } }); 
        },
        saveUpdatedWorker: async (form, personelId) => {
            const personelIndex = app.data.personel.findIndex(p => p.id === personelId);
            if (personelIndex === -1) { alert('Personel bulunamadı. Değişiklikler kaydedilemedi.'); return; }
            const adSoyad = form.querySelector('#personel-ad-soyad').value.trim();
            const pozisyonId = parseInt(form.querySelector('#personel-pozisyon-select').value);
            const sgkDurumu = form.querySelector('#personel-sgk-durumu').value;
            const sgkTutar = parseFloat(form.querySelector('#personel-sgk-tutar').value) || 0;
            // Maaşları Al (Manuel)
            const netMaas = parseFloat(app.dom.personelNetMaasInput.value) || 0;
            const brutMaas = parseFloat(app.dom.personelBrutMaasInput.value) || 0;

            if (!adSoyad || isNaN(pozisyonId)) { alert('İsim Soyisim ve Pozisyon alanları zorunludur.'); return; }
            const eskiAd = app.data.personel[personelIndex].ad;
            if (eskiAd !== adSoyad) { if (!confirm(`Personelin adını '${eskiAd}' -> '${adSoyad}' olarak değiştirmek üzeresiniz?\n(Geçmiş vardiya kayıtları etkilenmez.)`)) { return; } }
            const kullaniciAdi = form.querySelector('#personel-kullanici-adi').value.trim();
            const yeniSifre = form.querySelector('#personel-sifre').value;
            let sifreHash = app.data.personel[personelIndex].sifre;
            if (kullaniciAdi) {
                if (kullaniciAdi.toLowerCase() === 'admin' || app.data.personel.some(p => p.id !== personelId && p.kullaniciAdi.toLowerCase() === kullaniciAdi.toLowerCase())) {
                    alert('Bu kullanıcı adı zaten başka bir personel tarafından kullanılıyor.');
                    return;
                }
                if (yeniSifre) {
                    if(yeniSifre.length < 4) { alert('Yeni şifre en az 4 karakter olmalıdır.'); return; }
                    sifreHash = await app.helpers.hash(yeniSifre);
                } else if (!sifreHash) { 
                    alert('Kullanıcı adı belirlediyseniz, mutlaka bir şifre de girmelisiniz.');
                    return;
                }
            } else {
                if (yeniSifre) { alert('Şifre belirlemek için önce bir kullanıcı adı girmelisiniz.'); return; }
                sifreHash = '';
            }
            app.data.personel[personelIndex] = {
                ...app.data.personel[personelIndex],
                ad: adSoyad,
                telefon: form.querySelector('#personel-telefon').value.trim(),
                iseAlimTarihi: form.querySelector('#personel-ise-alim-tarihi').value,
                pozisyonId: pozisyonId,
                netMaas: netMaas, 
                brutMaas: brutMaas, 
                maasTipi: form.querySelector('#personel-maas-tipi').value,
                durum: form.querySelector('#personel-durum').value,
                kullaniciAdi: kullaniciAdi,
                sifre: sifreHash,
                sgkDurumu: sgkDurumu,
                sgkTutar: sgkTutar
            };
            dataManager.save();
            alert('Personel bilgileri başarıyla güncellendi.');
            renderer.personelListesi();
            renderer.vardiyaPersonelSelect();
            renderer.personelIslemSelect(); 
            actions.handlePersonelFormLoad({ target: { value: 'new' } }); 
        },
        deleteWorker: (workerId) => {
            workerId = parseInt(workerId);
            const worker = app.data.personel.find(i => i.id === workerId);
            if (!worker) { alert('Silinecek personel bulunamadı.'); return; }
            let vardiyaUyarisi = "";
            const isUsedInShift = app.data.vardiyalar.some(v => v.calisanlar.some(c => c.personelId === workerId || c.isciAdi === worker.ad));
            if(isUsedInShift) { vardiyaUyarisi = "\n\n(Bu personel, geçmiş vardiya kayıtlarında kullanılmış.)"; }
            const selectValue = app.dom.personelIslemSelect.value;
            if (parseInt(selectValue) === workerId) { alert(`'${worker.ad}' şu anda işlem formunda seçili. Lütfen formu sıfırlayıp (Yeni Personel seçip) tekrar deneyin.`); return; }
            if (confirm(`'${worker.ad}' adlı personeli silmek istediğinizden emin misiniz? (Panel giriş bilgileri de silinecektir)${vardiyaUyarisi}`)) {
                app.data.personel = app.data.personel.filter(i => i.id !== workerId);
                dataManager.save();
                renderer.updateAll(); 
                alert('Personel silindi.');
            }
        },
        openPersonelOdemeModal: (personelId, personelAdi) => {
            const personel = app.data.personel.find(p => p.id === personelId);
            let sgkInfoHtml = '';
            
            if (personel && personel.sgkDurumu === 'Var') {
                const sgkTutar = personel.sgkTutar > 0 ? personel.sgkTutar : 0;
                sgkInfoHtml = `
                    <div class="checkbox-container" style="margin-top: 15px;">
                        <input type="checkbox" id="personel-sgk-ekle-check" checked>
                        <label for="personel-sgk-ekle-check">
                            SGK Primi Gideri Ekle (${app.helpers.formatCurrency(sgkTutar)})
                        </label>
                    </div>
                    <p style="font-size: 12px; color: #7f8c8d; margin-top: -10px; margin-bottom: 15px;">İşaretlenirse, maaş ödemesine ek olarak bu tutar 'Resmi Gider' olarak ayrıca kaydedilir.</p>
                    <input type="hidden" id="personel-sgk-tutar-hidden" value="${sgkTutar}">
                `;
            }

            // Maaş bilgisi önerisi
            const netMaas = personel.netMaas || 0;
            const oneriText = netMaas > 0 ? `(Maaş: ${app.helpers.formatCurrency(netMaas)})` : '';

            const formHtml = `
                <form id="personel-odeme-form">
                    <input type="hidden" id="personel-odeme-id" value="${personelId}"><input type="hidden" id="personel-odeme-ad" value="${personelAdi}">
                    <div class="input-group"><label for="personel-odeme-tipi">Ödeme Tipi</label><select id="personel-odeme-tipi" required><option value="Maaş Ödemesi">Maaş Ödemesi</option><option value="Avans Ödemesi">Avans Ödemesi</option><option value="Prim Ödemesi">Prim Ödemesi</option></select></div>
                    <div class="input-group"><label for="personel-odeme-tutar">Tutar (₺) ${oneriText}</label><input type="number" step="0.01" id="personel-odeme-tutar" value="${netMaas > 0 ? netMaas : ''}" required></div>
                    <!-- Fazla İzin Kesintisi düğmesi ve alanı -->
                    <div class="input-group" id="kesinti-toggle-group" style="display:none; margin-bottom:10px;">
                        <button type="button" id="toggle-kesinti-btn" class="btn btn-sm-warning">Fazla İzin Kesintisi Ekle</button>
                    </div>
                    <div class="input-group" id="personel-kesinti-group" style="display:none;">
                        <label for="personel-odeme-kesinti">Fazla İzin Kesintisi (₺)</label>
                        <input type="number" step="0.01" id="personel-odeme-kesinti" placeholder="Opsiyonel">
                    </div>
                    <div class="input-group"><label for="personel-odeme-tarih">Ödeme Tarihi</label><input type="date" id="personel-odeme-tarih" value="${app.helpers.getTodayISO()}" required></div>
                    <div class="input-group"><label for="personel-odeme-aciklama">Kısa Açıklama (Opsiyonel)</label><input type="text" id="personel-odeme-aciklama" placeholder="Örn: Bayram avansı"></div>
                    ${sgkInfoHtml}
                    <button type="submit" class="btn btn-success btn-full">Ödemeyi Kaydet</button>
                </form>
            `;
            actions.openModal(`${personelAdi} için Ödeme`, formHtml);
            // Ödeme tipi değiştiğinde kesinti alanını göster/gizle
            const formEl = document.getElementById('personel-odeme-form');
            if (formEl) {
                const odemeSelect = formEl.querySelector('#personel-odeme-tipi');
                const kesintiToggleGroup = formEl.querySelector('#kesinti-toggle-group');
                const kesintiGroup = formEl.querySelector('#personel-kesinti-group');
                const toggleBtn = formEl.querySelector('#toggle-kesinti-btn');
                if (odemeSelect && kesintiToggleGroup && kesintiGroup && toggleBtn) {
                    // Ödeme tipine göre kesinti butonunun görünümü
                    const updateKesintiVisibility = () => {
                        if (odemeSelect.value === 'Maaş Ödemesi') {
                            kesintiToggleGroup.style.display = 'block';
                        } else {
                            kesintiToggleGroup.style.display = 'none';
                            kesintiGroup.style.display = 'none';
                            // buton metnini sıfırla
                            toggleBtn.textContent = 'Fazla İzin Kesintisi Ekle';
                            // inputu temizle
                            const inp = kesintiGroup.querySelector('input');
                            if (inp) inp.value = '';
                        }
                    };
                    // İlk görünüm
                    updateKesintiVisibility();
                    odemeSelect.addEventListener('change', updateKesintiVisibility);
                    // Düğme ile kesinti giriş alanını göster/gizle
                    toggleBtn.addEventListener('click', () => {
                        if (kesintiGroup.style.display === 'none' || kesintiGroup.style.display === '') {
                            kesintiGroup.style.display = 'block';
                            toggleBtn.textContent = 'Kesinti Gizle';
                        } else {
                            kesintiGroup.style.display = 'none';
                            toggleBtn.textContent = 'Fazla İzin Kesintisi Ekle';
                            const inp = kesintiGroup.querySelector('input');
                            if (inp) inp.value = '';
                        }
                    });
                }
                formEl.addEventListener('submit', actions.handlePersonelOdeme);
            }
        },
        handlePersonelOdeme: (e) => {
            e.preventDefault();
            const form = e.target;
            const personelId = parseInt(form.querySelector('#personel-odeme-id').value);
            const personel = app.data.personel.find(p => p.id === personelId);
            
            const personelAdi = form.querySelector('#personel-odeme-ad').value;
            const odemeTipi = form.querySelector('#personel-odeme-tipi').value;
            // Çalışana ödenen NET tutar (kullanıcının girdiği tutar)
            let netOdemeTutar = parseFloat(form.querySelector('#personel-odeme-tutar').value);
            const tarih = form.querySelector('#personel-odeme-tarih').value;
            const aciklama = form.querySelector('#personel-odeme-aciklama').value.trim();
            
            const sgkCheckbox = form.querySelector('#personel-sgk-ekle-check');
            let sgkMesaj = "";
            // Varsayılan: Avans/Prim tutarı
            let giderKaydiTutar = netOdemeTutar;
            // Açıklama içerisinde kesinti bilgisini sonradan ekleyeceğiz
            let giderKaydiAciklama = `${personelAdi} isimli personele yapılan ${odemeTipi} (Net Ödeme). ${aciklama ? `(Not: ${aciklama})` : ''}`;
            // Fazla izin kesintisi (opsiyonel)
            let kesinti = 0;
            const kesintiInputEl = form.querySelector('#personel-odeme-kesinti');
            if (kesintiInputEl && kesintiInputEl.value) {
                const val = parseFloat(kesintiInputEl.value);
                if (!isNaN(val) && val > 0) {
                    kesinti = val;
                }
            }

            if (isNaN(netOdemeTutar) || netOdemeTutar <= 0) { alert('Lütfen geçerli bir tutar girin.'); return; }
            // Kesinti, net ödeme tutarından büyük olamaz
            if (kesinti > 0 && kesinti > netOdemeTutar) {
                alert('Kesinti tutarı net ödeme tutarından büyük olamaz.');
                return;
            }
            
            // 1. Gider Kaydını Net Maaş yerine Brüt Maaş üzerinden yap
            if (odemeTipi === 'Maaş Ödemesi' && personel && personel.brutMaas > 0) {
                // Kesinti varsa, brüt maaştan da düşelim (basit oran)
                let brutGider = personel.brutMaas;
                if (kesinti > 0) {
                    brutGider = brutGider - kesinti;
                    if (brutGider < 0) brutGider = 0;
                }
                giderKaydiTutar = brutGider; // Gider olarak BRÜT MAAŞ - kesinti
                // Net ödeme tutarından kesinti düş
                const netOdenen = netOdemeTutar - kesinti;
                // Gider açıklaması: çalışma ve kesinti bilgileri
                giderKaydiAciklama = `${personelAdi} için Aylık Maaş Gideri (Brüt Tutar). Çalışana Net Ödenen: ${app.helpers.formatCurrency(netOdenen)}.`;
                if (kesinti > 0) {
                    giderKaydiAciklama += ` Fazla izin kesintisi: ${app.helpers.formatCurrency(kesinti)}.`;
                }
                if (aciklama) {
                    giderKaydiAciklama += ` Not: ${aciklama}.`;
                }
                // Net ödeme tutarını güncelleyin
                netOdemeTutar = netOdenen;
            }

            // Gider Kaydını Oluştur (Net/Brüt duruma göre)
            const newExpense = { 
                id: Date.now(), 
                tip: 'diger', 
                aciklama: odemeTipi === 'Maaş Ödemesi' ? 'Personel Maaş Gideri (Brüt)' : odemeTipi, // Raporlarda ayırt etmesi kolay olsun
                detay: giderKaydiAciklama, 
                tutar: giderKaydiTutar, 
                tarih: tarih 
            };
            app.data.giderler.push(newExpense);

            // 2. SGK Primi Giderini Kaydet (SADECE Maaş Ödemesi ve Onaylı ise)
            if (odemeTipi === 'Maaş Ödemesi' && sgkCheckbox && sgkCheckbox.checked) {
                const sgkTutar = parseFloat(form.querySelector('#personel-sgk-tutar-hidden').value);
                if (sgkTutar > 0) {
                     const sgkExpense = { 
                         id: Date.now() + 1, // Benzersizlik için +1
                         tip: 'diger', 
                         aciklama: 'Resmi İşveren Maliyeti (SGK/Vergi)', 
                         detay: `${personelAdi} için ${tarih} tarihli işveren maliyeti (SGK ve Diğer Resmi Kesintiler).`, 
                         tutar: sgkTutar, 
                         tarih: tarih 
                     };
                     app.data.giderler.push(sgkExpense);
                     sgkMesaj = `\n\nAyrıca ${app.helpers.formatCurrency(sgkTutar)} tutarında resmi maliyet (SGK/Vergi) giderlere eklendi.`;
                }
            }

            dataManager.save();
            actions.closeModal();
            renderer.updateAll();
            let finalMessage = `${personelAdi} için ${app.helpers.formatCurrency(netOdemeTutar)} net ödemesi kaydedildi.`;
            if (kesinti > 0) {
                finalMessage += ` Kesinti uygulandı: ${app.helpers.formatCurrency(kesinti)}.`;
            }
            finalMessage += ` Giderlere ${app.helpers.formatCurrency(giderKaydiTutar)} yansıtıldı.${sgkMesaj}`;
            alert(finalMessage);
        },
        addPosition: (e) => {
            e.preventDefault();
            const form = app.dom.pozisyonEkleForm;
            const ad = form.querySelector('#pozisyon-adi').value.trim();
            if (!ad) { alert('Pozisyon adı boş olamaz.'); return; }
            if (app.data.pozisyonlar.some(p => p.ad.toLowerCase() === ad.toLowerCase())) { alert('Bu pozisyon adı zaten kayıtlı.'); return; }
            app.data.pozisyonlar.push({ id: Date.now(), ad: ad });
            dataManager.save();
            renderer.pozisyonListesi(); 
            renderer.personelPozisyonSelect(app.dom.personelPozisyonSelect);
            form.reset();
            alert('Pozisyon eklendi.');
        },
        deletePosition: (pozisyonId, kullanimSayisi) => {
            pozisyonId = parseInt(pozisyonId);
            kullanimSayisi = parseInt(kullanimSayisi);
            const pozisyon = app.data.pozisyonlar.find(p => p.id === pozisyonId);
            if (!pozisyon) { alert('Silinecek pozisyon bulunamadı.'); return; }
            if (kullanimSayisi > 0) { alert(`'${pozisyon.ad}' pozisyonu şu anda ${kullanimSayisi} personel tarafından kullanıldığı için silinemez.\nÖnce bu personellerin pozisyonlarını değiştirin.`); return; }
            if (confirm(`'${pozisyon.ad}' pozisyonunu silmek istediğinizden emin misiniz?`)) {
                app.data.pozisyonlar = app.data.pozisyonlar.filter(p => p.id !== pozisyonId);
                dataManager.save();
                renderer.pozisyonListesi();
                renderer.personelPozisyonSelect(app.dom.personelPozisyonSelect);
                alert('Pozisyon silindi.');
            }
        },
        addFactory: (e) => { e.preventDefault(); const name = app.dom.fabrikaForm.querySelector('#fabrika-adi').value.trim(); if (name) { app.data.fabrikalar.push({ id: Date.now(), ad: name }); dataManager.save(); app.dom.fabrikaForm.reset(); renderer.updateAll(); } },
        updateUretimToplam: () => { const adet = parseFloat(app.dom.uretimAdetInput.value) || 0; const birimFiyat = parseFloat(app.dom.uretimBirimFiyatInput.value) || 0; app.dom.uretimToplamTutarInput.value = app.helpers.formatCurrency(adet * birimFiyat); },
        // actions nesnesinin içindeki addUretimToList fonksiyonunu bununla değiştir:
// actions nesnesinin içine yapıştırın (Eskisini silin)
// actions nesnesinin içine yapıştır (Eskisini sil)
addUretimToList: (e) => { 
    e.preventDefault(); 
    const form = app.dom.uretimEkleForm; 
    
    // Değerleri alıyoruz
    const birimMaliyet = parseFloat(form.querySelector('#uretim-birim-maliyet').value) || 0;
    const kdvOrani = parseFloat(form.querySelector('#uretim-kdv-orani').value) || 0;

    const uretim = { 
        fabrikaId: parseInt(form.querySelector('#uretim-fabrika').value), 
        tarih: form.querySelector('#uretim-tarih').value, 
        aciklama: form.querySelector('#uretim-aciklama').value.trim(), 
        adet: parseInt(form.querySelector('#uretim-adet').value), 
        birimFiyat: parseFloat(form.querySelector('#uretim-birim-fiyat').value),
        birimMaliyet: birimMaliyet,
        kdvOrani: kdvOrani // <-- KDV verisi eklendi
    }; 

    if (!uretim.fabrikaId || !uretim.tarih || !uretim.aciklama || isNaN(uretim.adet) || uretim.adet <= 0 || isNaN(uretim.birimFiyat) || uretim.birimFiyat <= 0) { 
        alert('Lütfen zorunlu alanları (Fabrika, Tarih, Açıklama, Adet, Satış Fiyatı) doldurun.'); 
        return; 
    } 

    app.temp.uretimListesi.push(uretim); 
    renderer.uretimEkleListesi(); 

    // Formu temizle (Tarih hariç)
    form.querySelector('#uretim-aciklama').value = ''; 
    form.querySelector('#uretim-adet').value = ''; 
    form.querySelector('#uretim-birim-fiyat').value = ''; 
    form.querySelector('#uretim-birim-maliyet').value = ''; 
    form.querySelector('#uretim-kdv-orani').value = ''; // KDV alanını temizle
    form.querySelector('#uretim-toplam-tutar').value = ''; 
    form.querySelector('#uretim-aciklama').focus(); 
},


        removeUretimFromList: (index) => { app.temp.uretimListesi.splice(index, 1); renderer.uretimEkleListesi(); },
        clearUretimListesi: () => { if (app.temp.uretimListesi.length > 0 && confirm('Kaydedilmemiş tüm kalemler silinecek. Emin misiniz?')) { app.temp.uretimListesi = []; renderer.uretimEkleListesi(); } },
        // actions nesnesinin içine yapıştırın (Eskisini silin)
// actions nesnesinin içine yapıştır (Eskisini sil)
saveUretimListesi: () => {
    const list = app.temp.uretimListesi;
    if (list.length === 0) {
        alert('Kaydedilecek bir kalem bulunmuyor.');
        return;
    }

    if (confirm(`${list.length} adet üretim kalemini kaydetmek istediğinizden emin misiniz?`)) {
        let toplamMaliyetGideri = 0;
        let toplamKdvGideri = 0;

        list.forEach((item, index) => {
            // 1. ÜRETİMİ KAYDET (Fabrika Borçlanır)
            const uretimId = Date.now() + index;
            app.data.uretimler.push({ ...item, id: uretimId });

            // Fabrika adını bul
            const fabrika = app.data.fabrikalar.find(f => f.id === item.fabrikaId);
            const fabrikaAdi = fabrika ? fabrika.ad : 'Bilinmeyen';
            const toplamSatis = item.adet * item.birimFiyat;

            // 2. MALİYET GİDERİ KAYDI (Varsa)
            if (item.birimMaliyet && item.birimMaliyet > 0) {
                const maliyetTutari = item.adet * item.birimMaliyet;
                toplamMaliyetGideri += maliyetTutari;

                app.data.giderler.push({
                    id: Date.now() + index + 50000,
                    tip: 'diger',
                    aciklama: `[MALİYET] ${item.aciklama}`,
                    detay: `Otomatik Kayıt: ${fabrikaAdi} - ${item.aciklama} üretimi için birim maliyet gideri.`,
                    tutar: maliyetTutari,
                    tarih: item.tarih
                });
            }

            // 3. KDV GİDERİ KAYDI (Varsa)
            if (item.kdvOrani && item.kdvOrani > 0) {
                // KDV Hesabı: Satış Tutarı * (Oran / 100)
                const kdvTutari = toplamSatis * (item.kdvOrani / 100);
                toplamKdvGideri += kdvTutari;

                app.data.giderler.push({
                    id: Date.now() + index + 90000,
                    tip: 'diger', // KDV de bir gider/kesintidir
                    aciklama: `[KDV] %${item.kdvOrani} - ${item.aciklama}`,
                    detay: `Otomatik Kayıt: ${fabrikaAdi} satışından doğan KDV yükümlülüğü. (Satış: ${app.helpers.formatCurrency(toplamSatis)})`,
                    tutar: kdvTutari,
                    tarih: item.tarih
                });
            }
        });

        dataManager.save();
        app.temp.uretimListesi = [];
        
        let mesaj = `${list.length} adet üretim başarıyla kaydedildi.`;
        if (toplamMaliyetGideri > 0) mesaj += `\n- Toplam ${app.helpers.formatCurrency(toplamMaliyetGideri)} maliyet gideri işlendi.`;
        if (toplamKdvGideri > 0) mesaj += `\n- Toplam ${app.helpers.formatCurrency(toplamKdvGideri)} KDV gideri işlendi.`;
        
        alert(mesaj);
        renderer.updateAll();
    }
},
        deleteProduction: (uretimId) => { uretimId = parseInt(uretimId); const uretim = app.data.uretimler.find(u => u.id === uretimId); if (!uretim) return; const fabrikaAdi = app.data.fabrikalar.find(f => f.id === uretim.fabrikaId)?.ad || 'Bilinmeyen Fabrika'; const onay = confirm(`Aşağıdaki üretim kaydını kalıcı olarak silmek istediğinizden emin misiniz?\n\nFabrika: ${fabrikaAdi}\nTarih: ${uretim.tarih}\nAçıklama: ${uretim.aciklama}\nTutar: ${app.helpers.formatCurrency(uretim.adet * uretim.birimFiyat)}`); if (onay) { app.data.uretimler = app.data.uretimler.filter(u => u.id !== uretimId); dataManager.save(); renderer.updateAll(); alert('Üretim kaydı silindi.'); } },
        addExpense: (e) => { e.preventDefault(); const form = app.dom.giderForm; const gider = { id: Date.now(), tip: form.querySelector('#gider-tip').value, aciklama: form.querySelector('#gider-aciklama').value.trim(), detay: form.querySelector('#gider-detay').value.trim(), tutar: parseFloat(form.querySelector('#gider-tutar').value), tarih: form.querySelector('#gider-tarih').value }; if (!gider.tip || !gider.aciklama || isNaN(gider.tutar) || !gider.tarih) { alert('Lütfen Tip, Başlık, Tutar ve Tarih alanlarını doğru doldurun.'); return; } app.data.giderler.push(gider); dataManager.save(); form.reset(); form.querySelector('#gider-tarih').value = app.helpers.getTodayISO(); alert('Gider kaydedildi!'); renderer.updateAll(); },
        addPayment: (e) => { e.preventDefault(); const form = e.target; const odeme = { id: Date.now(), fabrikaId: parseInt(form.querySelector('#odeme-fabrika-id').value), tutar: parseFloat(form.querySelector('#odeme-tutari').value), tarih: form.querySelector('#odeme-tarihi').value }; if (isNaN(odeme.tutar) || !odeme.tarih) { alert('Lütfen tüm alanları doğru doldurun.'); return; } app.data.odemeler.push(odeme); dataManager.save(); actions.closeModal(); alert('Ödeme kaydedildi!'); renderer.updateAll(); },
        handleFabrikaSilSubmit: (e) => { e.preventDefault(); const fabrikaId = parseInt(app.dom.fabrikaSilSelect.value); if (isNaN(fabrikaId)) { alert('Lütfen silmek için bir fabrika seçin.'); return; } const fabrika = app.data.fabrikalar.find(f => f.id === fabrikaId); if (!fabrika) return; const onayMetni = prompt(`'${fabrika.ad}' fabrikasını kalıcı olarak silmek üzeresiniz. Bu işlem geri alınamaz ve tüm kayıtları yok edecektir.\n\nOnaylamak için fabrikanın adını ('${fabrika.ad}') aşağıdaki kutuya tam olarak yazın.`); if (onayMetni === fabrika.ad) { actions.deleteFactory(fabrikaId, fabrika.ad); } else if (onayMetni !== null) { alert('Onay metni eşleşmedi. Silme işlemi iptal edildi.'); } else { alert('Silme işlemi iptal edildi.'); } },
        deleteFactory: (fabrikaId, fabrikaAdi) => { app.data.fabrikalar = app.data.fabrikalar.filter(f => f.id !== fabrikaId); app.data.uretimler = app.data.uretimler.filter(u => u.fabrikaId !== fabrikaId); app.data.odemeler = app.data.odemeler.filter(o => o.fabrikaId !== fabrikaId); dataManager.save(); renderer.updateAll(); alert(`'${fabrikaAdi}' fabrikası ve ilgili tüm kayıtlar başarıyla silindi.`); app.dom.fabrikaSilForm.reset(); },
        resetFactory: (fabrikaId, fabrikaAdi) => { fabrikaId = parseInt(fabrikaId); const onay = confirm(`'${fabrikaAdi}' fabrikasının hesabını sıfırlamak istediğinizden emin misiniz?\n\nBu işlem fabrikayı SİLMEZ, ancak o fabrikaya ait TÜM üretim ve ödeme kayıtlarını kalıcı olarak siler.\n\nBu işlem geri alınamaz.`); if (onay) { app.data.uretimler = app.data.uretimler.filter(u => u.fabrikaId !== fabrikaId); app.data.odemeler = app.data.odemeler.filter(o => o.fabrikaId !== fabrikaId); dataManager.save(); renderer.updateAll(); alert(`'${fabrikaAdi}' fabrikasının hesabı başarıyla sıfırlandı.`); } },
        openModal: (title, bodyHtml, isLarge = false) => { app.dom.modalTitle.textContent = title; app.dom.modalBody.innerHTML = bodyHtml; if (isLarge) { app.dom.modalContent.classList.add('modal-lg'); } else { app.dom.modalContent.classList.remove('modal-lg'); } app.dom.modalContainer.classList.add('show'); },
        closeModal: () => { app.dom.modalContainer.classList.remove('show'); app.dom.modalTitle.textContent = ''; app.dom.modalBody.innerHTML = ''; app.dom.modalContent.classList.remove('modal-lg'); },
        openOdemeModal: (fabrikaId, fabrikaAdi) => {
            const formHtml = `
                <form id="odeme-form">
                    <input type="hidden" id="odeme-fabrika-id" value="${fabrikaId}">
                    <div class="input-group"><label for="odeme-tutari">Alınan Ödeme Tutarı (₺)</label><input type="number" step="0.01" id="odeme-tutari" required></div>
                    <div class="input-group"><label for="odeme-tarihi">Ödeme Tarihi</label><input type="date" id="odeme-tarihi" value="${app.helpers.getTodayISO()}" required></div>
                    <button type="submit" class="btn btn-success btn-full">Ödemeyi Kaydet</button>
                </form>
            `;
            actions.openModal(`${fabrikaAdi} için Ödeme Al`, formHtml);
            document.getElementById('odeme-form').addEventListener('submit', actions.addPayment);
        },
        deleteExpense: (giderId) => { giderId = parseInt(giderId); const gider = app.data.giderler.find(g => g.id === giderId); if (!gider) return; const onay = confirm(`Aşağıdaki gider kaydını silmek istediğinizden emin misiniz?\n\nTarih: ${new Date(gider.tarih).toLocaleDateString('tr-TR')}\nBaşlık: ${gider.aciklama}\nTutar: ${app.helpers.formatCurrency(gider.tutar)}`); if (onay) { app.data.giderler = app.data.giderler.filter(g => g.id !== giderId); dataManager.save(); renderer.updateAll(); alert('Gider kaydı başarıyla silindi.'); } }
        ,

        /**
         * Haftalık izin planı formunun submit handler'ı.
         * Seçilen personel ve tarih için izin kaydı oluşturur.
         */
        addManualLeave: (e) => {
            // Bu kodu actions nesnesinin içine, diğer fonksiyonların yanına ekleyin
        deleteShift: (id) => {
            id = parseInt(id);
            const shift = app.data.vardiyalar.find(v => v.id === id);
            if (!shift) return;

            if (confirm("Bu vardiya kaydını kalıcı olarak silmek istediğinizden emin misiniz?")) {
                // Vardiyayı diziden çıkar
                app.data.vardiyalar = app.data.vardiyalar.filter(v => v.id !== id);
                
                // Veriyi kaydet
                dataManager.save();
                
                // Sadece vardiya geçmişi tablosunu güncelle
                renderer.vardiyaGecmisi();
                
                alert("Vardiya kaydı başarıyla silindi.");
            }
        },
            e.preventDefault();
            const selectEl = app.dom.izinPersonelSelect;
            const dateEl = app.dom.izinTarihInput;
            const personId = parseInt(selectEl.value);
            const date = dateEl.value;
            if (!date || isNaN(personId)) {
                alert('Lütfen bir personel ve izin tarihi seçin.');
                return;
            }
            const person = app.data.personel.find(p => p.id === personId);
            if (!person) {
                alert('Personel bulunamadı.');
                return;
            }
            if (!person.attendance) {
                person.attendance = {};
            }
            // Planlı haftalık izinler için status 'weekly' kullanılır
            person.attendance[date] = { status: 'weekly', hours: null };
            // Kaydet ve arayüzü hemen güncelle
            dataManager.save();
            renderer.updateAll();
            // Kullanıcı bilgilendirmesi
            try {
                alert(`${person.ad} için ${app.helpers.formatDate(date)} tarihli planlı izin kaydedildi.`);
            } catch (err) {
                // Bazı ortamlarda alert engellenebilir; bu durumda hatayı yoksay
                console.log(`${person.ad} için planlı izin oluşturuldu: ${date}`);
            }
            // Formu sıfırla
            app.dom.izinPlanForm.reset();
        },
        // actions nesnesinin içine ekleyin:

stokEkle: (e) => {
    e.preventDefault();
    if (!app.data.stoklar) app.data.stoklar = [];
    
    const ad = document.getElementById('stok-adi').value.trim();
    if (!ad) { alert('Ürün adı zorunludur.'); return; }
    
    const yeniStok = {
        id: Date.now(),
        ad: ad,
        kategori: document.getElementById('stok-kategori').value,
        birim: document.getElementById('stok-birim').value,
        miktar: parseFloat(document.getElementById('stok-miktar').value) || 0,
        kritikSeviye: parseFloat(document.getElementById('stok-kritik').value) || 10,
        alisFiyati: parseFloat(document.getElementById('stok-fiyat').value) || 0
    };
    
    app.data.stoklar.push(yeniStok);
    dataManager.save();
    document.getElementById('stok-ekle-form').reset();
    renderer.stokListesi();
    alert('Stok kartı oluşturuldu.');
},

// actions objesinin içine (eski stokIslemModalAc yerine):
        stokIslemModalAc: (stokId, tip) => {
            const stok = app.data.stoklar.find(s => s.id === parseInt(stokId));
            if (!stok) return;
            
            const isGiris = tip === 'giris';
            const baslik = isGiris ? 'Stok Girişi (Ekleme)' : 'Stok Çıkışı (Düşme)';
            const btnClass = isGiris ? 'btn-success' : 'btn-danger';
            const btnText = isGiris ? 'Stoğu Ekle (+)' : 'Stoğu Düş (-)';
            
            // Modal İçeriği
            const html = `
                <div style="background:${isGiris ? '#f0fdf4' : '#fef2f2'}; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; border:1px solid ${isGiris ? '#bbf7d0' : '#fecaca'};">
                    <h3 style="margin:0; color:${isGiris ? '#166534' : '#991b1b'};">${stok.ad}</h3>
                    <p style="margin:5px 0 0 0; font-size:14px;">Mevcut: <strong>${parseFloat(stok.miktar).toFixed(2)} ${stok.birim}</strong></p>
                </div>

                <form id="stok-islem-form">
                    <input type="hidden" id="modal-stok-id" value="${stokId}">
                    
                    <div class="input-group">
                        <label>İşlem Miktarı (${stok.birim})</label>
                        <input type="number" id="modal-stok-miktar" step="0.01" min="0" required placeholder="0" style="font-size:18px; font-weight:bold; padding:15px;">
                    </div>
                    
                    <div class="input-group">
                        <label>${isGiris ? 'Yeni Birim Fiyat (Güncellemek isterseniz)' : 'Çıkış Nedeni / Açıklama'}</label>
                        ${isGiris 
                          ? `<input type="number" id="modal-stok-input-extra" step="0.01" value="${stok.alisFiyati}" placeholder="Fiyat">` 
                          : `<input type="text" id="modal-stok-input-extra" placeholder="Örn: Üretimde kullanıldı, Zayi oldu..." required>`
                        }
                    </div>
                    
                    <button type="submit" class="btn ${btnClass} btn-full" style="padding:15px; font-size:16px;">${btnText}</button>
                </form>
            `;
            
            actions.openModal(baslik, html);
            
            // HATA ÇÖZÜMÜ: Form elementini yeniden seçip listener ekliyoruz.
            const form = document.getElementById('stok-islem-form');
            
            // Önceki listenerları temizlemek için klonlama yöntemi veya one-time check
            // Ancak openModal innerHTML ile içeriği değiştirdiği için eski form DOM'dan silinir.
            // Sadece submit anında formun varlığını kontrol edelim.
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                e.stopImmediatePropagation(); // Önemli: Çoklu tetiklemeyi önler

                const miktarInput = document.getElementById('modal-stok-miktar');
                const extraInput = document.getElementById('modal-stok-input-extra');
                
                if (!miktarInput) return; // Form kapanmışsa dur

                const miktar = parseFloat(miktarInput.value);
                if (isNaN(miktar) || miktar <= 0) { alert('Lütfen geçerli bir miktar girin.'); return; }
                
                // Stok Yetersiz Kontrolü (Sadece çıkışta)
                if (!isGiris && miktar > stok.miktar) {
                    alert(`HATA: Yetersiz Stok!\nMevcut: ${stok.miktar} ${stok.birim}\nDüşülmek istenen: ${miktar} ${stok.birim}`);
                    return;
                }
                
                // İşlemi Uygula
                if (isGiris) {
                    stok.miktar = parseFloat(stok.miktar) + miktar;
                    const yeniFiyat = parseFloat(extraInput.value);
                    if (!isNaN(yeniFiyat) && yeniFiyat > 0) stok.alisFiyati = yeniFiyat;
                } else {
                    stok.miktar = parseFloat(stok.miktar) - miktar;
                }
                
                // Geçmişe Kaydet
                if (!app.data.stokHareketleri) app.data.stokHareketleri = [];
                app.data.stokHareketleri.push({
                    id: Date.now(),
                    stokId: stok.id,
                    urunAdi: stok.ad,
                    tip: tip,
                    miktar: miktar,
                    tarih: new Date().toISOString(),
                    aciklama: isGiris ? 'Stok Girişi' : (extraInput.value || 'Stok Çıkışı')
                });
                
                dataManager.save();
                renderer.stokListesi();
                // renderer.stokGecmisi(); // Geçmiş tablosunu anında güncelle
                renderer.stokOzet();
                actions.closeModal();
                
                // Ufak bir bildirim (Opsiyonel)
                // alert('İşlem başarıyla kaydedildi.');
            });
        },
stokSil: (stokId) => {
    if (confirm('Bu stok kartını ve geçmişini silmek istediğinize emin misiniz?')) {
        app.data.stoklar = app.data.stoklar.filter(s => s.id !== parseInt(stokId));
        dataManager.save();
        renderer.stokListesi();
    }
}


    };

    // --- BÖLÜM 6: CSV YÖNETİCİSİ ---
    const csvManager = {
        download: (content, fileName) => { const blob = new Blob([`\uFEFF${content}`], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName; link.click(); URL.revokeObjectURL(link.href); },
        downloadGenel: () => { let csv = 'Tip,Tarih,Açıklama/Fabrika,Tutar (₺)\n'; const tumIslemler = [ ...app.data.uretimler.map(u => ({ tarih: u.tarih, tip: 'Üretim (Alacak)', aciklama: `${app.data.fabrikalar.find(f => f.id === u.fabrikaId)?.ad || '?' } - ${u.aciklama} (${u.adet} adet)`, tutar: u.adet * u.birimFiyat })), ...app.data.odemeler.map(o => ({ tarih: o.tarih, tip: 'Tahsilat (Nakit Girişi)', aciklama: `${app.data.fabrikalar.find(f => f.id === o.fabrikaId)?.ad || '?' } Ödemesi`, tutar: o.tutar })), ...app.data.giderler.map(g => ({ tarih: g.tarih, tip: 'Gider (Nakit Çıkışı)', aciklama: `${g.aciklama}${g.detay ? ` (${g.detay})` : ''}`, tutar: -g.tutar })) ]; tumIslemler.sort((a, b) => new Date(a.tarih) - new Date(b.tarih)); tumIslemler.forEach(islem => { const tutarString = islem.tutar.toFixed(2); const cleanAciklama = `"${islem.aciklama.replace(/"/g, '""')}"`; csv += `${islem.tip},${islem.tarih},${cleanAciklama},${tutarString}\n`; }); const durum = calculator.genelDurum(); const toplamFinansalDeger = durum.netKar + durum.kalanAlacak; csv += '\n--- GENEL FİNANSAL ÖZET ---\n'; csv += 'Açıklama,,,Tutar (₺)\n'; csv += `1. Toplam Üretim Değeri (Genel Alacak),,,${durum.toplamUretimDegeri.toFixed(2)}\n `; csv += `2. Toplam Tahsilat (Nakit Girişi),,,${durum.toplamTahsilat.toFixed(2)}\n`; csv += `3. Toplam Giderler (Nakit Çıkışı),,,-${durum.toplamGiderler.toFixed(2)}\n`; csv += `NET KÂR (Nakit Bakiye: Tahsilat - Gider),,,${durum.netKar.toFixed(2)}\n`; csv += `KALAN TOPLAM ALACAK (Bakiye: Üretim - Tahsilat),,,${durum.kalanAlacak.toFixed(2)}\n`; csv += `BAKİYE : ${toplamFinansalDeger.toFixed(2)} ₺\n`; csv += `\n*** RAPOR SONU ***\n`; csvManager.download(csv, `genel_rapor_${app.helpers.getTodayISO()}.csv`); },
        downloadFabrika: (fabrikaId, fabrikaAdi) => { let csv = `Fabrika Hesap Dökümü: ${fabrikaAdi}\n`; const bakiye = calculator.fabrikaBakiyesi(fabrikaId); csv += '\n--- ÜRETİLER ---\n'; csv += 'Tarih,Açıklama,Adet,Birim Fiyat (₺),Toplam Tutar (₺)\n'; app.data.uretimler.filter(u => u.fabrikaId === fabrikaId).forEach(u => { const cleanAciklama = `"${u.aciklama.replace(/"/g, '""')}"`; csv += `${u.tarih},${cleanAciklama},${u.adet},${u.birimFiyat.toFixed(2)},${(u.adet * u.birimFiyat).toFixed(2)}\n`; }); csv += `\nToplam Üretim Değeri:,,,,"${app.helpers.formatCurrency(bakiye.toplamUretim)}"\n`; csv += '\n--- ÖDEMELER ---\n'; csv += 'Tarih,Ödenen Tutar (₺)\n'; app.data.odemeler.filter(o => o.fabrikaId === fabrikaId).forEach(o => { csv += `${o.tarih},${o.tutar.toFixed(2)}\n`; }); csv += `\nToplam Ödenen:,"${app.helpers.formatCurrency(bakiye.toplamOdenen)}"\n`; csv += `\n--- BAKİYE ---\n`; csv += `Kalan Borç (Tahsil Edilecek):,"${app.helpers.formatCurrency(bakiye.kalanBorc)}"\n`; csvManager.download(csv, `rapor_${fabrikaAdi.replace(/ /g, '_')}_${app.helpers.getTodayISO()}.csv`); },
        downloadGiderler: () => { let csv = 'Tip,Tarih,Başlık,Açıklama,Tutar (₺)\n'; let toplamFabrika = 0; let toplamDiger = 0; const siraliGiderler = [...app.data.giderler].sort((a, b) => new Date(a.tarih) - new Date(b.tarih)); siraliGiderler.forEach(g => { const tip = g.tip === 'fabrika' ? 'Fabrika Gideri' : 'Diğer Gider'; const tutar = g.tutar; const baslik = `"${g.aciklama.replace(/"/g, '""')}"`; const detay = `"${(g.detay || '-').replace(/"/g, '""')}"`; csv += `${tip},${g.tarih},${baslik},${detay},${tutar.toFixed(2)}\n`; if (g.tip === 'fabrika') { toplamFabrika += tutar; } else { toplamDiger += tutar; } }); const toplamGider = toplamFabrika + toplamDiger; csv += '\n--- GİDER ÖZETİ ---\n'; csv += 'Açıklama,,,,Tutar (₺)\n'; csv += `Toplam Fabrika Giderleri,,,,${toplamFabrika.toFixed(2)}\n`; csv += `Toplam Diğer Giderler,,,,${toplamDiger.toFixed(2)}\n`; csv += `GENEL TOPLAM GİDER,,,,${toplamGider.toFixed(2)}\n`; csv += `\n*** RAPOR SONU ***\n`; csvManager.download(csv, `gider_raporu_${app.helpers.getTodayISO()}.csv`); }
    };
    
    // --- BÖLÜM 7: UYGULAMA BAŞLATMA ---
    main.hideAllAuth = () => {
        app.dom.setupContainer.style.display = 'none';
        app.dom.loginChoiceContainer.style.display = 'none';
        app.dom.adminLoginContainer.style.display = 'none';
        app.dom.personelLoginContainer.style.display = 'none';
    };
    main.showLoginChoice = () => {
        main.hideAllAuth();
        app.dom.loginChoiceContainer.style.display = 'block';
    };
    main.runAfterLogin = () => {
        main.attachEventListeners();
        app.dom.uretimTarihInput.value = app.helpers.getTodayISO();
        app.dom.giderForm.querySelector('#gider-tarih').value = app.helpers.getTodayISO();
        app.dom.personelIslemForm.querySelector('#personel-ise-alim-tarihi').value = app.helpers.getTodayISO();
        
        // SGK Input Toggle
        app.dom.personelSgkDurumu.addEventListener('change', (e) => {
            if(e.target.value === 'Var') {
                app.dom.personelSgkTutarGroup.style.display = 'block';
            } else {
                app.dom.personelSgkTutarGroup.style.display = 'none';
            }
        });

        renderer.updateForRole(); 
        renderer.updateAll(); 
    };
    main.attachEventListeners = () => {
        app.dom.logoutBtn.addEventListener('click', actions.logout);
        app.dom.navLinks.forEach(link => link.addEventListener('click', actions.navigate));
        app.dom.fabrikaForm.addEventListener('submit', actions.addFactory);
        app.dom.listeyeEkleBtn.addEventListener('click', actions.addUretimToList);
        app.dom.giderForm.addEventListener('submit', actions.addExpense);
        app.dom.modalCloseBtn.addEventListener('click', actions.closeModal);
        app.dom.uretimAdetInput.addEventListener('input', actions.updateUretimToplam);
        app.dom.uretimBirimFiyatInput.addEventListener('input', actions.updateUretimToplam);
        app.dom.tumunuKaydetBtn.addEventListener('click', actions.saveUretimListesi);
        app.dom.listeyiTemizleBtn.addEventListener('click', actions.clearUretimListesi);
        app.dom.fabrikaSilForm.addEventListener('submit', actions.handleFabrikaSilSubmit);
        app.dom.sifreDegistirForm.addEventListener('submit', actions.changePassword);
        app.dom.yeniVardiyaForm.addEventListener('submit', actions.startShift);
        app.dom.vardiyaKapatBtn.addEventListener('click', actions.endShift);
        app.dom.vardiyaDevretModalBtn.addEventListener('click', actions.transferShift);
        // Yeni: vardiya personel yönetimi
        app.dom.vardiyaPersonelYonetBtn.addEventListener('click', actions.manageShiftPersonnel);
        app.dom.pozisyonEkleForm.addEventListener('submit', actions.addPosition);
        app.dom.personelIslemForm.addEventListener('submit', actions.handlePersonelFormSubmit);
        app.dom.personelIslemSelect.addEventListener('change', actions.handlePersonelFormLoad);
        app.dom.personelListesiContainer.addEventListener('click', (e) => { 
            const silBtn = e.target.closest('button.personel-sil-btn');
            const odemeBtn = e.target.closest('button.personel-odeme-btn'); 
            if (silBtn) { actions.deleteWorker(parseInt(silBtn.dataset.id)); }
            if (odemeBtn) { actions.openPersonelOdemeModal(parseInt(odemeBtn.dataset.id), odemeBtn.dataset.name); }
        });

        app.dom.pozisyonListesiContainer.addEventListener('click', (e) => { const target = e.target.closest('button.pozisyon-sil-btn'); if (target) { actions.deletePosition(target.dataset.id, target.dataset.kullanim); } });
        // --- DÜZELTİLMİŞ SİLME KODU BAŞLANGIÇ ---
        app.dom.vardiyaGecmisiContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button.vardiya-sil-btn');
            if (target) {
                // actions.deleteShift çağırmak yerine işi burada bitiriyoruz:
                const id = parseInt(target.dataset.id);
                const shift = app.data.vardiyalar.find(v => v.id === id);
                
                if (!shift) {
                    alert("Hata: Vardiya bulunamadı.");
                    return;
                }

                if (confirm("Bu vardiya kaydını kalıcı olarak silmek istediğinizden emin misiniz?")) {
                    // Silme işlemi
                    app.data.vardiyalar = app.data.vardiyalar.filter(v => v.id !== id);
                    dataManager.save();
                    renderer.vardiyaGecmisi(); // Tabloyu yenile
                }
            }
        });
        // --- DÜZELTİLMİŞ SİLME KODU BİTİŞ ---
        app.dom.kayitListesiContainer.addEventListener('click', (e) => { const target = e.target.closest('button.temp-sil-btn'); if (target) { actions.removeUretimFromList(parseInt(target.dataset.index)); } });
        app.dom.fabrikaHesapTabloContainer.addEventListener('click', (e) => { const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; const name = target.dataset.name; if (target.classList.contains('odeme-al-btn')) actions.openOdemeModal(id, name); if (target.classList.contains('fabrika-csv-btn')) csvManager.downloadFabrika(parseInt(id), name); if (target.classList.contains('reset-hesap-btn')) actions.resetFactory(id, name); });
        app.dom.sonUretimlerContainer.addEventListener('click', (e) => { const target = e.target.closest('button.uretim-sil-btn'); if(target) { actions.deleteProduction(target.dataset.id); } });
        app.dom.giderTabloContainer.addEventListener('click', (e) => { const target = e.target.closest('button.gider-sil-btn'); if (target) { actions.deleteExpense(target.dataset.id); } });
        app.dom.genelCsvIndirBtn.addEventListener('click', csvManager.downloadGenel);
        app.dom.giderCsvIndirBtn.addEventListener('click', csvManager.downloadGiderler);
        // Yeni: aktif vardiyada çalışan çıkarma butonları dinle
        app.dom.aktifVardiyaDetaylari.addEventListener('click', (e) => {
            const btn = e.target.closest('button.calisan-cikart-btn');
            if (btn) {
                const pid = parseInt(btn.dataset.personelId);
                if (!isNaN(pid)) {
                    actions.removeWorkerFromActiveShift(pid);
                    dataManager.save();
                    renderer.updateAll();
                }
            }
        });

        // Haftalık izin planlama formu için dinleyici
        if (app.dom.izinPlanForm) {
            app.dom.izinPlanForm.addEventListener('submit', actions.addManualLeave);
        }
        // main.attachEventListeners fonksiyonunun içine ekleyin:

// Stok Ekleme Formu
const stokForm = document.getElementById('stok-ekle-form');
if (stokForm) stokForm.addEventListener('submit', actions.stokEkle);

// Stok Tablosu Butonları (Giriş/Çıkış/Sil)
const stokContainer = document.getElementById('stok-tablo-container');
if (stokContainer) {
    stokContainer.addEventListener('click', (e) => {
        const girisBtn = e.target.closest('.stok-giris-btn');
        const cikisBtn = e.target.closest('.stok-cikis-btn');
        const silBtn = e.target.closest('.stok-sil-btn');
        
        if (girisBtn) actions.stokIslemModalAc(girisBtn.dataset.id, 'giris');
        if (cikisBtn) actions.stokIslemModalAc(cikisBtn.dataset.id, 'cikis');
        if (silBtn) actions.stokSil(silBtn.dataset.id);
    });
}

// Stok Arama Kutusu
const stokAra = document.getElementById('stok-ara');
if (stokAra) {
    stokAra.addEventListener('input', () => {
        renderer.stokListesi();
    });
}
// Stok Geçmişi Arama Kutusu
        const stokGecmisiAra = document.getElementById('stok-gecmisi-ara');
        if (stokGecmisiAra) {
            stokGecmisiAra.addEventListener('input', () => {
                renderer.stokGecmisi();
            });
        }
    };
    // Uygulama başlangıcında verileri yüklemek için ana boot fonksiyonu
    main.boot = async () => {
        // Form Dinleyicilerini Başlat
        document.getElementById('saas-register-form').addEventListener('submit', saas.register);
        document.getElementById('saas-login-form').addEventListener('submit', saas.login);
        document.getElementById('saas-admin-login-form').addEventListener('submit', saas.adminLogin);

        // Ana uygulama veri yüklemesini burada yapmıyoruz. 
        // Kullanıcı şirkete giriş yaptığında (saas.login içinde) main.boot tekrar çağrılacak ama veri yüklemesiyle.
        
        if (saas.currentCompanyId) {
            // Şirket girişi yapılmış, normal akışı başlat
            await dataManager.load();
            main.hideAllAuth();
            
            // Yönetici kontrolü (Mevcut kodunuzdaki gibi)
            let adminExists = false;
            try {
                adminExists = app.data.personel.some(p => {
                    const pos = app.data.pozisyonlar.find(pos => pos.id === p.pozisyonId);
                    return pos && pos.ad && pos.ad.toLowerCase() === 'yönetici';
                });
            } catch (e) { adminExists = false; }

            if (!adminExists) {
                app.dom.setupContainer.style.display = 'block';
                // Eski event listener'ları ekle
                if (app.dom.setupForm) app.dom.setupForm.addEventListener('submit', actions.setup);
            } else {
                app.dom.loginChoiceContainer.style.display = 'block';
                // Eski event listener'ları ekle
                app.dom.btnAdminLoginChoice.addEventListener('click', () => {
                    main.hideAllAuth();
                    app.dom.adminLoginContainer.style.display = 'block';
                });
                app.dom.btnPersonelLoginChoice.addEventListener('click', () => {
                    main.hideAllAuth();
                    app.dom.personelLoginContainer.style.display = 'block';
                });
                if (app.dom.adminLoginForm) app.dom.adminLoginForm.addEventListener('submit', actions.adminLogin);
                if (app.dom.personelLoginForm) app.dom.personelLoginForm.addEventListener('submit', actions.personelLogin);
            }
        } else {
            // Henüz şirket girişi yapılmamış, SAAS Landing sayfasını göster
            saas.showLanding();
        }
    };

    // --- SİSTEM BAĞLANTILARI (BUNU EKLEMEZSENİZ BUTONLAR ÇALIŞMAZ) ---
window.app = app;
// --- STOK YÖNETİMİ VE GEÇMİŞİ ENTEGRASYONU ---

// 1. Veri Yapısını Hazırla
if (!app.data.stoklar) app.data.stoklar = [];
if (!app.data.stokHareketleri) app.data.stokHareketleri = [];

// 2. Renderer (Görünüm) Fonksiyonları
// --- JAVASCRIPT: REÇETE VE OTOMATİK DÜŞÜM SİSTEMİ ---



// 6. ÜRETİMİ KAYDETME FONKSİYONUNU GÜNCELLE
// (Eski fonksiyonu ezip yenisini tanımlıyoruz)

// renderer.stokListesi FONKSİYONUNU KOMPLE BUNUNLA DEĞİŞTİRİN:
renderer.stokListesi = function() {
    const container = document.getElementById('stok-tablo-container');
    if (!container) return;
    
    const arama = document.getElementById('stok-ara') ? document.getElementById('stok-ara').value.toLowerCase() : '';
    const stoklar = (app.data.stoklar || []).filter(s => s.ad.toLowerCase().includes(arama));

    if (stoklar.length === 0) {
        container.innerHTML = '<p class="no-data-message">Kayıtlı stok bulunamadı.</p>';
        renderer.stokOzetGuncelle();
        return;
    }

    // --- TABLO BAŞLIKLARI (Üretim Alanı Sütunu Eklendi) ---
    let html = `
    <table>
        <thead>
            <tr>
                <th>Durum</th>
                <th>Ürün Adı</th>
                <th>Kategori</th>
                <th>Toplam Mevcut</th>
                <th style="background:#eaf6ff; color:#2980b9;">Ana Depo</th>
                <th style="background:#e8f8f5; color:#16a085;">Soğuk Hava</th>
                <th style="background:#f4ecf7; color:#8e44ad;">Donuk Depo</th>
                <th style="background:#fff7e6; color:#d35400;">Üretim Alanı</th> <th>Birim Fiyat</th>
                <th>Toplam Değer</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody>`;

    stoklar.sort((a,b) => a.ad.localeCompare(b.ad)).forEach(s => {
        // --- MİGRASYON ---
        if (!s.depolar) {
            s.depolar = { "Ana Depo": parseFloat(s.miktar) || 0 };
        }
        
        // Miktarları Çek
        const anaDepoMiktari = s.depolar["Ana Depo"] || 0;
        const sogukHavaMiktari = s.depolar["Soguk Hava Deposu"] || 0;
        const donukDepoMiktari = s.depolar["Donuk Depo"] || 0;
        const uretimAlaniMiktari = s.depolar["Uretim Alani"] || 0; // YENİ VERİ
        
        // Toplamı Güncelle
        const toplamMiktar = Object.values(s.depolar).reduce((acc, curr) => acc + curr, 0);
        s.miktar = toplamMiktar;

        const kritik = parseFloat(s.kritikSeviye || 0);
        const fiyat = parseFloat(s.alisFiyati || 0);
        const toplamDeger = toplamMiktar * fiyat;
        const kilitli = s.sayimKilitli === true;
        const isPasif = s.durum === 'Pasif';

        // Stil
        let trStyle = '';
        let durumBadge = '';
        let miktarStyle = 'font-weight:bold; font-size:15px;';

        if (kilitli) {
            trStyle = 'background-color: #fff8e1; border-left: 4px solid #f1c40f;'; 
            durumBadge = '<span class="status-badge status-Pending">🔒 SAYIMDA</span>';
        } else if (isPasif) {
            trStyle = 'background-color: #f3f3f3; color: #999;'; 
            durumBadge = '<span class="status-badge" style="background:#ddd; color:#666;">PASİF</span>';
            miktarStyle += ' color: #999;';
        } else if (toplamMiktar <= kritik) {
            trStyle = 'background-color: #ffecec; border-left: 4px solid #e74c3c;';
            durumBadge = '<span class="status-badge status-Suspended">KRİTİK !!!</span>';
            miktarStyle += ' color: #c0392b;';
        } else {
            durumBadge = '<span class="status-badge status-Active">AKTİF</span>';
            miktarStyle += ' color: var(--success-color);';
        }

        const btnDisabled = (kilitli || isPasif) ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : '';
        const sayimBtn = kilitli 
            ? `<button class="btn-sm-primary" onclick="actions.stokSayimModalAc(${s.id})">📝 Onayla</button>`
            : `<button class="btn-sm-warning" ${isPasif ? 'disabled' : ''} onclick="actions.stokSayimBaslat(${s.id})">🔒 Sayım</button>`;

        html += `
            <tr style="${trStyle}">
                <td>${durumBadge}</td>
                <td style="font-weight:600;">${s.ad}</td>
                <td>${s.kategori}</td>
                <td style="${miktarStyle}">
                    ${toplamMiktar.toFixed(2)} <small>${s.birim}</small>
                    ${!isPasif && toplamMiktar <= kritik ? '<br><small style="color:red;">(Kritik: ' + kritik + ')</small>' : ''}
                </td>
                <td style="background:#f4faff; font-weight:bold; color:#2980b9;">
                    ${anaDepoMiktari.toFixed(2)}
                </td>
                <td style="background:#f0fdf4; font-weight:bold; color:#16a085;">
                    ${sogukHavaMiktari.toFixed(2)}
                </td>
                <td style="background:#fcf4ff; font-weight:bold; color:#8e44ad;">
                    ${donukDepoMiktari.toFixed(2)}
                </td>
                <td style="background:#fff7e6; font-weight:bold; color:#d35400;">
                    ${uretimAlaniMiktari.toFixed(2)} </td>
                <td>${app.helpers.formatCurrency(fiyat)}</td>
                <td>${app.helpers.formatCurrency(toplamDeger)}</td>
                <td>
                    <button class="btn-sm-success" ${btnDisabled} onclick="actions.stokIslemModalAc(${s.id}, 'giris')">➕</button>
                    <button class="btn-sm-danger" ${btnDisabled} onclick="actions.stokIslemModalAc(${s.id}, 'cikis')">➖</button>
                    ${sayimBtn}
                    <button class="btn-sm-danger" onclick="actions.stokSil(${s.id})">🗑️</button>
                </td>
            </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
    renderer.stokOzetGuncelle();
};

// renderer.stokGecmisiListesi FONKSİYONUNU BUNUNLA DEĞİŞTİR:

renderer.stokGecmisiListesi = function() {
    const container = document.getElementById('stok-gecmis-container');
    if (!container) return;
    
    const hareketler = (app.data.stokHareketleri || []).sort((a,b) => new Date(b.tarih) - new Date(a.tarih));

    if (hareketler.length === 0) {
        container.innerHTML = '<p class="no-data-message">Henüz bir hareket kaydı yok.</p>';
        return;
    }

    // Tablo başlıklarına Lot/SKT eklendi
    let html = `
    <table>
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Ürün</th>
                <th>İşlem</th>
                <th>Lot / SKT</th> 
                <th>Miktar</th>
                <th>Açıklama</th>
                <th>İşlemler</th> 
            </tr>
        </thead>
        <tbody>`;

    hareketler.forEach(h => {
        const tarih = app.helpers.formatDateTime(h.tarih);
        const isGiris = h.tip === 'giris';
        const tipBadge = isGiris 
            ? '<span class="status-badge status-Active">GİRİŞ</span>' 
            : '<span class="status-badge status-Suspended">ÇIKIŞ</span>';
        const miktarRenk = isGiris ? 'green' : 'red';
        const isaret = isGiris ? '+' : '-';
        
        // Lot ve SKT Gösterimi Tasarımı
        let lotBilgisi = '-';
        if (h.lotNo || h.skt) {
            lotBilgisi = `<div style="font-size:12px; line-height:1.4;">`;
            if(h.lotNo) lotBilgisi += `<div style="color:#d35400;"><strong>Lot:</strong> ${h.lotNo}</div>`;
            if(h.skt) {
                const sktDate = new Date(h.skt);
                const today = new Date();
                const isExpired = sktDate < today;
                // SKT geçmişse kırmızı, geçmemişse siyah
                const color = isExpired ? 'red' : '#555';
                const warning = isExpired ? ' ⚠️ DOLDU' : '';
                lotBilgisi += `<div style="color:${color};"><strong>SKT:</strong> ${sktDate.toLocaleDateString('tr-TR')}${warning}</div>`;
            }
            lotBilgisi += `</div>`;
        }

        html += `
            <tr>
                <td>${tarih}</td>
                <td style="font-weight:600;">${h.urunAdi}</td>
                <td>${tipBadge}</td>
                <td>${lotBilgisi}</td>
                <td style="color:${miktarRenk}; font-weight:bold; font-size:15px;">${isaret}${h.miktar} ${h.birim || ''}</td>
                <td style="font-size:13px; color:#555;">${h.aciklama}</td>
                <td>
                    <button class="btn-sm-danger" onclick="actions.stokGecmisSil(${h.id})">Sil</button>
                </td>
            </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
};

renderer.stokOzetGuncelle = function() {
    const stoklar = app.data.stoklar || [];
    const toplamKalem = stoklar.length;
    const kritik = stoklar.filter(s => (s.miktar || 0) <= (s.kritikSeviye || 0)).length;
    const deger = stoklar.reduce((acc, s) => acc + ((s.miktar || 0) * (s.alisFiyati || 0)), 0);

    if(document.getElementById('stok-toplam-kalem')) document.getElementById('stok-toplam-kalem').innerText = toplamKalem;
    if(document.getElementById('stok-kritik-sayi')) document.getElementById('stok-kritik-sayi').innerText = kritik;
    if(document.getElementById('stok-toplam-deger')) document.getElementById('stok-toplam-deger').innerText = app.helpers.formatCurrency(deger);
};

renderer.stokGecmisiIndir = function() {
    let csv = 'Tarih,Urun Adi,Islem Tipi,Miktar,Birim,Kalan Stok,Aciklama\n';
    (app.data.stokHareketleri || []).forEach(h => {
        csv += `${h.tarih},"${h.urunAdi}",${h.tip},${h.miktar},${h.birim},${h.kalanStok},"${h.aciklama}"\n`;
    });
    const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `stok_gecmisi_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
};

// 3. Actions (İş Mantığı) Fonksiyonları
actions.stokKartEkle = function(e) {
    if(e) e.preventDefault();
    const ad = document.getElementById('stok-adi').value.trim();
    if (!ad) return alert('Ürün adı yazmalısınız.');

    if (!app.data.stoklar) app.data.stoklar = [];
    
    const yeniStok = {
        id: Date.now(),
        ad: ad,
        kategori: document.getElementById('stok-kategori').value,
        birim: document.getElementById('stok-birim').value,
        miktar: 0,
        kritikSeviye: parseFloat(document.getElementById('stok-kritik').value) || 10,
        alisFiyati: parseFloat(document.getElementById('stok-fiyat').value) || 0
    };
    
    app.data.stoklar.push(yeniStok);
    dataManager.save();
    document.getElementById('stok-ekle-form').reset();
    renderer.stokListesi();
    alert('Stok kartı açıldı.');
};



actions.stokGecmisSil = function(id) {
    if(confirm('Bu işlem kaydını silmek istediğinize emin misiniz? (Bu işlem sadece kayıt logunu siler, stok miktarını değiştirmez.)')) {
        // İlgili ID'ye sahip kaydı listeden çıkar
        app.data.stokHareketleri = app.data.stokHareketleri.filter(h => h.id !== id);
        
        // Veriyi kaydet
        dataManager.save();
        
        // Tabloyu yenile
        renderer.stokGecmisiListesi();
        
        // Kullanıcıya bilgi ver (Opsiyonel)
        // alert('Kayıt silindi.');
    }
};

// Mal Kabul Formunda Tutar Hesaplama (Miktar * Fiyat)
actions.malKabulHesapla = function() {
    const miktarEl = document.getElementById('mk-miktar');
    const fiyatEl = document.getElementById('mk-fiyat');
    const toplamEl = document.getElementById('mk-toplam');

    // Eğer bu elemanlar sayfada yoksa (örn: çıkış ekranındaysak) işlem yapma
    if (!miktarEl || !fiyatEl || !toplamEl) return;

    const miktar = parseFloat(miktarEl.value) || 0;
    const fiyat = parseFloat(fiyatEl.value) || 0;
    const toplam = miktar * fiyat;

    toplamEl.value = app.helpers.formatCurrency(toplam);
};
// --- ORTAK KAYDETME FONKSİYONU (YENİLENMİŞ) ---

// --- 1. MAL KABUL HESAPLAMA FONKSİYONU ---
// Miktar veya Fiyat değişince Toplam Tutarı otomatik hesaplar
actions.malKabulHesapla = function() {
    // Elemanları güvenli şekilde seçiyoruz
    const miktarInput = document.getElementById('mk-miktar');
    const fiyatInput = document.getElementById('mk-fiyat');
    const toplamInput = document.getElementById('mk-toplam');
    
    // Eğer bu elemanlar sayfada yoksa (örn: çıkış ekranındaysak) işlem yapma
    if (!miktarInput || !fiyatInput || !toplamInput) return;

    const miktar = parseFloat(miktarInput.value) || 0;
    const fiyat = parseFloat(fiyatInput.value) || 0;
    
    // Toplamı hesapla ve para birimi formatında yazdır
    toplamInput.value = app.helpers.formatCurrency(miktar * fiyat);
};

// --- 2. STOK HAREKET KAYDETME FONKSİYONU (YENİLENMİŞ) ---
// Hem giriş (Mal Kabul) hem çıkış işlemlerini yönetir ve hataları önler

// actions.stokSil FONKSİYONUNU BUNUNLA DEĞİŞTİRİN:

actions.stokSil = function(stokId) {
    const stok = app.data.stoklar.find(s => s.id === parseInt(stokId));
    if (!stok) return;

    if (confirm(`'${stok.ad}' stok kartını VE BU KARTA AİT TÜM GEÇMİŞ HAREKETLERİ silmek istediğinize emin misiniz?\n\n(Bu işlem Lot numaralarını boşa çıkaracaktır)`)) {
        const id = parseInt(stokId);
        
        // 1. Stok Kartını Sil
        app.data.stoklar = app.data.stoklar.filter(s => s.id !== id);
        
        // 2. Bu stoğa ait TÜM hareketleri (Giriş/Çıkış loglarını) sil
        // Böylece bu stokta kullanılan Lot numaraları tekrar kullanılabilir hale gelir.
        if (app.data.stokHareketleri) {
            app.data.stokHareketleri = app.data.stokHareketleri.filter(h => h.stokId !== id);
        }

        dataManager.save();
        renderer.stokListesi();
        
        // Eğer geçmiş sekmesi açıksa orayı da yenile
        if (typeof renderer.stokGecmisiListesi === 'function') {
            renderer.stokGecmisiListesi();
        }
        
        alert('Stok kartı ve geçmişi temizlendi.');
    }
};

actions.stokEkle = function(e) {
    e.preventDefault();
    if (!app.data.stoklar) app.data.stoklar = [];
    
    const ad = document.getElementById('stok-adi').value.trim();
    if (!ad) { alert('Ürün adı zorunludur.'); return; }
    
    const miktarInput = document.getElementById('stok-miktar');
    const baslangicMiktari = miktarInput ? (parseFloat(miktarInput.value) || 0) : 0;

    const yeniStok = {
        id: Date.now(),
        ad: ad,
        kategori: document.getElementById('stok-kategori').value,
        birim: document.getElementById('stok-birim').value,
        miktar: baslangicMiktari,
        kritikSeviye: parseFloat(document.getElementById('stok-kritik').value) || 10,
        durum: document.getElementById('stok-durum').value, // YENİ ALAN
        alisFiyati: parseFloat(document.getElementById('stok-fiyat').value) || 0,
        sayimKilitli: false
    };
    
    // Açılış bakiyesi varsa hareketlere ekle
    if (baslangicMiktari > 0) {
        if (!app.data.stokHareketleri) app.data.stokHareketleri = [];
        app.data.stokHareketleri.push({
            id: Date.now(),
            stokId: yeniStok.id,
            urunAdi: yeniStok.ad,
            birim: yeniStok.birim,
            tip: 'giris',
            miktar: baslangicMiktari,
            kalanStok: baslangicMiktari,
            tarih: new Date().toISOString(),
            aciklama: 'Stok Kartı Açılış Bakiyesi'
        });
    }
    
    app.data.stoklar.push(yeniStok);
    dataManager.save();
    document.getElementById('stok-ekle-form').reset();
    renderer.stokListesi();
    alert('Stok kartı oluşturuldu.');
};

// --- 1. Gelişmiş Stok Giriş/Çıkış Modalı (Neden Seçmeli) ---



// --- 2. Sayım Başlatma (Kilitleme) ---
actions.stokSayimBaslat = function(id) {
    const stok = app.data.stoklar.find(s => s.id == id);
    if (!stok) return;

    if(confirm(`${stok.ad} için sayım sürecini başlatmak istiyor musunuz?\n\nUYARI: Sayım onaylanana kadar bu ürün kilitlenecek ve stok giriş/çıkışı yapılamayacaktır.`)) {
        stok.sayimKilitli = true;
        stok.sayimBaslangic = new Date().toISOString();
        dataManager.save();
        renderer.stokListesi();
    }
};

// --- 3. Sayım Modalı (Detaylı Giriş) ---
actions.stokSayimModalAc = function(id) {
    const stok = app.data.stoklar.find(s => s.id == id);
    if (!stok) return;

    const html = `
        <div style="background:#fff8e1; padding:15px; border-radius:8px; border:1px solid #f1c40f; margin-bottom:20px;">
            <h3 style="margin-top:0;">🔒 Sayım Onay Ekranı</h3>
            <p style="font-size:14px;">Aşağıdaki bilgileri doldurarak sayım kilidini kaldırabilir ve stoğu güncelleyebilirsiniz.</p>
        </div>

        <form id="sayim-onay-form">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div class="input-group">
                    <label>Sistem Stoğu (Mevcut)</label>
                    <input type="text" value="${stok.miktar} ${stok.birim}" disabled style="background:#eee; font-weight:bold;">
                </div>
                <div class="input-group">
                    <label>Fiziksel Sayım (Gerçek)</label>
                    <input type="number" id="sayim-fiziksel" step="0.01" required style="font-weight:bold; color:blue;" oninput="actions.sayimFarkHesapla(${stok.miktar})">
                </div>
            </div>

            <div style="background:#f8f9fa; padding:10px; border-radius:5px; margin-bottom:15px; text-align:center;">
                <strong>Sayım Farkı:</strong> <span id="sayim-fark-goster" style="font-size:18px;">0</span> ${stok.birim}
            </div>

            <div class="input-group">
                <label>Fark Nedeni (Zorunlu)</label>
                <select id="sayim-neden" required>
                    <option value="" disabled selected>Seçiniz...</option>
                    <option value="Normal (Fark Yok)">Normal (Fark Yok)</option>
                    <option value="Sayım Eksiği (Kayıp)">Sayım Eksiği (Kayıp)</option>
                    <option value="Sayım Fazlası">Sayım Fazlası</option>
                    <option value="Hatalı Kayıt Düzeltmesi">Hatalı Kayıt Düzeltmesi</option>
                    <option value="Bozulma / İmha">Bozulma / İmha</option>
                </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="input-group">
                    <label>Sayımı Yapan Personel</label>
                    <input type="text" id="sayim-yapan" placeholder="Ad Soyad" required>
                </div>
                <div class="input-group">
                    <label>Onaylayan Yönetici</label>
                    <input type="text" id="sayim-onaylayan" placeholder="Ad Soyad" required>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-full">✅ Sayımı Onayla ve Stoğu Güncelle</button>
            <button type="button" class="btn btn-danger btn-full" style="margin-top:10px;" onclick="actions.sayimIptal(${stok.id})">❌ İptal Et (Kilidi Aç)</button>
        </form>
    `;

    actions.openModal(`Sayım: ${stok.ad}`, html);

    setTimeout(() => {
        document.getElementById('sayim-onay-form').addEventListener('submit', (e) => {
            e.preventDefault();
            actions.sayimKaydet(stok.id);
        });
    }, 100);
};

// --- 4. Sayım Yardımcıları ---
actions.sayimFarkHesapla = function(sistemStogu) {
    const fiziksel = parseFloat(document.getElementById('sayim-fiziksel').value) || 0;
    const fark = fiziksel - sistemStogu;
    const span = document.getElementById('sayim-fark-goster');
    
    span.innerText = fark.toFixed(2);
    if(fark < 0) span.style.color = 'red';
    else if(fark > 0) span.style.color = 'green';
    else span.style.color = 'black';
};

actions.sayimKaydet = function(id) {
    const stok = app.data.stoklar.find(s => s.id == id);
    if (!stok) return;

    const fiziksel = parseFloat(document.getElementById('sayim-fiziksel').value);
    const neden = document.getElementById('sayim-neden').value;
    const yapan = document.getElementById('sayim-yapan').value;
    const onaylayan = document.getElementById('sayim-onaylayan').value;
    const eskiStok = stok.miktar;
    const fark = fiziksel - eskiStok;

    if (isNaN(fiziksel)) { alert("Lütfen fiziksel sayım miktarını girin."); return; }

    // Stoğu Güncelle
    stok.miktar = fiziksel;
    stok.sayimKilitli = false; // Kilidi kaldır
    delete stok.sayimBaslangic;

    // Log Kaydı Oluştur
    if (!app.data.stokHareketleri) app.data.stokHareketleri = [];
    app.data.stokHareketleri.push({
        id: Date.now(),
        stokId: stok.id,
        urunAdi: stok.ad,
        birim: stok.birim,
        tip: 'sayim',
        miktar: fark, // Fark kadar hareket yazılır (Örn: -5 veya +10)
        kalanStok: fiziksel,
        tarih: new Date().toISOString(),
        aciklama: `[SAYIM ONAYI] Sistem: ${eskiStok} -> Fiziksel: ${fiziksel}. Neden: ${neden}. (Yapan: ${yapan}, Onay: ${onaylayan})`
    });

    dataManager.save();
    actions.closeModal();
    renderer.stokListesi();
    renderer.stokGecmisiListesi(); // Geçmiş tablosunu yenile
    alert("Sayım başarıyla onaylandı ve stok güncellendi.");
};

actions.sayimIptal = function(id) {
    if(confirm("Sayım işlemini iptal edip kilidi açmak istiyor musunuz? Stok güncellenmeyecektir.")) {
        const stok = app.data.stoklar.find(s => s.id == id);
        if (stok) {
            stok.sayimKilitli = false;
            dataManager.save();
            renderer.stokListesi();
            actions.closeModal();
        }
    }
};

// Mal Kabul Formunda Tutar Hesaplama
actions.malKabulHesapla = function() {
    const miktar = parseFloat(document.getElementById('mk-miktar').value) || 0;
    const fiyat = parseFloat(document.getElementById('mk-fiyat').value) || 0;
    const toplamInput = document.getElementById('mk-toplam');
    
    if (toplamInput) {
        toplamInput.value = app.helpers.formatCurrency(miktar * fiyat);
    }
};

// --- DÜZELTME PAKETİ: MODAL VE KAYIT SİSTEMİ (v6.0) ---

// 1. Modalı Açan Fonksiyon (ID ve Tipleri Doğru Ayarlar)

// actions.stokIslemModalAc FONKSİYONUNU KOMPLE BUNUNLA DEĞİŞTİRİN:
actions.stokIslemModalAc = function(id, tip) {
    const stok = app.data.stoklar.find(s => s.id == id);
    if (!stok) return;

    if (stok.sayimKilitli) {
        alert("BU ÜRÜN ŞU AN SAYIMDA! İşlem yapılamaz.");
        return;
    }

    const isGiris = tip === 'giris';
    const baslik = isGiris ? '📦 MAL KABUL (GİRİŞ)' : '📤 STOK ÇIKIŞI & FİRE';
    const renk = isGiris ? 'btn-success' : 'btn-danger';
    const btnMetni = isGiris ? 'Mal Kabulünü Kaydet' : 'Çıkışı Kaydet';
    
    // Tarih ve Kullanıcı
    const simdi = new Date();
    simdi.setMinutes(simdi.getMinutes() - simdi.getTimezoneOffset());
    const varsayilanTarih = simdi.toISOString().slice(0, 16);
    const aktifKullanici = app.currentUser ? app.currentUser.ad : 'Sistem';

    // Depo Seçenekleri (Önceki adımdan gelen)
    const depoSecenekleri = `
        <option value="Ana Depo">Ana Depo</option>
        <option value="Soguk Hava Deposu">Soğuk Hava Deposu</option>
        <option value="Donuk Depo">Donuk Depo</option>
        <option value="Uretim Alani">Günlük Üretim Alanı</option>
    `;

    // --- YENİ: Fire Türleri Listesi ---
    // Şimdilik sadece Kesim Firesi aktif, diğerlerini sonra açacağız.
    const cikisTurleri = `
        <option value="Normal">✅ Normal Çıkış (Satış / Üretim)</option>
        <option value="Kesim Firesi">✂️ Kesim Firesi</option>
        <option value="Bozulma">🥀 Bozulma / Çürüme</option>
        <option value="Son Kullanma">📅 Son Kullanma Tarihi (SKT)</option>
        <option value="Uretim Hatasi">⚠️ Üretim Hatası</option> 
    `;

    let formIcerigi = '';

    if (isGiris) {
        // --- GİRİŞ FORMU (Değişiklik Yok) ---
        formIcerigi = `
            <div style="background:#f0fdf4; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #22c55e;">
                <h4 style="margin:0; color:#166534;">${stok.ad}</h4>
                <small>Toplam Mevcut: <strong>${stok.miktar || 0} ${stok.birim}</strong></small>
            </div>
            
            <div class="input-group" style="border: 2px solid #3498db; padding: 5px; border-radius: 5px; background: #eaf6ff;">
                <label style="color:#2980b9; font-weight:bold;">Hangi Depoya Giriş Yapılacak?</label>
                <select id="islem-depo" style="font-weight:bold;">
                    ${depoSecenekleri}
                </select>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px; background:#fffbe6; padding:10px; border:1px solid #ffe58f; border-radius:5px; margin-bottom:10px;">
                <div class="input-group" style="margin-bottom:0;">
                    <label style="color:#d48806; font-weight:bold;">Lot / Parti No</label>
                    <input type="text" id="mk-lot" placeholder="Lot No" style="border:1px solid #ffe58f; font-weight:bold;">
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label style="color:#d48806; font-weight:bold;">Üretim Tarihi</label>
                    <input type="date" id="mk-uretim-tarihi" style="border:1px solid #ffe58f;">
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label style="color:#d48806; font-weight:bold;">Son Kul. Tarihi</label>
                    <input type="date" id="mk-skt" style="border:1px solid #ffe58f;">
                </div>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="input-group">
                    <label>Tedarikçi Firma</label>
                    <input type="text" id="mk-tedarikci" placeholder="Firma Adı" required>
                </div>
                <div class="input-group">
                    <label>Fatura / İrsaliye No</label>
                    <input type="text" id="mk-fatura" placeholder="Belge No" required>
                </div>
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <div class="input-group">
                    <label>Miktar (${stok.birim})</label>
                    <input type="number" id="mk-miktar" step="0.01" placeholder="0" required oninput="actions.malKabulHesapla()">
                </div>
                <div class="input-group">
                    <label>Birim Fiyat (₺)</label>
                    <input type="number" id="mk-fiyat" step="0.01" value="${stok.alisFiyati || 0}" required oninput="actions.malKabulHesapla()">
                </div>
                <div class="input-group">
                    <label>Toplam</label>
                    <input type="text" id="mk-toplam" disabled style="background:#eee; font-weight:bold;" value="0.00 ₺">
                </div>
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="input-group">
                    <label>Tarih & Saat</label>
                    <input type="datetime-local" id="mk-tarih" value="${varsayilanTarih}" required>
                </div>
                <div class="input-group">
                    <label>Kabul Eden</label>
                    <input type="text" id="mk-kabul-eden" value="${aktifKullanici}" required>
                </div>
            </div>`;
    } else {
        // --- ÇIKIŞ FORMU (GÜNCELLENDİ: FİRE TÜRÜ EKLENDİ) ---
        formIcerigi = `
            <div style="background:#fee2e2; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #ef4444;">
                <h4 style="margin:0; color:#991b1b;">${stok.ad}</h4>
                <small>Toplam Mevcut: <strong>${stok.miktar || 0} ${stok.birim}</strong></small>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="input-group" style="border: 2px solid #e74c3c; padding: 5px; border-radius: 5px; background: #fff5f5;">
                    <label style="color:#c0392b; font-weight:bold;">Hangi Depodan?</label>
                    <select id="islem-depo" style="font-weight:bold;">
                        ${depoSecenekleri}
                    </select>
                </div>
                
                <div class="input-group" style="border: 2px solid #d35400; padding: 5px; border-radius: 5px; background: #fff7e6;">
                    <label style="color:#d35400; font-weight:bold;">İşlem Türü</label>
                    <select id="cikis-turu" style="font-weight:bold;">
                        ${cikisTurleri}
                    </select>
                </div>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px; background:#fff1f0; padding:10px; border:1px solid #ffa39e; border-radius:5px; margin-bottom:10px;">
                <div class="input-group" style="margin-bottom:0;">
                    <label style="color:#cf1322; font-weight:bold;">Lot No</label>
                    <input type="text" id="cikis-lot" placeholder="Varsa Lot No" style="border:1px solid #ffa39e; font-weight:bold;">
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label style="color:#cf1322; font-weight:bold;">Hedef / Sorumlu</label>
                    <input type="text" id="cikis-hedef" placeholder="Kime/Nereye?" style="border:1px solid #ffa39e;">
                </div>
            </div>

            <div class="input-group">
                <label>Çıkış Miktarı (${stok.birim})</label>
                <input type="number" id="cikis-miktar" step="0.01" placeholder="0" required>
            </div>
            <div class="input-group">
                <label>Açıklama</label>
                <input type="text" id="cikis-aciklama" placeholder="Detay yazınız..." required>
            </div>`;
    }

    const html = `
        <form id="stok-islem-form">
            <input type="hidden" id="modal-stok-id" value="${stok.id}">
            <input type="hidden" id="modal-islem-tip" value="${tip}">
            ${formIcerigi}
            <button type="submit" class="btn ${renk} btn-full" style="margin-top:15px;">${btnMetni}</button>
        </form>
    `;
    
    actions.openModal(baslik, html, isGiris);

    setTimeout(() => {
        const form = document.getElementById('stok-islem-form');
        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                actions.stokHareketKaydet(); 
            };
            if(isGiris && typeof actions.malKabulHesapla === 'function') actions.malKabulHesapla();
        }
    }, 100);
};

// 2. Otomatik Hesaplama Fonksiyonu
actions.malKabulHesapla = function() {
    const miktarEl = document.getElementById('mk-miktar');
    const fiyatEl = document.getElementById('mk-fiyat');
    const toplamEl = document.getElementById('mk-toplam');
    if (!miktarEl || !fiyatEl || !toplamEl) return;

    const miktar = parseFloat(miktarEl.value) || 0;
    const fiyat = parseFloat(fiyatEl.value) || 0;
    toplamEl.value = app.helpers.formatCurrency(miktar * fiyat);
};

// 3. Kayıt Fonksiyonu (Hata Korumalı)


// actions nesnesinin içine ekleyin:

// --- DEDEKTİF MODÜLÜ (İZLENEBİLİRLİK RAPORU) ---

// 1. Sorgulama Pencresini Açan Fonksiyon
actions.lotSorgulamaEkraniAc = function() {
    const html = `
        <div style="text-align:center; margin-bottom:20px;">
            <p style="font-size:16px; color:#555;">Bir sorun olduğunda (örn: Zehirlenme, Bozuk Ürün) o partinin tüm hikayesini görmek için Lot numarasını girin.</p>
        </div>
        
        <div class="input-group" style="max-width:400px; margin:0 auto;">
            <label style="font-weight:bold; color:#d35400;">Aranacak Lot / Parti No</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="sorgu-lot-no" placeholder="Örn: L-240212" style="font-weight:bold; font-size:18px; padding:10px;">
                <button class="btn btn-primary" onclick="actions.lotRaporuGetir()">🔍 BUL</button>
            </div>
        </div>
        
        <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
        
        <div id="lot-sonuc-alani">
            <div style="text-align:center; color:#999; padding:20px;">
                <span style="font-size:40px; display:block; margin-bottom:10px;">🕵️‍♂️</span>
                Sonuçlar burada görünecek...
            </div>
        </div>
    `;

    actions.openModal('🔍 Lot İzlenebilirlik Raporu', html, true); // true = Geniş Modal
};

// 2. Raporu Oluşturan ve Ekrana Basan Fonksiyon

// actions.lotRaporuGetir FONKSİYONUNU KOMPLE BUNUNLA DEĞİŞTİRİN:

// actions.lotRaporuGetir FONKSİYONUNU KOMPLE BUNUNLA DEĞİŞTİRİN:

actions.lotRaporuGetir = function() {
    const lotNoInput = document.getElementById('sorgu-lot-no');
    if (!lotNoInput) return;
    
    const lotNo = lotNoInput.value.trim();
    const sonucAlani = document.getElementById('lot-sonuc-alani');
    
    if (!lotNo) { 
        alert("Lütfen bir Lot numarası yazın."); 
        return; 
    }

    const hareketler = app.data.stokHareketleri || [];
    const ilgiliKayitlar = hareketler.filter(h => h.lotNo && h.lotNo.toLowerCase() === lotNo.toLowerCase());

    if (ilgiliKayitlar.length === 0) {
        sonucAlani.innerHTML = `
            <div style="padding:30px; background:#f8f9fa; text-align:center; border-radius:10px; border:2px dashed #ddd;">
                <h3 style="color:#7f8c8d;">❌ Kayıt Bulunamadı</h3>
                <p>"<strong style="color:#d35400;">${lotNo}</strong>" numaralı bir parti girişi veya çıkışı sistemde yok.</p>
            </div>`;
        return;
    }

    ilgiliKayitlar.sort((a,b) => new Date(a.tarih) - new Date(b.tarih));

    let toplamGiren = 0;
    let toplamCikan = 0;
    const urunAdi = ilgiliKayitlar[0].urunAdi; 
    const birim = ilgiliKayitlar[0].birim || 'Birim';

    let raporHtml = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; color:#2c3e50;">Parti Karnesi: <span style="color:#d35400; font-family:monospace; font-size:24px;">${lotNo.toUpperCase()}</span></h3>
            <span style="background:#ecf0f1; padding:5px 10px; border-radius:4px; font-weight:bold;">Ürün: ${urunAdi}</span>
        </div>
        <div style="display:flex; flex-direction:column; gap:15px;">
    `;

    ilgiliKayitlar.forEach(k => {
        const tarih = new Date(k.tarih).toLocaleString('tr-TR');
        const isGiris = k.tip === 'giris';
        const miktar = parseFloat(k.miktar);
        
        if(isGiris) toplamGiren += miktar;
        else toplamCikan += miktar;

        const renk = isGiris ? '#e8f8f5' : '#fdedec'; 
        const border = isGiris ? '#27ae60' : '#c0392b'; 
        const ikon = isGiris ? '⬇️ GİRİŞ (Tedarik)' : '⬆️ ÇIKIŞ (Kullanım/Satış)';
        const baslikRengi = isGiris ? '#16a085' : '#c0392b';
        
        let detay = k.aciklama;
        if (!isGiris && detay.includes('->')) {
             const parts = detay.split('->');
             if(parts.length > 1) {
                 detay = `${parts[0]} &rarr; <strong style="color:#c0392b; background:#fff; padding:2px 5px; border-radius:3px;">${parts[1]}</strong>`;
             }
        }

        // --- TARİHLERİ GÖSTEREN KUTUCUK (YENİ EKLENTİ) ---
        let tarihRozetleri = '';
        if (k.uretimTarihi) {
            tarihRozetleri += `<span style="font-size:11px; background:#e0f7fa; color:#006064; padding:2px 5px; border:1px solid #b2ebf2; border-radius:3px; margin-right:5px;">📅 ÜRT: ${new Date(k.uretimTarihi).toLocaleDateString('tr-TR')}</span>`;
        }
        if (k.skt) {
            tarihRozetleri += `<span style="font-size:11px; background:#ffebee; color:#c62828; padding:2px 5px; border:1px solid #ffcdd2; border-radius:3px;">⏳ SKT: ${new Date(k.skt).toLocaleDateString('tr-TR')}</span>`;
        }

        raporHtml += `
            <div style="background:${renk}; border-left:5px solid ${border}; padding:15px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.05); position:relative;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <strong style="color:${baslikRengi};">${ikon}</strong>
                    <span style="font-size:12px; color:#7f8c8d;">${tarih}</span>
                </div>
                <div style="font-size:20px; font-weight:bold; margin-bottom:5px;">
                    ${isGiris ? '+' : '-'}${miktar} ${birim}
                </div>
                <div style="color:#555; font-size:14px;">
                    ${detay}
                </div>
                ${tarihRozetleri ? `<div style="margin-top:8px;">${tarihRozetleri}</div>` : ''}
            </div>
        `;
    });

    raporHtml += `</div>`;

    const kalan = toplamGiren - toplamCikan;
    raporHtml += `
        <div style="margin-top:30px; background:#34495e; color:white; padding:20px; border-radius:8px; display:flex; justify-content:space-around; align-items:center; text-align:center;">
            <div>
                <div style="font-size:12px; opacity:0.8;">TOPLAM GİREN</div>
                <div style="font-size:22px; font-weight:bold; color:#2ecc71;">${toplamGiren} ${birim}</div>
            </div>
            <div style="font-size:30px; opacity:0.3;">&rarr;</div>
            <div>
                <div style="font-size:12px; opacity:0.8;">TOPLAM KULLANILAN</div>
                <div style="font-size:22px; font-weight:bold; color:#e74c3c;">${toplamCikan} ${birim}</div>
            </div>
            <div style="border-left:1px solid rgba(255,255,255,0.3); padding-left:20px;">
                <div style="font-size:12px; opacity:0.8;">BU PARTİDEN KALAN</div>
                <div style="font-size:28px; font-weight:bold; color:${kalan > 0 ? '#f1c40f' : '#ecf0f1'};">
                    ${kalan} ${birim}
                </div>
            </div>
        </div>
    `;

    sonucAlani.innerHTML = raporHtml;
};



// actions.stokHareketKaydet FONKSİYONUNU KOMPLE BUNUNLA DEĞİŞTİRİN:
actions.stokHareketKaydet = function() {
    const idEl = document.getElementById('modal-stok-id');
    const tipEl = document.getElementById('modal-islem-tip');
    const depoEl = document.getElementById('islem-depo');

    if (!idEl || !tipEl || !depoEl) { alert("Hata: Modal parametreleri bulunamadı."); return; }

    const stokId = parseInt(idEl.value);
    const tip = tipEl.value;
    const secilenDepo = depoEl.value; 
    const stok = app.data.stoklar.find(s => s.id === stokId);

    if (!stok) { alert("Stok kartı bulunamadı!"); return; }

    // Depo migrasyonu (eski veriler için)
    if (!stok.depolar) {
        stok.depolar = {};
        stok.depolar["Ana Depo"] = parseFloat(stok.miktar) || 0;
    }
    if (stok.depolar[secilenDepo] === undefined) {
        stok.depolar[secilenDepo] = 0;
    }

    let miktar = 0;
    let aciklama = '';
    let yeniFiyat = null;
    let lotNo = ''; 
    let uretimTarihi = ''; 
    let skt = '';
    let fireTuru = 'Normal'; // Varsayılan

    if (tip === 'giris') {
        // --- GİRİŞ İŞLEMİ (Değişiklik Yok) ---
        const tedarikciEl = document.getElementById('mk-tedarikci');
        const faturaEl = document.getElementById('mk-fatura');
        const miktarEl = document.getElementById('mk-miktar');
        const lotEl = document.getElementById('mk-lot'); 
        const uretimTarihiEl = document.getElementById('mk-uretim-tarihi');
        const sktEl = document.getElementById('mk-skt'); 
        
        if (!tedarikciEl || !faturaEl || !miktarEl) { alert("Form alanları yüklenemedi."); return; }

        const tedarikci = tedarikciEl.value.trim();
        const fatura = faturaEl.value.trim();
        miktar = parseFloat(miktarEl.value);
        yeniFiyat = parseFloat(document.getElementById('mk-fiyat').value);
        
        lotNo = lotEl ? lotEl.value.trim() : '';
        uretimTarihi = uretimTarihiEl ? uretimTarihiEl.value : '';
        skt = sktEl ? sktEl.value : '';

        if (lotNo) {
            const lotVarMi = app.data.stokHareketleri.some(h => 
                h.lotNo && h.lotNo.toLowerCase() === lotNo.toLowerCase()
            );
            if (lotVarMi) {
                alert(`⛔ HATA: "${lotNo}" numaralı Lot zaten kayıtlı!\n\nLütfen farklı bir Lot numarası girin.`);
                return; 
            }
        }

        if (isNaN(miktar) || miktar <= 0) { alert("Geçerli bir miktar girin."); return; }
        if (!tedarikci) { alert("Tedarikçi adı zorunludur."); return; }
        if (!fatura) { alert("Fatura No zorunludur."); return; }

        stok.depolar[secilenDepo] += miktar;
        stok.miktar = Object.values(stok.depolar).reduce((a, b) => a + b, 0);

        if (!isNaN(yeniFiyat) && yeniFiyat > 0) stok.alisFiyati = yeniFiyat;
        
        aciklama = `[MAL KABUL -> ${secilenDepo}] ${tedarikci} | Belge: ${fatura}`;
        if(lotNo) aciklama += ` | Lot: ${lotNo}`;

    } else {
        // --- ÇIKIŞ İŞLEMİ (GÜNCELLENDİ: FİRE TÜRÜ İLE) ---
        const miktarEl = document.getElementById('cikis-miktar');
        const aciklamaEl = document.getElementById('cikis-aciklama');
        const lotEl = document.getElementById('cikis-lot');     
        const hedefEl = document.getElementById('cikis-hedef');
        const turEl = document.getElementById('cikis-turu'); // YENİ
        
        if (!miktarEl || !aciklamaEl || !turEl) { alert("Form hatalı."); return; }

        miktar = parseFloat(miktarEl.value);
        let detay = aciklamaEl.value.trim();
        lotNo = lotEl ? lotEl.value.trim() : '';
        const hedef = hedefEl ? hedefEl.value.trim() : '';
        fireTuru = turEl.value; // "Normal" veya "Kesim Firesi"

        if (isNaN(miktar) || miktar <= 0) { alert("Geçerli bir miktar girin."); return; }
        
        if (miktar > stok.depolar[secilenDepo]) { 
            alert(`Yetersiz Stok!\n${secilenDepo} stoğu: ${stok.depolar[secilenDepo]} ${stok.birim}\nİstenen: ${miktar} ${stok.birim}`); 
            return; 
        }
        if (!detay) { alert("Açıklama yazmanız zorunludur."); return; }

        // Miktarları Güncelle
        stok.depolar[secilenDepo] -= miktar;
        stok.miktar = Object.values(stok.depolar).reduce((a, b) => a + b, 0);

        // --- AÇIKLAMA FORMATI ---
        if (fireTuru === 'Normal') {
            aciklama = `[ÇIKIŞ -> ${secilenDepo}] ${detay}`;
        } else {
            // Eğer Fire ise özel etiket ekle
            aciklama = `[🔥 ${fireTuru.toUpperCase()} -> ${secilenDepo}] ${detay}`;
        }

        if (hedef) aciklama += ` -> ${hedef}`;
        if (lotNo) aciklama += ` (Lot: ${lotNo})`;
    }

    // --- KAYIT ---
    if (!app.data.stokHareketleri) app.data.stokHareketleri = [];
    app.data.stokHareketleri.push({
        id: Date.now(),
        stokId: stok.id,
        urunAdi: stok.ad,
        birim: stok.birim,
        tip: tip,
        altTip: fireTuru, // YENİ: Veritabanına "altTip" olarak kaydediyoruz.
        depo: secilenDepo,
        miktar: miktar,
        kalanStok: stok.miktar,
        tarih: new Date().toISOString(),
        aciklama: aciklama,
        lotNo: lotNo,  
        uretimTarihi: uretimTarihi,
        skt: skt       
    });

    dataManager.save();
    actions.closeModal();
    renderer.stokListesi();
    
    if (typeof renderer.stokGecmisiListesi === 'function') {
        renderer.stokGecmisiListesi();
    }

    alert("İşlem başarıyla kaydedildi.");
};

// --- ORTAK KAYDETME FONKSİYONU (YENİLENMİŞ) ---

// 4. Olay Dinleyicileri (Manuel Tanımlama)
const stokForm = document.getElementById('stok-ekle-form');
if (stokForm) {
    // Klonlayarak eski dinleyicileri temizle (varsa)
    const newForm = stokForm.cloneNode(true);
    stokForm.parentNode.replaceChild(newForm, stokForm);
    newForm.addEventListener('submit', actions.stokKartEkle);
}

const stokAra = document.getElementById('stok-ara');
if (stokAra) stokAra.oninput = renderer.stokListesi;

// --- JS KISMI: Reçete Yönetim Sistemi ---

// 1. Veri Başlatma (App Loaded olduğunda çalışması için kontrol)

// 1. Reçete Verisini Başlat
if (!app.data.receteler) app.data.receteler = [];

// 2. Sekme Geçiş Fonksiyonunu Güncelle (Reçete sekmesini tanıması için)
renderer.switchStokTab = function(tab) {
    const tabListe = document.getElementById('tab-stok-liste');
    const tabGecmis = document.getElementById('tab-stok-gecmis');
    const tabRecete = document.getElementById('tab-stok-recete');

    const btnListe = document.getElementById('btn-tab-liste');
    const btnGecmis = document.getElementById('btn-tab-gecmis');
    const btnRecete = document.getElementById('btn-tab-recete');
    
    if (tabListe && tabGecmis && tabRecete) {
        tabListe.style.display = tab === 'liste' ? 'block' : 'none';
        tabGecmis.style.display = tab === 'gecmis' ? 'block' : 'none';
        tabRecete.style.display = tab === 'recete' ? 'block' : 'none';
        
        btnListe.className = tab === 'liste' ? 'btn btn-primary' : 'btn btn-secondary';
        btnGecmis.className = tab === 'gecmis' ? 'btn btn-primary' : 'btn btn-secondary';
        btnRecete.className = tab === 'recete' ? 'btn btn-primary' : 'btn btn-secondary';
        
        if (tab === 'liste') renderer.stokListesi();
        if (tab === 'gecmis') renderer.stokGecmisiListesi();
        if (tab === 'recete') renderer.receteListesi();
    }
};

// 3. Reçete Listeleme Fonksiyonu
renderer.receteListesi = function() {
    const container = document.getElementById('recete-listesi-container');
    if (!container) return;
    
    if (!app.data.receteler || app.data.receteler.length === 0) {
        container.innerHTML = '<p class="no-data-message">Henüz tanımlanmış bir reçete yok.</p>';
        return;
    }

    let html = '<div class="card-container" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">';
    app.data.receteler.forEach(recete => {
        let icerikHtml = '<ul style="font-size:13px; color:#555; padding-left:20px; margin-top:10px;">';
        recete.malzemeler.forEach(m => {
            const stokKart = app.data.stoklar.find(s => s.id == m.stokId);
            const stokAdi = stokKart ? stokKart.ad : 'Silinmiş Stok';
            const birim = stokKart ? stokKart.birim : '';
            icerikHtml += `<li>${stokAdi}: <strong>${m.miktar} ${birim}</strong></li>`;
        });
        icerikHtml += '</ul>';

        html += `
            <div class="card" style="border-left:5px solid #3498db; position:relative;">
                <button class="btn-sm-danger" style="position:absolute; top:10px; right:10px;" onclick="actions.receteSil(${recete.id})">Sil</button>
                <h3 style="color:#2c3e50; margin:0;">${recete.ad}</h3>
                <small style="color:#7f8c8d;">1 Adet Üretim İçin Gerekli:</small>
                ${icerikHtml}
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
};

// 4. Yeni Reçete Oluşturma Modalı
actions.yeniReceteModalAc = function() {
    let stokOptions = '<option value="" disabled selected>Hammadde Seçin...</option>';
    app.data.stoklar.sort((a,b) => a.ad.localeCompare(b.ad)).forEach(s => {
        stokOptions += `<option value="${s.id}">${s.ad} (${s.birim})</option>`;
    });

    const html = `
        <div class="input-group">
            <label>Reçete Adı (Ürün Adı)</label>
            <input type="text" id="recete-adi" placeholder="Örn: Tabldot Menü" required style="font-weight:bold;">
            <small style="color:red;">ÖNEMLİ: Bu isim 'Üretim Ekle' sayfasındaki ürün adı ile aynı olmalıdır!</small>
        </div>
        <hr>
        <label>Malzemeler</label>
        <div id="recete-malzemeler-container"></div>
        <button type="button" class="btn btn-sm-warning" onclick="actions.receteSatirEkle()" style="margin-bottom:15px;">+ Malzeme Ekle</button>
        <button type="button" class="btn btn-success btn-full" onclick="actions.receteKaydet()">Reçeteyi Kaydet</button>
    `;

    window.tempStokOptions = stokOptions;
    actions.openModal('Yeni Reçete Tanımla', html, true);
    setTimeout(actions.receteSatirEkle, 100);
};

actions.receteSatirEkle = function() {
    const container = document.getElementById('recete-malzemeler-container');
    if(!container) return;
    const div = document.createElement('div');
    div.className = 'form-grid';
    div.style.gridTemplateColumns = '2fr 1fr 50px';
    div.style.marginBottom = '10px';
    div.innerHTML = `<select class="recete-stok-select" style="padding:8px;">${window.tempStokOptions}</select><input type="number" class="recete-miktar" placeholder="Miktar" step="0.001" style="padding:8px;"><button type="button" class="btn-sm-danger" onclick="this.parentElement.remove()">X</button>`;
    container.appendChild(div);
};

actions.receteKaydet = function() {
    const ad = document.getElementById('recete-adi').value.trim();
    if (!ad) { alert("Reçete adı girin."); return; }
    const satirlar = document.querySelectorAll('#recete-malzemeler-container .form-grid');
    const malzemeler = [];
    satirlar.forEach(row => {
        const sid = row.querySelector('.recete-stok-select').value;
        const mik = row.querySelector('.recete-miktar').value;
        if (sid && mik > 0) malzemeler.push({ stokId: parseInt(sid), miktar: parseFloat(mik) });
    });
    if (malzemeler.length === 0) { alert("En az bir malzeme ekleyin."); return; }
    app.data.receteler.push({ id: Date.now(), ad: ad, malzemeler: malzemeler });
    dataManager.save();
    actions.closeModal();
    renderer.receteListesi();
    alert("Reçete başarıyla kaydedildi.");
};

actions.receteSil = function(id) {
    if(confirm('Reçeteyi silmek istediğinize emin misiniz?')) {
        app.data.receteler = app.data.receteler.filter(r => r.id !== id);
        dataManager.save();
        renderer.receteListesi();
    }
};

// --- JAVASCRIPT: REÇETE SİSTEMİ VE STOK DÜŞÜM MOTORU (DÜZELTİLMİŞ) ---

// 1. Veri Kontrolü
if (!app.data.receteler) app.data.receteler = [];

// 2. Ürün Seçim Listesini Doldur
renderer.uretimUrunListesiniDoldur = function() {
    const select = document.getElementById('uretim-urun-secimi');
    if (!select) return;
    
    // Listeyi oluştur
    const receteler = app.data.receteler || [];
    let options = `<option value="" disabled selected>Listeden Seçiniz...</option>`;
    
    receteler.forEach(r => {
        options += `<option value="${r.ad}">${r.ad}</option>`;
    });
    
    options += `<option value="manuel">-- Listede Yok (Elle Yaz) --</option>`;
    select.innerHTML = options;
};

// 3. Ürün Seçilince Çalışan Fonksiyon
actions.uretimUrunSecildi = function() {
    const select = document.getElementById('uretim-urun-secimi');
    const input = document.getElementById('uretim-aciklama');
    
    if (select.value === 'manuel') {
        input.style.display = 'block';
        input.value = '';
        input.focus();
    } else {
        input.style.display = 'none';
        input.value = select.value;
    }
};

// 4. Listeye Ekleme (Hata Korumalı)
actions.addUretimToList = function(e) { 
    if(e && e.preventDefault) e.preventDefault(); 
    const form = document.getElementById('uretim-ekle-form'); 
    
    let urunAdi = document.getElementById('uretim-aciklama').value.trim();
    if (!urunAdi) { alert("Lütfen listeden bir ürün seçin."); return; }

    const uretim = { 
        fabrikaId: parseInt(form.querySelector('#uretim-fabrika').value), 
        tarih: form.querySelector('#uretim-tarih').value, 
        aciklama: urunAdi, 
        adet: parseInt(form.querySelector('#uretim-adet').value), 
        birimFiyat: parseFloat(form.querySelector('#uretim-birim-fiyat').value),
        birimMaliyet: parseFloat(form.querySelector('#uretim-birim-maliyet').value) || 0,
        kdvOrani: parseFloat(form.querySelector('#uretim-kdv-orani').value) || 0
    }; 

    if (!uretim.fabrikaId || !uretim.tarih || !uretim.adet || isNaN(uretim.birimFiyat)) { 
        alert('Lütfen zorunlu alanları doldurun.'); return; 
    } 

    // LİSTE KONTROLÜ (ÇİFT EKLEMEYİ ENGELLER)
    // Eğer kullanıcı yanlışlıkla çift tıkladıysa aynı milisaniyede eklemeyi önle
    const sonEklenen = app.temp.uretimListesi[app.temp.uretimListesi.length - 1];
    if (sonEklenen && sonEklenen.aciklama === uretim.aciklama && sonEklenen.adet === uretim.adet && sonEklenen.tarih === uretim.tarih) {
         // Son 1 saniye içinde eklendiyse durdur
         if(Date.now() - (sonEklenen._ts || 0) < 1000) return;
    }
    uretim._ts = Date.now(); // Zaman damgası ekle

    app.temp.uretimListesi.push(uretim); 
    renderer.uretimEkleListesi(); 

    // Formu temizle
    document.getElementById('uretim-urun-secimi').value = "";
    document.getElementById('uretim-aciklama').value = "";
    form.querySelector('#uretim-adet').value = ''; 
    form.querySelector('#uretim-birim-fiyat').value = ''; 
    form.querySelector('#uretim-birim-maliyet').value = ''; 
    form.querySelector('#uretim-toplam-tutar').value = ''; 
};

// 5. Stok Düşüm Motoru (Tek Seferlik Garanti)
actions.otomatikStokDus = function(uretimItem) {
    const recete = (app.data.receteler || []).find(r => r.ad.trim() === uretimItem.aciklama.trim());
    if (!recete) return 0;

    let islenenMalzeme = 0;
    recete.malzemeler.forEach(malzeme => {
        const stokKart = app.data.stoklar.find(s => s.id === malzeme.stokId);
        if (stokKart) {
            if (!stokKart.depolar) stokKart.depolar = { "Ana Depo": parseFloat(stokKart.miktar) || 0 };
            if (stokKart.depolar["Ana Depo"] === undefined) stokKart.depolar["Ana Depo"] = 0;

            const dusulecekMiktar = uretimItem.adet * malzeme.miktar;
            
            // Stoktan Düş
            stokKart.depolar["Ana Depo"] -= dusulecekMiktar;
            
            // Ana Miktarı Güncelle
            stokKart.miktar = Object.values(stokKart.depolar).reduce((a, b) => a + b, 0);

            // Hareket Kaydı
            if (!app.data.stokHareketleri) app.data.stokHareketleri = [];
            app.data.stokHareketleri.push({
                id: Date.now() + Math.random(),
                stokId: stokKart.id,
                urunAdi: stokKart.ad,
                birim: stokKart.birim,
                tip: 'cikis',
                altTip: 'Uretim',
                depo: 'Ana Depo',
                miktar: dusulecekMiktar,
                kalanStok: stokKart.miktar,
                tarih: new Date().toISOString(),
                aciklama: `[OTOMATİK] ${uretimItem.adet} adet "${uretimItem.aciklama}" üretimi.`
            });
            islenenMalzeme++;
        }
    });
    return islenenMalzeme;
};

// 6. Kaydetme Fonksiyonu
actions.saveUretimListesi = function() {
    const list = app.temp.uretimListesi;
    if (list.length === 0) { alert('Kaydedilecek kalem yok.'); return; }

    // Çift tıklama koruması
    const btn = document.getElementById('tumunu-kaydet-btn');
    if(btn) btn.disabled = true;

    if (confirm(`${list.length} kalem üretimi kaydetmek istiyor musunuz?`)) {
        let toplamDusum = 0;
        
        list.forEach((item, index) => {
            // Sadece ID ekleyip kaydediyoruz
            app.data.uretimler.push({ ...item, id: Date.now() + index });
            
            // Stok düşümü
            toplamDusum += actions.otomatikStokDus(item);
            
            // Maliyet Kaydı
            if (item.birimMaliyet > 0) {
                app.data.giderler.push({
                    id: Date.now() + index + 5000,
                    tip: 'diger',
                    aciklama: `[MALİYET] ${item.aciklama}`,
                    detay: `Üretim Maliyeti`,
                    tutar: item.adet * item.birimMaliyet,
                    tarih: item.tarih
                });
            }
        });

        dataManager.save();
        app.temp.uretimListesi = []; // Listeyi boşalt
        renderer.updateAll();
        alert(`✅ Üretim Kaydedildi!\n📦 Stoktan düşülen kalem sayısı: ${toplamDusum}`);
    }
    
    if(btn) btn.disabled = false;
};

// --- KRİTİK DÜZELTME: BUTONLARI FORMATLA VE YENİDEN BAĞLA ---
// Bu fonksiyon eski takılı kalmış butonları siler ve tertemiz butonlar koyar.
function butonlariTamirEt() {
    const ids = ['listeye-ekle-btn', 'tumunu-kaydet-btn', 'listeyi-temizle-btn'];
    
    ids.forEach(id => {
        const eskiBtn = document.getElementById(id);
        if (eskiBtn) {
            // Butonu kopyala (Clone), bu işlem üzerindeki tüm eski eventleri siler
            const yeniBtn = eskiBtn.cloneNode(true);
            eskiBtn.parentNode.replaceChild(yeniBtn, eskiBtn);
        }
    });

    // Eventleri tekrar ve tek seferlik ekle
    const btnEkle = document.getElementById('listeye-ekle-btn');
    if(btnEkle) btnEkle.onclick = actions.addUretimToList; // addEventListener yerine onclick daha güvenli

    const btnKaydet = document.getElementById('tumunu-kaydet-btn');
    if(btnKaydet) btnKaydet.onclick = actions.saveUretimListesi;

    const btnTemizle = document.getElementById('listeyi-temizle-btn');
    if(btnTemizle) btnTemizle.onclick = actions.clearUretimListesi;
}

// Tamiri hemen çalıştır
butonlariTamirEt();

// Sayfa geçişlerinde listeyi doldur
const _oldNavigate = actions.navigate;
actions.navigate = function(e, page) {
    if(_oldNavigate) _oldNavigate(e, page);
    const p = page || (e ? e.currentTarget.dataset.page : null);
    if (p === 'uretim-ekle') {
        renderer.uretimUrunListesiniDoldur();
        butonlariTamirEt(); // Sayfa değişince de butonları sağlama al
    }
};

// Reçete Sekme Geçişi
renderer.switchStokTab = function(tab) {
    document.getElementById('tab-stok-liste').style.display = tab === 'liste' ? 'block' : 'none';
    document.getElementById('tab-stok-gecmis').style.display = tab === 'gecmis' ? 'block' : 'none';
    document.getElementById('tab-stok-recete').style.display = tab === 'recete' ? 'block' : 'none';
    
    if (tab === 'liste') renderer.stokListesi();
    if (tab === 'gecmis') renderer.stokGecmisiListesi();
    if (tab === 'recete') renderer.receteListesi();
};

// 5. OTOMATİK STOK DÜŞÜM MOTORU (EKSİK OLAN PARÇA BU!)

// 6. ÜRETİM KAYDETME FONKSİYONUNU GÜNCELLE (Düşüm motorunu tetikleyecek şekilde)

// 2. Ana Fonksiyon: Üretim Listesini Kaydederken Düşümü Tetikler


// 2. MEVCUT FONKSİYONU GÜNCELLE: Üretim Listesini Kaydetme
// (Eski actions.saveUretimListesi fonksiyonunu silip yerine bunu yapıştırın)
// --- YENİ SİSTEM: REÇETE BAZLI ÜRETİM VE STOK DÜŞÜM ---

// 1. Ürün Seçim Listesini Doldurma Fonksiyonu

// --- KESİN ÇÖZÜM: REÇETE SİSTEMİ VE BUTON TEMİZLİĞİ ---

// 1. Ürün Seçim Listesini Doldur


// Sayfa Geçişlerinde Listeyi Doldurması İçin


// Sayfa yenilendiğinde listeyi yükle
setTimeout(renderer.stokListesi, 1000);
window.renderer = renderer;
window.actions = actions;
window.dataManager = dataManager;
// ------------------------------------------------------------------
    
    // UYGULAMAYI BAŞLAT
    main.boot();
    // Mobil menü için toggle butonu: sidebar'ı aç/kapat
    const sidebarToggleBtn = document.getElementById('sidebar-toggle');
    if (sidebarToggleBtn) {
        sidebarToggleBtn.addEventListener('click', () => {
            const sidebarEl = document.getElementById('sidebar');
            if (sidebarEl) {
                sidebarEl.classList.toggle('active');
            }
        });
    }

});

// --- STOK SİSTEMİ TAMİR VE SİLME MODÜLÜ ---
    
    // 1. Sistem Bağlantılarını Garantiye Al (Hata Çözümü)
    window.app = app;
    window.renderer = renderer;
    window.actions = actions;
    window.dataManager = dataManager;

    
// JAVASCRIPT KODLARI BİTİŞ
</script>

</body>
</html>
